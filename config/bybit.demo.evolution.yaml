system:
  id: "bot-bybit-demo-evolution"
  mode: "paper"
  primary_symbol: "BTCUSDT"
  data_path: "./data/demo_evolution"
  max_ticks: 0
  status_log_interval_ticks: 20
  remote_risk_refresh_interval_ticks: 10
  reconcile:
    enabled: true
    interval_ticks: 10
    tolerance_notional_usd: 8.0
    mismatch_confirmations: 4
    pending_order_stale_ms: 15000
    anomaly_reduce_only_streak: 3
    anomaly_halt_streak: 6
    anomaly_resume_streak: 3

exchange:
  platform: "bybit"
  bybit:
    testnet: false
    demo_trading: true
    category: "linear"
    account_type: "UNIFIED"
    expected_account_mode: "UNIFIED"
    expected_margin_mode: "ISOLATED"
    expected_position_mode: "ONE_WAY"
    public_ws_enabled: true
    public_ws_rest_fallback: true
    private_ws_enabled: true
    private_ws_rest_fallback: true
    ws_reconnect_interval_ms: 15000
    execution_poll_limit: 50

risk:
  max_abs_notional_usd: 1800
  max_drawdown:
    degraded_threshold: 0.08
    degraded_recover_threshold: 0.06
    cooldown_threshold: 0.12
    cooldown_recover_threshold: 0.10
    fuse_threshold: 0.20
    fuse_recover_threshold: 0.16

execution:
  max_order_notional: 380
  min_rebalance_notional_usd: 80
  include_inflight_notional_in_position: true
  max_inflight_orders_per_symbol_direction: 2
  min_order_interval_ms: 4500
  reverse_signal_cooldown_ticks: 14
  enable_fee_aware_entry_gate: true
  entry_fee_bps: 5.5
  exit_fee_bps: 5.5
  expected_slippage_bps: 1.0
  min_expected_edge_bps: 1.3
  # 稳态阶段：提高入场边际门槛上限，优先压低低质量成交。
  required_edge_cap_bps: 5.8
  entry_gate_near_miss_tolerance_bps: 0.20
  # 允许 near-miss 样本走 maker 放行，提升样本流量（仅 demo）。
  entry_gate_near_miss_maker_allow: true
  # 语义：在 tolerance 之上的附加 gap（不是绝对 gap）。
  entry_gate_near_miss_maker_max_gap_bps: 0.35
  adaptive_fee_gate_enabled: true
  adaptive_fee_gate_min_samples: 80
  adaptive_fee_gate_trigger_ratio: 0.70
  adaptive_fee_gate_max_relax_bps: 1.1
  dynamic_edge_enabled: true
  dynamic_edge_regime_trend_relax_bps: 0.6
  dynamic_edge_regime_range_penalty_bps: 0.25
  dynamic_edge_regime_extreme_penalty_bps: 1.1
  dynamic_edge_volatility_relax_bps: 0.4
  dynamic_edge_volatility_penalty_bps: 1.0
  dynamic_edge_liquidity_maker_ratio_threshold: 0.65
  dynamic_edge_liquidity_unknown_ratio_threshold: 0.20
  dynamic_edge_liquidity_relax_bps: 0.2
  dynamic_edge_liquidity_penalty_bps: 1.0
  maker_entry_enabled: true
  maker_fallback_to_market: false
  maker_price_offset_bps: 0.3
  maker_post_only: true
  maker_edge_relax_bps: 0.15
  cost_filter_cooldown_trigger_count: 12
  cost_filter_cooldown_ticks: 80
  quality_guard_enabled: true
  quality_guard_min_fills: 4
  quality_guard_bad_streak_to_trigger: 2
  quality_guard_good_streak_to_release: 4
  quality_guard_min_realized_net_per_fill_usd: -0.004
  quality_guard_max_fee_bps_per_fill: 0.20
  quality_guard_required_edge_penalty_bps: 2.4
  protection:
    enabled: false
    require_sl: true
    enable_tp: true
    attach_timeout_ms: 1500
    stop_loss_ratio: 0.01
    take_profit_ratio: 0.015

strategy:
  signal_notional_usd: 380
  signal_deadband_abs: 0.9
  min_hold_ticks: 6
  vol_target_pct: 0.35
  vol_target_max_leverage: 2.2
  vol_target_low_vol_leverage_cap_enabled: true
  vol_target_low_vol_annual_threshold: 0.12
  vol_target_low_vol_max_leverage: 1.1
  defensive_notional_ratio: 0.55
  defensive_entry_score: 2.0
  defensive_trend_scale: 0.25
  defensive_range_scale: 1.00
  defensive_extreme_scale: 0.45

integrator:
  enabled: true
  model_type: "catboost"
  mode: "shadow"                    # off/shadow/canary/active
  canary_notional_ratio: 0.30       # canary模式接管比例（相对原策略绝对名义值）
  canary_min_notional_usd: 50       # canary最小经济名义金额，低于该值直接抹零
  canary_confidence_threshold: 0.60 # canary最低置信阈值(|p_up-p_down|)
  canary_allow_countertrend: false  # canary是否允许与原策略反向
  active_confidence_threshold: 0.55 # active最低置信阈值，低于阈值转空仓
  active_partial_notional_ratio: 0.5 # active部分接管时的名义值比例
  active_full_notional_confidence_threshold: 0.80 # active全量接管阈值
  shadow:
    enabled: true
    log_model_score: true
    model_report_path: "./data/research/integrator_report.json"
    score_gain: 1.0
    # 降低门槛以适应当前模型表现 (Report: 0.0104)
    min_delta_auc_vs_baseline: 0.01

self_evolution:
  enabled: true
  # 降噪窗口：以 5h 级别评估，降低短窗过拟合。
  update_interval_ticks: 3600
  min_update_interval_ticks: 3600
  min_abs_window_pnl_usd: 5.0
  # 单个 Regime bucket 在窗口内样本 tick 不足时，不执行该 bucket 的学习更新。
  min_bucket_ticks_for_update: 600
  min_consecutive_direction_windows: 3
  # P0/P1：使用虚拟PnL + 反事实搜索，让零成交阶段也可学习。
  use_virtual_pnl: true
  use_counterfactual_search: true
  counterfactual_fallback_to_factor_ic: true
  counterfactual_min_improvement_usd: 2.0
  # 维持与绝对阈值同量级，避免高权益账户被比例阈值“卡死”。
  counterfactual_min_improvement_ratio_of_equity: 0.00002
  counterfactual_improvement_decay_per_filtered_signal_usd: 0.04
  counterfactual_min_fill_count_for_update: 1
  counterfactual_min_t_stat_samples_for_update: 60
  counterfactual_min_t_stat_abs_for_update: 0.25
  counterfactual_superiority_min_samples_for_update: 120
  counterfactual_superiority_min_t_stat_for_update: 0.35
  virtual_cost_bps: 6.5
  virtual_cost_dynamic_enabled: true
  virtual_cost_dynamic_max_multiplier: 3.0
  virtual_funding_rate_per_tick: 0.0
  # P2(3+6)：在线因子IC自适应 + 可学习性门控。
  enable_factor_ic_adaptive_weights: true
  factor_ic_min_samples: 80
  factor_ic_min_abs: 0.005
  enable_learnability_gate: true
  learnability_min_samples: 80
  learnability_min_t_stat_abs: 0.7
  # 风险调整目标函数（Sharpe-like 主项 + 回撤/换手惩罚）
  objective_alpha_pnl: 1.0
  objective_beta_drawdown: 0.3
  objective_gamma_notional_churn: 0.005
  objective_use_sharpe_like: true
  max_single_strategy_weight: 0.55
  max_weight_step: 0.02
  rollback_degrade_windows: 5
  rollback_degrade_threshold_score: 0.0
  rollback_to_baseline_on_trigger: true
  rollback_cooldown_ticks: 3600
  initial_trend_weight: 0.50
  initial_defensive_weight: 0.50

regime:
  enabled: true
  warmup_ticks: 30
  ewma_alpha: 0.05
  switch_confirm_ticks: 12
  trend_threshold: 0.0015
  extreme_threshold: 0.0080
  volatility_threshold: 0.0025

gate:
  # 放宽活跃度要求，避免因行情平淡导致长期 reduce-only。
  min_effective_signals_per_day: 3
  min_fills_per_day: 0
  heartbeat_empty_signal_ticks: 24
  window_ticks: 288
  enforce_runtime_actions: true
  fail_to_reduce_only_windows: 3
  fail_to_halt_windows: 4
  reduce_only_cooldown_ticks: 120
  halt_cooldown_ticks: 240
  pass_to_resume_windows: 2

universe:
  enabled: true
  update_interval_ticks: 20
  max_active_symbols: 2
  min_active_symbols: 1
  fallback_symbols: ["BTCUSDT", "ETHUSDT"]
  candidate_symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"]
