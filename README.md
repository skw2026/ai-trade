# AIäº¤æ˜“æœºå™¨äºº

> **æ ¸å¿ƒç›®æ ‡**ï¼šæ„å»ºä¸€å¥—é¢å‘ BTC/ETH/SOL æ°¸ç»­åˆçº¦çš„ C++ é«˜é¢‘/ä¸­é¢‘äº¤æ˜“ç³»ç»Ÿã€‚
>
> **äº¤æ˜“æ‰€ä¼˜å…ˆçº§**ï¼šBybit V5ï¼ˆåç»­å¯æ‰©å±• Binanceï¼‰ã€‚
>
> **è®¾è®¡å“²å­¦**ï¼šç”Ÿå­˜ä¼˜å…ˆ > é£é™©å¯æ§ > å¯éªŒè¯æ­£æœŸæœ›ã€‚ä¸æ‰¿è¯ºâ€œç¨³å®šæ”¶ç›Šâ€ï¼Œä½†å¼ºè°ƒâ€œå¯å›æ»šã€å¯å®¡è®¡ã€ç¡¬é£æ§â€ã€‚

---

## éœ€æ±‚ç¬¦åˆæ€§æ ¸å¯¹è¡¨

| ç”¨æˆ·æ ¸å¿ƒè¦æ±‚                 | æ–‡æ¡£è½ç‚¹                              | è¦†ç›–æƒ…å†µ  |
| ---------------------- | --------------------------------- | ----- |
| æ ‡çš„ï¼šBTC/ETH/SOLï¼ˆä¸»æµå¸ï¼‰    | é¦–é¡µé¡¹ç›®ç›®æ ‡ã€PRDèŒƒå›´ã€é»˜è®¤å‚æ•°                 | âœ… å·²è¦†ç›– |
| äº¤æ˜“å“ç±»ï¼šæ°¸ç»­åˆçº¦              | é¡¹ç›®ç›®æ ‡ã€PRDèŒƒå›´ã€æ¨¡å—è®¾è®¡ï¼ˆåˆçº¦è§„åˆ™/èµ„é‡‘è´¹ç‡/æ ‡è®°ä»·ï¼‰    | âœ… å·²è¦†ç›– |
| é£é™©å¯æ§ã€é¿å…çˆ†ä»“/æ¸…é›¶           | é£æ§ç¡¬è§„åˆ™ï¼šé€ä»“ã€æ æ†ç™½åå•ã€å¼ºå¹³è·ç¦»é˜ˆå€¼ã€å›æ’¤ä¸‰é˜ˆå€¼ã€æ–­è¿åªå‡ä»“ | âœ… å·²è¦†ç›– |
| æœ€å¤§å›æ’¤ç›®æ ‡ï¼š20%ï¼ˆä¸­ç­‰é£é™©ï¼‰       | PRD KRIã€é»˜è®¤å‚æ•°é™„å½•ã€é£æ§è®¾è®¡               | âœ… å·²è¦†ç›– |
| ä¸æ‰¿è¯ºç¨³å®šæ”¶ç›Šï¼Œä½†å¼ºè°ƒå¯éªŒè¯æ­£æœŸæœ›      | é¡¹ç›®ç›®æ ‡ã€KPI/KRI                      | âœ… å·²è¦†ç›– |
| è‡ªè¿›åŒ–ï¼ˆå¯æ§èŒƒå›´ï¼šç­–ç•¥æƒé‡/å‚æ•°ï¼‰      | äº§å“ç›®æ ‡ã€KRIè‡ªè¿›åŒ–éªŒæ”¶ã€SDD Bandit/Regime   | âœ… å·²è¦†ç›– |
| æ™ºèƒ½/AIç­›é€‰å¸å¯¹ï¼ˆå¤šå¸ç§æ‰©å±•ï¼‰       | PRDèŒƒå›´ã€SADæ¨¡å—è®¾è®¡ã€TRDæ¥å£è®¾è®¡             | âœ… å·²è¦†ç›– |
| é—¸é—¨ä¸å›æ»šï¼ˆå›æµ‹â†’çº¸äº¤æ˜“â†’å°å®ç›˜ã€è‡ªåŠ¨å›æ»šï¼‰ | PRD 1.3.5/1.5ã€SDD 3.10ã€å·¥ç¨‹éªŒæ”¶ç”¨ä¾‹     | âœ… å·²è¦†ç›– |
| è¯­è¨€åå¥½ï¼šC++               | SDD æŠ€æœ¯æ ˆã€çº¿ç¨‹æ¨¡å‹ã€Repoç»“æ„               | âœ… å·²è¦†ç›– |
| å¯è½åœ°å¯éªŒæ”¶ï¼ˆå«å·¥ç¨‹éªŒæ”¶ï¼‰          | PRD KPI/KRI + å·¥ç¨‹éªŒæ”¶ + æŒ‡æ ‡è§„èŒƒ + ç”¨ä¾‹æ¨¡æ¿  | âœ… å·²è¦†ç›– |

---

## ğŸ“š æ–‡æ¡£å¯¼èˆª

### 1. æ ¸å¿ƒè®¾è®¡
- **[éœ€æ±‚ä¸éªŒæ”¶æ ‡å‡† (PRD)](docs/éœ€æ±‚æè¿°.md)**: è¯¦ç»†çš„é¡¹ç›®ç›®æ ‡ã€KRI/KPI æŒ‡æ ‡åŠéªŒæ”¶æ ‡å‡†ã€‚
- **[ç³»ç»Ÿæ¶æ„è®¾è®¡ (SAD)](docs/æ¶æ„è®¾è®¡.md)**: ç³»ç»Ÿå·¥ä½œåŸç†ã€æ ¸å¿ƒç»„ä»¶ã€æ¶æ„è§†å›¾ã€æŠ€æœ¯é€‰å‹ä¸å¯é æ€§è®¾è®¡ã€‚
- **[ç³»ç»Ÿè¯¦ç»†è®¾è®¡ (TRD)](docs/è¯¦ç»†è®¾è®¡.md)**: æ¨¡å—æ¥å£ã€çŠ¶æ€æœºã€çº¿ç¨‹æ¨¡å‹ã€å­˜å‚¨ä¸€è‡´æ€§ä¸æµ‹è¯•æ–¹æ¡ˆã€‚
- **[æ•°æ®ä¸äº‹ä»¶è§„èŒƒ (Specs)](docs/è§„èŒƒçº¦æŸ.md)**: æ ¸å¿ƒäº‹ä»¶å­—æ®µå®šä¹‰ã€å¹‚ç­‰æ€§è®¾è®¡ä¸ C++ ç»“æ„å‚è€ƒã€‚

### 2. ç­–ç•¥ä¸é£æ§
- **[äº¤æ˜“ç­–ç•¥ (Strategy)](docs/äº¤æ˜“ç­–ç•¥.md)**: Trend/MeanRev/VolTarget ç­–ç•¥é€»è¾‘ã€Regime è¯†åˆ«ä¸ Bandit è‡ªè¿›åŒ–ã€‚
- **[é£é™©æ§åˆ¶ä¸æ‰§è¡Œ (Risk & Execution)](docs/é£é™©æ§åˆ¶.md)**: **(æ ¸å¿ƒ)** ç¡¬é£æ§çŠ¶æ€æœºã€ç†”æ–­æœºåˆ¶ã€OMS é€»è¾‘ä¸ Gate æµç¨‹ã€‚

### 3. å·¥ç¨‹è½åœ°
- **[å¼€å‘æŒ‡å— (Developer)](docs/å¼€å‘æŒ‡å—.md)**: ç¯å¢ƒæ­å»ºã€ç¼–è¯‘æ„å»ºã€æ¨¡æ‹Ÿå™¨è¿è¡ŒæŒ‡å—ã€‚
- **[é…ç½®æ‰‹å†Œ (Configuration)](docs/é…ç½®æ‰‹å†Œ.md)**: ç³»ç»Ÿé…ç½®æ¨¡æ¿ã€é£æ§å‚æ•°ç¡¬çº¦æŸè¯´æ˜ã€‚
- **[å®ç°éªŒæ”¶æ£€æŸ¥æ¸…å•](docs/éªŒæ”¶æ¸…å•.md)**: P0 è®¾è®¡ä¿®å¤é¡¹ä¸é—­ç¯ä¿éšœçš„å¼€å‘/æµ‹è¯•æ‰“å‹¾æ¸…å•ã€‚
- **[AI è‡ªé—­ç¯å®ç°è·¯å¾„](docs/å®ç°è·¯å¾„.md)**: å…ˆè·‘é€šé—­ç¯ã€å†åŸºäºæŠ¥å‘Šä¼˜åŒ–çš„æ‰§è¡Œè·¯çº¿å›¾ã€‚
- **[å…¨å·¥ç¨‹é‡æ„è“å›¾](docs/é‡æ„è“å›¾.md)**: å‰ç»æ€§é‡æ„è·¯çº¿ã€ç›®æ ‡æ¶æ„ä¸é˜¶æ®µè®¡åˆ’ã€‚

---

## ğŸ›¡ï¸ å…³é”®å·¥ç¨‹åŸåˆ™ (Must Follow)

### ç¡¬è¾¹ç•Œï¼ˆä¸å¯å­¦ä¹ ã€ä¸å¯è¶Šæƒï¼‰
- é€ä»“å¼ºåˆ¶ï¼ˆIsolated onlyï¼‰
- æ æ†ç™½åå•ï¼šBTC/ETH â‰¤ 3xï¼›SOL â‰¤ 2xï¼›event_window/EXTREME â†’ 1x
- å›æ’¤ä¸‰é˜ˆå€¼ï¼ˆè´¦æˆ·çº§ï¼‰ï¼š8%é™æ¡£ / 12%å¼ºå‡ä»“+å†·å´ / 20%ç†”æ–­ï¼ˆç»æµæ„ä¹‰å…¨å¹³ï¼‰+å†·å´+åˆ†æ®µæ¢å¤
- å¼ºå¹³è·ç¦»ï¼ˆåŠ æƒP95ï¼‰ï¼š<8% å¼ºåˆ¶å‡ä»“ï¼›ç›®æ ‡æ¢å¤â‰¥10%

### è‡ªè¿›åŒ–èŒƒå›´ï¼ˆå¯æ§ï¼‰
- å…è®¸è¿›åŒ–ï¼šç­–ç•¥æƒé‡ã€ç­–ç•¥å‚æ•°ï¼ˆå¦‚ Trend/MeanRev/VolTarget å‚æ•°ï¼‰
- ä¸å…è®¸è¿›åŒ–ï¼šç¡¬é£æ§é˜ˆå€¼ä¸ç¡¬è§„åˆ™
- Gate å¿…é¡»æ»¡è¶³æœ€å°æ´»è·ƒåº¦ï¼ˆä¿¡å·ä¸æˆäº¤é—¨æ§›ï¼‰ï¼Œé˜²æ­¢â€œé›¶äº¤æ˜“é€šè¿‡â€
- æ‰€æœ‰è¿›åŒ–å¿…é¡»èµ° Gateï¼šå›æ”¾å›å½’ â†’ æ¨¡æ‹Ÿç›˜æ’®åˆå›å½’ â†’ Shadow â†’ï¼ˆå¯é€‰ï¼‰å°å®ç›˜

## ğŸš€ å¿«é€Ÿå¼€å§‹

è¯·å‚è€ƒ [docs/å¼€å‘æŒ‡å—.md](docs/å¼€å‘æŒ‡å—.md) è¿›è¡Œç¯å¢ƒé…ç½®ä¸æ„å»ºã€‚

### é¡¹ç›®ç»“æ„æ¦‚è§ˆ
```text
ai-trade/
â”œâ”€â”€ CMakeLists.txt       # CMake æ„å»ºå…¥å£
â”œâ”€â”€ Makefile             # ç»Ÿä¸€å·¥ç¨‹å‘½ä»¤å…¥å£ï¼ˆqa/build/testï¼‰
â”œâ”€â”€ apps/
â”‚   â””â”€â”€ ai_trade_web/    # æ§åˆ¶å¹³é¢æœåŠ¡ï¼ˆphase-1 åªè¯»ï¼‰
â”œâ”€â”€ build/               # æ„å»ºäº§ç‰©ç›®å½• (cmake build)
â”œâ”€â”€ config/              # é…ç½®æ–‡ä»¶ (yaml)
â”œâ”€â”€ data/                # æœ¬åœ°å›æµ‹æ•°æ®/ç¼“å­˜
â”œâ”€â”€ docs/                # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ core/            # åŸºç¡€ç±»å‹ä¸æ—¥å¿—
â”‚   â”œâ”€â”€ market/          # è¡Œæƒ…è¾“å…¥
â”‚   â”œâ”€â”€ universe/        # æ™ºèƒ½/AIç­›å¸ï¼ˆæœ€å°å¯è¿è¡Œå®ç°ï¼‰
â”‚   â”œâ”€â”€ strategy/        # ç­–ç•¥å¼•æ“
â”‚   â”œâ”€â”€ risk/            # é£æ§å¼•æ“
â”‚   â”œâ”€â”€ execution/       # æ‰§è¡Œå¼•æ“
â”‚   â”œâ”€â”€ oms/             # è´¦æˆ·çŠ¶æ€/è®¢å•å¤„ç†
â”‚   â”œâ”€â”€ monitor/         # Gate/æ´»è·ƒåº¦/é—­ç¯ç›‘æ§
â”‚   â””â”€â”€ system/          # äº¤æ˜“ç³»ç»Ÿç¼–æ’
â”œâ”€â”€ tests/               # åŸºç¡€é›†æˆæµ‹è¯• (CTest)
â””â”€â”€ tools/               # æ¨¡æ‹Ÿå™¨ã€å›æ”¾å·¥å…·
```

### æœ¬åœ°è¿è¡Œéª¨æ¶
```bash
cmake -S . -B build
cmake --build build -j 8
./build/trade_bot
ctest --test-dir build --output-on-failure
```

### å·¥ç¨‹è´¨é‡é—¨ç¦ï¼ˆæ¨èï¼‰
```bash
# ä¸€é”®æ‰§è¡Œï¼šç¼–è¯‘ + æµ‹è¯• + compose é…ç½®æ ¡éªŒ + æŠ¥å‘Šå¥‘çº¦æ ¡éªŒ
make qa

# æˆ–ç›´æ¥æ‰§è¡Œè„šæœ¬
tools/quality_gate.sh
```

### Docker è¿è¡Œï¼ˆæ¨èç»Ÿä¸€ç¼–è¯‘ç¯å¢ƒï¼‰
```bash
# æ„å»ºé•œåƒï¼ˆæ„å»ºé˜¶æ®µä¼šè‡ªåŠ¨æ‰§è¡Œ ctestï¼‰
docker build -t ai-trade:latest .

# å›æ”¾æ¨¡å¼
docker run --rm \
  -v "$(pwd)/config:/app/config:ro" \
  -v "$(pwd)/data:/app/data" \
  ai-trade:latest --config=config/bybit.replay.yaml --exchange=bybit
```

ä½¿ç”¨ `docker compose`ï¼š
```bash
# é¦–æ¬¡è¯·å…ˆå‡†å¤‡ .envï¼ˆAK/SK æ³¨å…¥ï¼‰
cp .env.example .env
# ç¼–è¾‘ .envï¼Œå¡«å…¥å¯¹åº”ç¯å¢ƒçš„ Bybit AK/SK

docker compose up --build ai-trade
```

`ai-trade-web` æ§åˆ¶å¹³é¢ï¼ˆphase-Cï¼‰ï¼š
```bash
# æœ¬åœ°å¯åŠ¨æ§åˆ¶å¹³é¢ APIï¼ˆè¯»å– reports/models/configï¼‰
docker compose --profile web up --build ai-trade-web
# é»˜è®¤è®¿é—®: http://localhost:8080/docs
```

å¼€å¯ phase-C æ²»ç†å†™å…¥èƒ½åŠ›ï¼ˆè°¨æ…ï¼‰ï¼š
```bash
export AI_TRADE_WEB_ENABLE_WRITE=true
export AI_TRADE_WEB_ADMIN_TOKEN=CHANGE_ME_STRONG_TOKEN
docker compose --profile web up -d ai-trade-web
```

è¯´æ˜ï¼š
- å†™å…¥æ¥å£éœ€è¦è¯·æ±‚å¤´ `X-Admin-Token` ä¸ç¯å¢ƒå˜é‡ä»¤ç‰Œä¸€è‡´ã€‚
- é»˜è®¤å‘å¸ƒä¿æŠ¤ä¼šæ ¡éªŒ latest æŠ¥å‘Šä¸º `PASS` æ‰å…è®¸å‘å¸ƒé…ç½®ã€‚
- é«˜é£é™©å‘å¸ƒé»˜è®¤å¯ç”¨åŒäººå®¡æ‰¹ä¸å†·å´ï¼š
  - `AI_TRADE_WEB_HIGH_RISK_TWO_MAN_RULE=true`
  - `AI_TRADE_WEB_HIGH_RISK_REQUIRED_APPROVALS=2`
  - `AI_TRADE_WEB_HIGH_RISK_COOLDOWN_SECONDS=180`
- å‘å¸ƒæµç¨‹ï¼š`Preview -> Approve -> è¾“å…¥ confirm phrase -> Publish`ã€‚
- é—­ç¯äº§ç‰©å›æ”¶é»˜è®¤æŒ‰ 3 å¤©çª—å£å›æ”¶ï¼ˆ`CLOSED_LOOP_GC_MAX_AGE_HOURS=72`ï¼‰ï¼Œå¹¶å åŠ æ•°é‡ä¸Šé™ï¼š
  - `CLOSED_LOOP_GC_KEEP_RUN_DIRS`
  - `CLOSED_LOOP_GC_KEEP_DAILY_FILES`
  - `CLOSED_LOOP_GC_KEEP_WEEKLY_FILES`
  - `CLOSED_LOOP_GC_MAX_AGE_HOURS`
  - `CLOSED_LOOP_GC_LOG_FILE` / `CLOSED_LOOP_GC_LOG_MAX_BYTES` / `CLOSED_LOOP_GC_LOG_KEEP_BYTES`
- scheduler æ¯è½®é—­ç¯åä¼šæ‰§è¡Œ Docker å±‚åƒåœ¾å›æ”¶ï¼ˆæ§åˆ¶ `/var/lib/containerd` å¢é•¿ï¼‰ï¼š
  - `DOCKER_GC_ENABLED`
  - `DOCKER_GC_UNTIL`ï¼ˆé»˜è®¤ `72h`ï¼Œå³ä»…ä¿ç•™æœ€è¿‘ 3 å¤©ï¼‰
  - `DOCKER_GC_PRUNE_IMAGES` / `DOCKER_GC_PRUNE_BUILD_CACHE`
  - é»˜è®¤ä¸æ¸…ç† volumeï¼ˆ`DOCKER_GC_PRUNE_VOLUMES=false`ï¼‰

å¯è§‚æµ‹æ€§ï¼ˆPrometheus + Grafana + Loki + Promtailï¼‰ï¼š
```bash
# å¯åŠ¨ç›‘æ§æ ˆï¼ˆobs profileï¼‰
docker compose --profile obs up -d loki promtail prometheus grafana

# æŸ¥çœ‹çŠ¶æ€
docker compose ps
```

é»˜è®¤è®¿é—®ï¼š
- Grafana: `http://<host>:3000`ï¼ˆé»˜è®¤è´¦å·å¯†ç è§ `.env` ä¸­ `GRAFANA_ADMIN_USER/PASSWORD`ï¼‰
- Prometheus: `http://<host>:9090`
- Loki: `http://<host>:3100`

å®‰å…¨é»˜è®¤å€¼ï¼ˆç”Ÿäº§å»ºè®®ï¼‰ï¼š
- ç›‘æ§ç«¯å£é»˜è®¤ä»…ç»‘å®šæœ¬æœºå›ç¯ï¼ˆ`127.0.0.1`ï¼‰ï¼›è‹¥éœ€å…¬ç½‘è®¿é—®ï¼Œè¯·æ˜¾å¼è®¾ç½®ï¼š
  - `GRAFANA_BIND_ADDRESS=0.0.0.0`
  - `PROMETHEUS_BIND_ADDRESS=0.0.0.0`
  - `LOKI_BIND_ADDRESS=0.0.0.0`
- `GRAFANA_ADMIN_PASSWORD` å¿…é¡»æ”¹ä¸ºå¼ºå¯†ç ï¼Œå¹¶é…åˆå®‰å…¨ç»„ç™½åå•ã€‚

é¢„ç½®ä»ªè¡¨ç›˜ï¼š
- `ai-trade Runtime`ï¼ˆå·²è‡ªåŠ¨å¯¼å…¥ï¼‰
- `ai-trade Metrics Runtime (Prometheus)`ï¼ˆå·²è‡ªåŠ¨å¯¼å…¥ï¼‰
- å…³é”®ç›‘æ§é¡¹ï¼š`equity/drawdown/notional`ã€`funnel_window.fills`ã€`throttle_total.hit_rate`ã€`Gate pass/fail`ã€`SELF_EVOLUTION_ACTION`ã€`OMS_RECONCILE_AUTORESYNC`ã€‚

ç”Ÿäº§ç¼–æ’ä¸‹å¯ç”¨ç›‘æ§æ ˆï¼š
```bash
AI_TRADE_IMAGE=ghcr.io/<owner>/ai-trade:<tag> \
docker compose -f docker-compose.prod.yml --profile obs up -d ai-trade loki promtail prometheus grafana
```

ç”Ÿäº§ç¼–æ’ä¸‹åˆ‡æ¢è¿è¡Œé…ç½®ï¼ˆä¸æ”¹ compose æ–‡ä»¶ï¼‰ï¼š
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_CONFIG_PATH=config/bybit.demo.s5.yaml
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d ai-trade
```

ç”Ÿäº§ç¼–æ’ä¸‹å¯åŠ¨è‡ªé—­ç¯å¸¸é©»æœåŠ¡ï¼ˆscheduler + watchdogï¼‰ï¼š
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d ai-trade watchdog scheduler
```

### GitHub Actions + é˜¿é‡Œäº‘ ECS è‡ªåŠ¨éƒ¨ç½²
é€‚ç”¨åœºæ™¯ï¼šä¸»åˆ†æ”¯åˆå¹¶åè‡ªåŠ¨æ„å»ºé•œåƒå¹¶å‘å¸ƒåˆ° ECSï¼Œæå‡è¿­ä»£æ•ˆç‡ä¸ä¸€è‡´æ€§ã€‚

æ–°å¢æ–‡ä»¶ï¼š
- `.github/workflows/ci.yml`ï¼šPR / é main åˆ†æ”¯ç¼–è¯‘ä¸æµ‹è¯•
- `.github/workflows/cd.yml`ï¼šmain åˆ†æ”¯è‡ªåŠ¨æ„å»ºé•œåƒå¹¶éƒ¨ç½² ECS
- `docker-compose.prod.yml`ï¼šç”Ÿäº§éƒ¨ç½²ç¼–æ’ï¼ˆä½¿ç”¨é¢„æ„å»ºé•œåƒï¼‰
- `deploy/ecs-deploy.sh`ï¼šè¿œç«¯éƒ¨ç½²è„šæœ¬ï¼ˆå¥åº·æ£€æŸ¥ + é—­ç¯é—¨ç¦å¤±è´¥è‡ªåŠ¨å›æ»šï¼‰

é¦–æ¬¡å‡†å¤‡ï¼ˆECSï¼‰ï¼š
```bash
sudo mkdir -p /opt/ai-trade/data
cd /opt/ai-trade

# è¿è¡Œæ—¶å¯†é’¥æ–‡ä»¶ï¼ˆä»…ç¤ºä¾‹ï¼ŒæŒ‰éœ€å¡«å†™ï¼‰
cat > .env.runtime <<'EOF'
AI_TRADE_IMAGE=ghcr.io/<owner>/ai-trade:<tag>
AI_TRADE_BYBIT_DEMO_API_KEY=your_demo_key
AI_TRADE_BYBIT_DEMO_API_SECRET=your_demo_secret
EOF
```

GitHub Secretsï¼ˆä»“åº“ Settings -> Secrets and variables -> Actionsï¼‰ï¼š
- `ECS_HOST`ï¼šECS å…¬ç½‘ IP
- `ECS_USER`ï¼šSSH ç”¨æˆ·ï¼ˆå¦‚ `root` / `ubuntu`ï¼‰
- `ECS_SSH_KEY`ï¼šSSH ç§é’¥
- `ECS_PORT`ï¼šSSH ç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤ 22ï¼‰
- `GHCR_USER`ï¼šGHCR æ‹‰é•œåƒè´¦å·ï¼ˆå¯é€‰ï¼Œç§æœ‰é•œåƒå»ºè®®é…ç½®ï¼‰
- `GHCR_TOKEN`ï¼šGHCR æ‹‰é•œåƒä»¤ç‰Œï¼ˆå¯é€‰ï¼Œç§æœ‰é•œåƒå»ºè®®é…ç½®ï¼‰

GitHub Variablesï¼ˆå¯é€‰ï¼Œç”¨äºè¦†ç›– CD å¼ºé—­ç¯é»˜è®¤å€¼ï¼‰ï¼š
- `CLOSED_LOOP_ENFORCE`ï¼ˆé»˜è®¤ `true`ï¼‰
- `CLOSED_LOOP_ACTION`ï¼ˆé»˜è®¤ `assess`ï¼‰
- `CLOSED_LOOP_STAGE`ï¼ˆé»˜è®¤ `DEPLOY`ï¼‰
- `CLOSED_LOOP_SINCE`ï¼ˆé»˜è®¤ `30m`ï¼‰
- `CLOSED_LOOP_MIN_RUNTIME_STATUS`ï¼ˆé»˜è®¤ç©ºï¼Œä½¿ç”¨é˜¶æ®µå†…ç½®é˜ˆå€¼ï¼‰
- `CLOSED_LOOP_OUTPUT_ROOT`ï¼ˆé»˜è®¤ `/opt/ai-trade/data/reports/closed_loop`ï¼‰
- `CLOSED_LOOP_STRICT_PASS`ï¼ˆé»˜è®¤ `true`ï¼‰
- `DEPLOY_SERVICES`ï¼ˆé»˜è®¤ `ai-trade watchdog scheduler`ï¼‰
- `GATE_DEFER_SERVICES`ï¼ˆé»˜è®¤ `watchdog scheduler`ï¼Œè¡¨ç¤ºé—¨ç¦é€šè¿‡åå†å¯åŠ¨çš„æœåŠ¡ï¼‰
- `DOCKER_LOG_MAX_SIZE`ï¼ˆé»˜è®¤ `20m`ï¼Œå®¹å™¨æ—¥å¿—è½®è½¬å¤§å°ï¼‰
- `DOCKER_LOG_MAX_FILE`ï¼ˆé»˜è®¤ `5`ï¼Œå®¹å™¨æ—¥å¿—è½®è½¬æ–‡ä»¶æ•°ï¼‰

è§¦å‘æ–¹å¼ï¼š
- `CI`ï¼šPR å’Œé main åˆ†æ”¯ push è‡ªåŠ¨è§¦å‘
- `CD`ï¼špush åˆ° `main` æˆ–æ‰‹åŠ¨ `workflow_dispatch` è§¦å‘

å‘å¸ƒç»“æœï¼š
- æ–°é•œåƒ tagï¼š`ghcr.io/<owner>/ai-trade:<commit_sha>`
- éƒ¨ç½²è„šæœ¬ä¼šå†™å…¥ `AI_TRADE_IMAGE` åˆ° `/opt/ai-trade/.env.runtime`
- éƒ¨ç½²è„šæœ¬é»˜è®¤ä¼šæ‹‰èµ·é—­ç¯æ ¸å¿ƒæœåŠ¡ï¼š`ai-trade + watchdog + scheduler`
- é—¨ç¦æ‰§è¡Œé¡ºåºä¸ºï¼šå…ˆåœ `GATE_DEFER_SERVICES`ï¼Œä»…å¯åŠ¨é defer æœåŠ¡åšé—¨ç¦ï¼›é—¨ç¦é€šè¿‡åå†å¯åŠ¨ defer æœåŠ¡
- å¯åŠ¨å¥åº·æ£€æŸ¥å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šåˆ°ä¸Šä¸€ä¸ªé•œåƒ
- å¥åº·æ£€æŸ¥é€šè¿‡åä¼šç«‹å³æ‰§è¡Œé—­ç¯ `assess` é—¨ç¦ï¼Œä¸”ä»…å½“ä»¥ä¸‹ä¸¤é¡¹éƒ½ä¸º `PASS` æ‰æ”¾è¡Œï¼š
  - `data/reports/closed_loop/latest_runtime_assess.json` çš„ `verdict`
  - `data/reports/closed_loop/latest_closed_loop_report.json` çš„ `overall_status`
- CD ä¼šè‡ªåŠ¨ä¸Šä¼ éƒ¨ç½²é—¨ç¦äº§ç‰©ä¸º artifactï¼š`deploy-closed-loop-<run_id>`

Bybit å›æ”¾é…ç½®ç¤ºä¾‹ï¼š
```bash
./build/trade_bot --config=config/bybit.replay.yaml
```

Bybit å®ç›˜æœ€å°é—­ç¯ï¼ˆPublic WS è¡Œæƒ… + Private WS æˆäº¤ + REST ä¸‹å•/æ’¤å•ï¼Œéœ€å°† `system.mode` è®¾ä¸º `paper` æˆ– `live`ï¼‰ï¼š
```bash
# æ¨èï¼šæŒ‰ç¯å¢ƒåˆ†ç¦»å¯†é’¥ï¼ˆtestnetï¼‰
export AI_TRADE_BYBIT_TESTNET_API_KEY=your_testnet_key
export AI_TRADE_BYBIT_TESTNET_API_SECRET=your_testnet_secret
./build/trade_bot --config=config/bybit.paper.yaml --exchange=bybit
```

Bybit Demo Tradingï¼ˆä¸»ç½‘æ¨¡æ‹Ÿç›˜ï¼‰ç¤ºä¾‹ï¼š
```bash
export AI_TRADE_BYBIT_DEMO_API_KEY=your_demo_key
export AI_TRADE_BYBIT_DEMO_API_SECRET=your_demo_secret
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit
```

ç¨³æ€å‚æ•°æ¨¡æ¿ï¼ˆæ›´ä½é¢‘ã€æ›´å¼ºé˜²æŠ–ï¼‰ï¼š
```bash
# Demo ç¨³æ€æ¨¡æ¿
./build/trade_bot --config=config/bybit.demo.stable.yaml --exchange=bybit --run_forever

# Paper/Testnet ç¨³æ€æ¨¡æ¿
./build/trade_bot --config=config/bybit.paper.stable.yaml --exchange=bybit --run_forever
```

Demo è‡ªè¿›åŒ–ä¿å®ˆæ¨¡æ¿ï¼ˆå…ˆè·‘è¿™ä¸ªå†é€æ­¥æ”¾å¼€ï¼‰ï¼š
```bash
./build/trade_bot --config=config/bybit.demo.evolution.yaml --exchange=bybit --run_forever
```

è¿è¡Œæ§åˆ¶ç¤ºä¾‹ï¼š
```bash
# æŒç»­è¿è¡Œï¼ˆé»˜è®¤ï¼šsystem.max_ticks=0ï¼‰
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --run_forever

# ä»…è¿è¡Œå›ºå®š tick æ•°åé€€å‡º
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --max_ticks=500
```

Docker ä¸‹è¿è¡Œ paper/demo ç¤ºä¾‹ï¼š
```bash
# è¯»å– .env ä¸­çš„ AK/SKï¼ˆä¸å†ä¸´æ—¶ -e æ³¨å…¥ï¼‰
docker compose run --rm ai-trade --config=config/bybit.paper.yaml --exchange=bybit

# ç¨³æ€æ¨¡æ¿ç¤ºä¾‹
docker compose run --rm ai-trade --config=config/bybit.demo.stable.yaml --exchange=bybit --run_forever

# è‡ªè¿›åŒ–ä¿å®ˆæ¨¡æ¿ç¤ºä¾‹
docker compose run --rm ai-trade --config=config/bybit.demo.evolution.yaml --exchange=bybit --run_forever
```

ç¦»çº¿ç ”ç©¶ï¼ˆR1/R2ï¼‰ç¤ºä¾‹ï¼š
```bash
# R0: æŠ“å– Bybit å†å² K çº¿ï¼ˆæœ¬æœº Pythonï¼‰
python3 tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv

# R0: æŠ“å– Bybit å†å² K çº¿ï¼ˆDockerï¼‰
docker compose run --rm --entrypoint python3 ai-trade-research \
  tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv

# R1: Minerï¼ˆC++ï¼‰
docker compose run --rm ai-trade \
  --run_miner \
  --miner_csv=./data/research/ohlcv_5m.csv \
  --miner_top_k=10 \
  --miner_generations=4 \
  --miner_population=32 \
  --miner_elite=8 \
  --miner_output=./data/research/miner_report.json

# R2: Integratorï¼ˆPython + CatBoostï¼‰
docker compose run --rm ai-trade-research \
  --csv=./data/research/ohlcv_5m.csv \
  --miner_report=./data/research/miner_report.json \
  --output=./data/research/integrator_report.json \
  --model_out=./data/models/integrator_latest.cbm
```

è‡ªåŠ¨é—­ç¯ï¼ˆè®­ç»ƒ/éªŒæ”¶/æ±‡æ€»æŠ¥å‘Šï¼‰ï¼š
```bash
# train: R0 + R1 + R2 + æ¨¡å‹æ³¨å†Œ + æ±‡æ€»æŠ¥å‘Š
tools/closed_loop_runner.sh train

# assess: ä»…è¿è¡Œæ€éªŒæ”¶ï¼ˆS3/S5ï¼‰+ æ±‡æ€»æŠ¥å‘Š
tools/closed_loop_runner.sh assess --stage S5 --since 4h

# full: train + assess
tools/closed_loop_runner.sh full --stage S5 --since 4h

# äº§ç‰©å›æ”¶ï¼ˆæŒ‰æ•°é‡ä¿ç•™ + å¯é€‰æ—¥å¿—æˆªæ–­ï¼‰
tools/recycle_artifacts.sh \
  --reports-root ./data/reports/closed_loop \
  --keep-run-dirs 120 \
  --keep-daily-files 120 \
  --keep-weekly-files 104
```

ç”Ÿäº§ç¯å¢ƒå»ºè®®é€šè¿‡ `scheduler` å¸¸é©»æ‰§è¡Œé—­ç¯ï¼š
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime
# å¯é€‰ï¼šåŠ é€ŸéªŒè¯ï¼ˆæ¯å°æ—¶è·‘ä¸€æ¬¡ assess/fullï¼‰
# export SCHEDULER_ACTION=assess
# export SCHEDULER_INTERVAL_SECONDS=3600
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d scheduler watchdog
```

`train/full` ç°åœ¨åŒ…å«ä¸¤é“å‰ç½®é—¨ç¦ï¼š
- `D1 baseline freeze`ï¼šå†»ç»“å½“å‰ active æ¨¡å‹å¿«ç…§ï¼ˆè¾“å‡º `baseline_report.json`ï¼‰
- `D2 data quality gate`ï¼šè®­ç»ƒå‰æ ¡éªŒ CSV è´¨é‡ï¼ˆè¾“å‡º `data_quality_report.json`ï¼‰

é—­ç¯äº§ç‰©ç›®å½•ï¼š
- æ¯æ¬¡è¿è¡Œï¼š`data/reports/closed_loop/<UTC_RUN_ID>/`
- æœ€æ–°è½¯é“¾æ¥ï¼š`data/reports/closed_loop/latest`
- æ€»ç»“æŠ¥å‘Šï¼š`data/reports/closed_loop/latest/closed_loop_report.json`
- å›ºå®šå…¥å£ï¼ˆæ— éœ€è§£æè½¯é“¾æ¥ï¼‰ï¼š
  - `data/reports/closed_loop/latest_closed_loop_report.json`
  - `data/reports/closed_loop/latest_runtime_assess.json`
  - `data/reports/closed_loop/latest_run_meta.json`
  - `data/reports/closed_loop/latest_run_id`
  - `data/reports/closed_loop/latest_daily_summary.json`
  - `data/reports/closed_loop/latest_weekly_summary.json`

å›æ”¶ç­–ç•¥ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼š
- `closed_loop_runner.sh` æ¯æ¬¡ç»“æŸåè‡ªåŠ¨æ‰§è¡Œ `tools/recycle_artifacts.sh`
- é»˜è®¤ä¿ç•™ï¼š
  - æœ€è¿‘ `120` ä¸ª run ç›®å½•
  - æœ€è¿‘ `120` ä»½ `daily_*.json`
  - æœ€è¿‘ `104` ä»½ `weekly_*.json`
  - æœ€è¿‘ `72h` äº§ç‰©ï¼ˆ`CLOSED_LOOP_GC_MAX_AGE_HOURS=72`ï¼‰
- å¯é€šè¿‡ç¯å¢ƒå˜é‡è¦†ç›–ï¼š
  - `CLOSED_LOOP_GC_ENABLED`
  - `CLOSED_LOOP_GC_KEEP_RUN_DIRS`
  - `CLOSED_LOOP_GC_KEEP_DAILY_FILES`
  - `CLOSED_LOOP_GC_KEEP_WEEKLY_FILES`
  - `CLOSED_LOOP_GC_MAX_AGE_HOURS`
  - `CLOSED_LOOP_GC_LOG_MAX_BYTES`
  - `CLOSED_LOOP_GC_LOG_KEEP_BYTES`

æ‰‹åŠ¨é‡å»ºæ—¥æŠ¥/å‘¨æŠ¥æ‘˜è¦ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼Œé—­ç¯è„šæœ¬ä¼šè‡ªåŠ¨ç”Ÿæˆï¼‰ï¼š
```bash
python3 tools/build_periodic_summary.py \
  --reports-root ./data/reports/closed_loop \
  --out-dir ./data/reports/closed_loop/summary
```

æŠ¥å‘Šé‡ç‚¹ï¼ˆè´¦å·ç›ˆäºï¼‰ï¼š
- `account_outcome.first_sample_utc` / `account_outcome.last_sample_utc`
- `account_outcome.first_equity_usd`
- `account_outcome.last_equity_usd`
- `account_outcome.equity_change_usd`
- `account_outcome.equity_change_pct`
- `account_outcome.day_start_equity_usd`
- `account_outcome.equity_change_vs_day_start_usd`
- `account_outcome.equity_change_vs_day_start_pct`
- `account_outcome.max_equity_usd_observed`
- `account_outcome.peak_to_last_drawdown_pct`
- `account_outcome.max_drawdown_pct_observed`

`runtime.warn_reasons` ä¸­çš„ Gate å¤±è´¥ç‡å‘Šè­¦å·²æŒ‰â€œè¿è¡Œæ€å½±å“â€æ”¶æ•›ï¼š
- ä»…å½“ Gate å¤±è´¥ç‡åé«˜ä¸”çª—å£å†…å‡ºç° `reduce_only/gate_halted/trading_halted` æ—¶æ‰ç»™é»„ç¯ï¼Œ
- çº¯â€œä½æ´»è·ƒä½†æœªè§¦å‘é™åˆ¶â€çš„æƒ…å†µä¸å†è¯¯æŠ¥é»„ç¯ã€‚

ECS ä¸€é”®éªŒæ”¶ï¼ˆå·²éƒ¨ç½² `docker-compose.prod.yml` åœºæ™¯ï¼‰ï¼š
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
tools/closed_loop_runner.sh assess \
  --compose-file docker-compose.prod.yml \
  --env-file .env.runtime \
  --stage S5 \
  --since 4h
cat data/reports/closed_loop/latest/closed_loop_report.json
cat data/reports/closed_loop/latest_daily_summary.json
cat data/reports/closed_loop/latest_weekly_summary.json
```

å®šæ—¶é—­ç¯ï¼ˆæ¨èï¼šä¸€é”®å®‰è£… cronï¼‰ï¼š
```bash
cd /opt/ai-trade
ops/cron/install_closed_loop_cron.sh install \
  --repo-dir /opt/ai-trade \
  --compose-file docker-compose.prod.yml \
  --env-file .env.runtime \
  --stage S5
```

è¯´æ˜ï¼šå®‰è£…è„šæœ¬ä¼šé¢å¤–ç”Ÿæˆ `cleanup` å®šæ—¶ä»»åŠ¡ï¼Œé»˜è®¤æ¯å¤©å›æ”¶ä¸€æ¬¡å†å²æŠ¥å‘Šï¼Œå¹¶å¯¹ `cron.log` åšæŒ‰å¤§å°æˆªæ–­ï¼ˆè¾“å‡ºåˆ° `data/reports/closed_loop/gc.log`ï¼‰ã€‚

ä»…ä¿ç•™ assess å®šæ—¶ä»»åŠ¡ï¼ˆç¦ç”¨ fullï¼‰ï¼š
```bash
ops/cron/install_closed_loop_cron.sh install --disable-full
```

å¸è½½å®šæ—¶ä»»åŠ¡ï¼š
```bash
ops/cron/install_closed_loop_cron.sh uninstall
```

æ¨¡æ¿ä»ä¿ç•™ï¼š`ops/cron/closed-loop.cron.example`ã€‚

GitHub Actions å®šæ—¶é—­ç¯ï¼š
- å·¥ä½œæµï¼š`.github/workflows/closed-loop.yml`
- æ”¯æŒ `workflow_dispatch` æ‰‹åŠ¨è§¦å‘ï¼ˆ`train/full/assess`ï¼‰
- é»˜è®¤æ¯ 6 å°æ—¶åœ¨ ECS æ‰§è¡Œä¸€æ¬¡ `assess` å¹¶è¾“å‡ºé—­ç¯æŠ¥å‘Šã€‚

è¯´æ˜ï¼šé»˜è®¤é‡‡ç”¨â€œWSä¼˜å…ˆã€å¤±è´¥è‡ªåŠ¨å›é€€ RESTâ€ã€‚
- è¡Œæƒ…é€šé“ï¼š`public_ws_enabled=true`ï¼Œå¤±è´¥å¯å›é€€ `/v5/market/tickers`
- æˆäº¤é€šé“ï¼š`private_ws_enabled=true`ï¼Œå¤±è´¥å¯å›é€€ `/v5/execution/list`
- Docker æ„å»ºé»˜è®¤å¯ç”¨ `Boost.Beast` WebSocket åç«¯ï¼Œè§„é¿éƒ¨åˆ†ç¯å¢ƒä¸‹ `libcurl` ä¸æ”¯æŒ `wss` çš„æ¡æ‰‹å¤±è´¥é—®é¢˜ã€‚

æ‰§è¡Œé˜²æŠ–å‚æ•°ï¼ˆ`execution`ï¼‰ï¼š
- `min_order_interval_ms`ï¼šåŒä¸€ symbol æœ€å°ä¸‹å•é—´éš”ï¼ˆæ¯«ç§’ï¼‰
- `reverse_signal_cooldown_ticks`ï¼šåå‘ä¿¡å·å†·å´ tick æ•°
- `min_rebalance_notional_usd`ï¼šæœ€å°è°ƒä»“åä¹‰é˜ˆå€¼ï¼ˆå°äºé˜ˆå€¼ä¸ä¸‹å•ï¼‰

ç­–ç•¥é˜²æŠ–å‚æ•°ï¼ˆ`strategy`ï¼‰ï¼š
- `signal_deadband_abs`ï¼šä»·æ ¼å˜åŒ–ç»å¯¹æ­»åŒº
- `min_hold_ticks`ï¼šåå‘ä¿¡å·æœ€å°æŒæœ‰ tick
- `signal_notional_usd`ï¼šä¿¡å·è¾“å‡ºç›®æ ‡åä¹‰å€¼

è¿è¡Œæ€è§‚æµ‹ï¼ˆ`system`ï¼‰ï¼š
- `status_log_interval_ticks`ï¼šå‘¨æœŸçŠ¶æ€æ—¥å¿—é¢‘ç‡ï¼ˆæ—¥å¿—å‰ç¼€ï¼š`RUNTIME_STATUS`ï¼‰
- `max_ticks`ï¼šè¿è¡Œ tick ä¸Šé™ï¼ˆ`0` è¡¨ç¤ºä¸è®¾ä¸Šé™ï¼‰
- `reconcile.mismatch_confirmations`ï¼šè¿ç»­å¯¹è´¦ä¸ä¸€è‡´ç¡®è®¤æ¬¡æ•°ï¼ˆé¿å…å•æ¬¡æŠ–åŠ¨è¯¯ç†”æ–­ï¼‰

æœ¬åœ°é—­ç¯æ¼”ç¤ºï¼ˆmock è¡Œæƒ…/æˆäº¤ï¼‰ï¼š
```bash
./build/trade_bot --exchange=mock
```

## ğŸ“… æœ€å°è½åœ°è·¯å¾„
1) å…ˆåšâ€œå¯è§‚æµ‹éª¨æ¶â€ï¼šé…ç½®/æ—¥å¿—/æŒ‡æ ‡/å®¡è®¡äº‹ä»¶è½åœ°
2) æ‰“é€šäº¤æ˜“é—­ç¯ï¼šäº¤æ˜“æ‰€é€‚é… â†’ OMS â†’ é£æ§ â†’ æ‰§è¡Œï¼ˆå…ˆæ”¯æŒ BTC/ETHï¼‰
3) ä¸Šçº¿æœ€å°ç­–ç•¥é—­ç¯ï¼šFeature â†’ Trend + VolTarget â†’ Portfolio â†’ Risk â†’ Execution
