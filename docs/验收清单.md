# 实现验收检查清单（P0三项 + 闭环保障）

> 目标：针对以下三项关键修复做可执行验收
> 1) 权重硬约束
> 2) Regime 分桶映射一致性
> 3) FUSE 与尘埃仓（dust）一致性

## 1. 权重硬约束（Portfolio / Self-Evolution）

### 1.1 配置与加载校验
- [ ] 加载时校验 `0 <= w_i <= 0.60`
- [ ] 加载时校验活跃策略权重和 `Σ w_i = 1.0`（允许 `1e-6` 容差）
- [ ] 拒绝负权重、超上限权重、总和不为 1 的配置
- [ ] 失败时拒绝应用并保留上一稳定快照

通过标准：
- 非法输入均被拒绝，系统不中断，继续使用上一快照

失败判定：
- 任何非法权重被应用成功
- 权重异常时未回退稳定快照

审计证据：
- 事件/日志包含 `PORT_WEIGHT_INVALID_REJECTED`
- 审计中包含 `weights_before/after` 与拒绝原因

### 1.2 在线更新校验（每次调权）
- [ ] 每次调权前后都做同样约束校验
- [ ] 单次变化量满足 `|Δw_i| <= 0.05`
- [ ] 连续更新间隔满足 `>= 6h`
- [ ] 单策略降级模式（`active_strategy_count=1`）允许 `w=1.0` 且有审计 `PORT_SINGLE_STRATEGY_MODE`

通过标准：
- 更新仅发生在约束满足时

失败判定：
- 出现越界更新或冷却期内更新

---

## 2. Regime 分桶映射一致性（RegimeEngine / Trainer / Gate）

### 2.1 映射规则唯一性
- [ ] 系统内仅使用以下映射：
  - `UPTREND -> TREND`
  - `DOWNTREND -> TREND`
  - `RANGE -> RANGE`
  - `EXTREME -> EXTREME`
- [ ] 配置映射完整覆盖四态，且值仅允许 `TREND/RANGE/EXTREME`

通过标准：
- 线上决策、离线训练、Gate 报告的 bucket 统计一致

失败判定：
- 同一时间窗出现不同模块 bucket 不一致
- 出现未映射或非法 bucket

审计证据：
- `RegimeState` 含 `regime` 与 `regime_bucket`
- Gate 报告按同一 bucket 维度输出

### 2.2 回放一致性
- [ ] 固定样本回放两次，`regime_bucket` 序列完全一致
- [ ] 映射变更必须走版本升级并触发 Gate

通过标准：
- 回放可复现、映射可追溯

---

## 3. FUSE 与尘埃仓一致性（Risk / Execution / OMS）

### 3.1 FUSE“经济意义全平”
- [ ] 触发 FUSE 后，可交易仓位全部清零
- [ ] 小于 `min_notional` 的 dust 仓位允许残留，但必须标记 `DUST_LOCKED`
- [ ] `DUST_LOCKED` 仓位禁止任何加仓动作

通过标准：
- FUSE 后无可交易净敞口；仅可能存在 dust 残仓且已锁定

失败判定：
- FUSE 后仍有可交易仓位未平
- dust 残仓未锁定或可被加仓

审计证据：
- `EXEC_DUST_POSITION_STUCK`
- `DUST_LOCKED`（及后续可选 `DUST_UNLOCKED`）

### 3.2 执行过滤协同
- [ ] `min_notional` 过滤命中时记录 `EXEC_FILTER_IGNORE`
- [ ] FUSE/强平场景命中 `min_notional` 不得判定熔断失败
- [ ] OMS 对 dust 仓位状态可见并可对账
- [ ] 同一 OrderIntent 重试多次，仅存在一个有效 `client_order_id`

通过标准：
- 执行层与风控层对“全平”定义一致，无互相打架

---

## 4. 集成验收场景（建议最小集）

- [ ] Case A: 合法调权（通过）
- [ ] Case B: 负权重输入（拒绝并回退）
- [ ] Case C: 权重和=1.02（拒绝并回退）
- [ ] Case D: `UPTREND` 与 `DOWNTREND` 均映射到 `TREND`
- [ ] Case E: FUSE + 可交易仓位（全部平掉）
- [ ] Case F: FUSE + dust 仓位（保留且 `DUST_LOCKED`）
- [ ] Case G: dust 锁定后尝试加仓（必须拒绝）

验收结论规则：
- 任一 P0 检查项失败，则本轮版本 `FAIL`
- 三大类全部通过，方可进入下一 Gate 阶段

---

## 5. 闭环保障验收（防“无信号/无交易/无学习反馈”）

### 5.1 信号活跃度与漏斗可观测
- [ ] 实现 `signal_heartbeat`：连续 `12` 个 5m 周期无有效信号触发告警
- [ ] 实现信号漏斗指标：`raw_signal -> portfolio -> risk_adjusted -> order_intent -> ack/fill`
- [ ] 每层都能看到“数量、通过率、拒绝原因 TopN”

通过标准：
- 能定位“无交易”是因为无信号还是被中间层过滤

失败判定：
- 仅看到最终成交为0，无法定位卡点

### 5.2 健康门禁可解释
- [ ] 看板提供 `data_ok`、`trade_ok`、`filters_pass_rate` 的时序
- [ ] 当 `data_ok=false` 或 `trade_ok=false` 时，审计必须解释“为何无交易”

通过标准：
- 系统层门禁导致的停摆可解释、可追溯

### 5.3 学习触发保护（避免稀疏样本误更新）
- [ ] `min_decision_epochs` 未达标时，仅评估不更新
- [ ] `min_fills_for_update` 未达标时，仅评估不更新
- [ ] 记录审计事件 `LEARN_SKIPPED_INSUFFICIENT_DATA`
- [ ] 样本计数必须包含“空仓决策周期”，防止系统在震荡期因无成交而停止进化

通过标准：
- 样本稀疏时不发生盲目调参

### 5.4 基线回退与恢复
- [ ] 定义 `baseline` 参数/权重快照并可一键切回
- [ ] 连续退化或长期无交易时自动回退到 `baseline`
- [ ] **修正**：仅当“长期无交易”且“Baseline (Shadow) 有盈利交易”时才触发回退。若两者均静默，视为正常市场行为，不触发回退。

通过标准：
- 不会陷入“新参数无反馈但持续运行”的空转状态

### 5.5 闭环完成判定（学习->调整->验证）
- [ ] 至少一次学习评估触发（有输入、有输出）
- [ ] 至少一次合法参数/权重更新成功落地
- [ ] 更新后至少经过一轮 Gate 验证并给出 PASS/FAIL
- [ ] 回滚演练至少一次通过

通过标准：
- 形成可验证闭环：`学习评估 -> 参数调整 -> Gate验证 ->（必要时）回滚`

### 5.6 额外集成场景（建议）
- [ ] Case H: 连续12个5m周期无信号（触发 heartbeat 告警）
- [ ] Case I: 有 raw signal 但被 Risk 全部拦截（漏斗可定位）
- [ ] Case J: 样本不足（学习跳过且写审计）
- [ ] Case K: 更新后性能连续2周期劣化（自动回退 baseline）
- [ ] Case L: 日信号数不足阈值（Gate 触发 `FAIL_LOW_ACTIVITY_SIGNALS`）
- [ ] Case M: 日成交数不足阈值（Gate 触发 `FAIL_LOW_ACTIVITY_FILLS`）
- [ ] Case N: 同一 intent 连续重试 3 次（交易所仅 1 笔有效订单）
