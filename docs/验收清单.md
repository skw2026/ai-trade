# 实现验收检查清单（P0三项 + 闭环保障）

> 目标：针对以下三项关键修复做可执行验收
> 1) 权重硬约束
> 2) Regime 分桶映射一致性
> 3) FUSE 与尘埃仓（dust）一致性

## 0. 分阶段闸门验收（Bybit Demo 专用）

> 用途：你每次按阶段用对应配置连续运行后，把日志发给我；我按下面标准做 **Go/No-Go** 判定，决定是否进入下一阶段。

### 0.1 验收提交流程（固定）

1. 启动命令（建议保留完整输出）：
   - S1~S4：`docker compose run --rm ai-trade --config=config/bybit.demo.evolution.yaml --exchange=bybit --run_forever`
   - S5：`docker compose run --rm ai-trade --config=config/bybit.demo.s5.yaml --exchange=bybit --run_forever`
2. 每个阶段至少运行到该阶段要求的最小时长/最小 tick。
3. 提交日志时至少包含以下区段：
   - 启动段：`启动 ai-trade` 到 `SELF_EVOLUTION_INIT`
   - 运行段：至少 10 条 `RUNTIME_STATUS`
   - 事件段：`OMS_RECONCILE_*`、`GATE_*`、`ORDER_THROTTLED`、`SELF_EVOLUTION_*`
4. 我按“阶段闸门表”给结论：
   - `PASS`：可进入下一阶段
   - `PASS_WITH_ACTIONS`：可进入下一阶段，但要先改参数/配置
   - `FAIL`：不得进入下一阶段，先修复阻断项

### 0.2 阶段闸门表（Go/No-Go）

#### 阶段 S1：连通性与基础稳态

目标：确认 Bybit WS/REST、账户同步、基础交易回路可工作。  
建议运行：`>= 15 分钟` 或 `>= 300 ticks`。

通过标准（必须全部满足）：
- [ ] 出现 `Bybit 公共WS连接成功` 与 `Bybit 私有WS连接成功`
- [ ] 出现 `远端持仓同步完成` 与 `远端资金同步完成`
- [ ] 周期 `RUNTIME_STATUS` 中 `public_ws_healthy=true` 且 `private_ws_healthy=true`
- [ ] 无 `TRADING_HALTED` 或 `CRITICAL` 级停机日志

失败即阻断：
- [ ] WS 频繁降级且无法恢复
- [ ] 账户同步长期失败（>3个刷新周期）
- [ ] 启动后即持续 halt

#### 阶段 S2：OMS 对账与在途单一致性

目标：验证“本地视图 vs 交易所视图”可收敛，不发生不可恢复漂移。  
建议运行：`>= 30 分钟` 或 `>= 800 ticks`。

通过标准（必须全部满足）：
- [ ] 允许出现 `OMS_RECONCILE_MISMATCH`，但需看到可恢复路径：
  - `OMS_RECONCILE_DEFERRED` 或
  - `OMS_RECONCILE_AUTORESYNC: applied=true`
- [ ] 出现 `OMS_STALE_PENDING_CLOSED` 后，不应引发永久性 halt
- [ ] `Bybit 撤单幂等成功` 能处理 `110001`（order not exists）并持续运行
- [ ] 期间无连续不可恢复对账错误导致停机

失败即阻断：
- [ ] `TRADING_HALTED` 由对账问题触发且无法自动恢复
- [ ] 同一类 mismatch 在短窗口内持续放大（未收敛）

#### 阶段 S3：Gate 运行态闭环

目标：确认“信号-意图-成交-告警”漏斗可观测且可解释。  
建议运行：`>= 45 分钟` 或 `>= 1200 ticks`。

通过标准（必须全部满足）：
- [ ] 周期 `RUNTIME_STATUS` 持续输出 `funnel_window` 与 `throttle_window/total`
- [ ] 至少出现一次 `GATE_CHECK_PASSED` 或 `GATE_CHECK_FAILED`
- [ ] 若出现 `WARN_SIGNAL_HEARTBEAT_GAP`，可从 `funnel_window` 解释原因
- [ ] `trade_ok=true` 与 `trading_halted=false` 在大多数窗口保持稳定

失败即阻断：
- [ ] Gate 只有告警，无窗口判定（无 PASS/FAIL）
- [ ] 漏斗字段缺失，无法解释“为什么没交易”

#### 阶段 S4：自进化最小链路（阶段2）

目标：验证“可学习参数更新 + 风险约束 + 回滚冷却”链路可运行。  
建议运行：`>= 1 个 update_interval_ticks`（以配置为准；`bybit.demo.evolution.yaml` 当前为 `1200 ticks`）。

通过标准（必须全部满足）：
- [ ] 出现 `SELF_EVOLUTION_INIT`
- [ ] 在一个完整评估周期内至少出现一次：
  - `SELF_EVOLUTION_ACTION`（更新或回滚）或
  - 明确的 `evolution_skipped` 统计（有原因）
- [ ] 运行期间无 `risk.*` 被学习覆盖的迹象（不可动层不变）
- [ ] 若触发回滚，需看到回滚后进入 `cooldown` 并继续稳定运行

失败即阻断：
- [ ] 到周期结束仍无任何进化评估/动作日志
- [ ] 进化行为导致风控失效或系统频繁 halt

#### 阶段 S5：阶段收官（可进入“目标达成验收”）

目标：证明系统可连续稳定运行并具备可审计闭环。  
建议运行：`>= 4 小时`（中途不重启）。
建议配置：`config/bybit.demo.s5.yaml`（稳态 soak 参数模板）。

通过标准（必须全部满足）：
- [ ] S1~S4 均通过
- [ ] 无不可恢复 halt
- [ ] 对账异常可自动收敛或可解释降级
- [ ] Gate 与 Evolution 状态在 `RUNTIME_STATUS` 可持续追踪

结论规则：
- S5 通过后，进入“项目目标达成验收”（收益目标、策略有效性、长期稳定性）。
- 任一阶段 `FAIL`，先修复该阶段阻断项，不跨级推进。

## 1. 权重硬约束（Portfolio / Self-Evolution）

### 1.1 配置与加载校验
- [ ] 加载时校验 `0 <= w_i <= 0.60`
- [ ] 加载时校验活跃策略权重和 `Σ w_i = 1.0`（允许 `1e-6` 容差）
- [ ] 拒绝负权重、超上限权重、总和不为 1 的配置
- [ ] 失败时拒绝应用并保留上一稳定快照

通过标准：
- 非法输入均被拒绝，系统不中断，继续使用上一快照

失败判定：
- 任何非法权重被应用成功
- 权重异常时未回退稳定快照

审计证据：
- 事件/日志包含 `PORT_WEIGHT_INVALID_REJECTED`
- 审计中包含 `weights_before/after` 与拒绝原因

### 1.2 在线更新校验（每次调权）
- [ ] 每次调权前后都做同样约束校验
- [ ] 单次变化量满足 `|Δw_i| <= 0.05`
- [ ] 连续更新间隔满足 `>= 6h`
- [ ] 单策略降级模式（`active_strategy_count=1`）允许 `w=1.0` 且有审计 `PORT_SINGLE_STRATEGY_MODE`

通过标准：
- 更新仅发生在约束满足时

失败判定：
- 出现越界更新或冷却期内更新

---

## 2. Regime 分桶映射一致性（RegimeEngine / Trainer / Gate）

### 2.1 映射规则唯一性
- [ ] 系统内仅使用以下映射：
  - `UPTREND -> TREND`
  - `DOWNTREND -> TREND`
  - `RANGE -> RANGE`
  - `EXTREME -> EXTREME`
- [ ] 配置映射完整覆盖四态，且值仅允许 `TREND/RANGE/EXTREME`

通过标准：
- 线上决策、离线训练、Gate 报告的 bucket 统计一致

失败判定：
- 同一时间窗出现不同模块 bucket 不一致
- 出现未映射或非法 bucket

审计证据：
- `RegimeState` 含 `regime` 与 `regime_bucket`
- Gate 报告按同一 bucket 维度输出

### 2.2 回放一致性
- [ ] 固定样本回放两次，`regime_bucket` 序列完全一致
- [ ] 映射变更必须走版本升级并触发 Gate

通过标准：
- 回放可复现、映射可追溯

---

## 3. FUSE 与尘埃仓一致性（Risk / Execution / OMS）

### 3.1 FUSE“经济意义全平”
- [ ] 触发 FUSE 后，可交易仓位全部清零
- [ ] 小于 `min_notional` 的 dust 仓位允许残留，但必须标记 `DUST_LOCKED`
- [ ] `DUST_LOCKED` 仓位禁止任何加仓动作

通过标准：
- FUSE 后无可交易净敞口；仅可能存在 dust 残仓且已锁定

失败判定：
- FUSE 后仍有可交易仓位未平
- dust 残仓未锁定或可被加仓

审计证据：
- `EXEC_DUST_POSITION_STUCK`
- `DUST_LOCKED`（及后续可选 `DUST_UNLOCKED`）

### 3.2 执行过滤协同
- [ ] `min_notional` 过滤命中时记录 `EXEC_FILTER_IGNORE`
- [ ] FUSE/强平场景命中 `min_notional` 不得判定熔断失败
- [ ] OMS 对 dust 仓位状态可见并可对账
- [ ] 同一 OrderIntent 重试多次，仅存在一个有效 `client_order_id`
- [ ] 保护单开关启用时：新开仓后在 `attach_timeout_ms` 内至少有一笔已确认 SL
- [ ] TP/SL 同时触发条件下，SL 优先
- [ ] 一侧保护单成交后，对侧保护单自动撤销（OCO 语义）

通过标准：
- 执行层与风控层对“全平”定义一致，无互相打架

---

## 4. 集成验收场景（建议最小集）

- [ ] Case A: 合法调权（通过）
- [ ] Case B: 负权重输入（拒绝并回退）
- [ ] Case C: 权重和=1.02（拒绝并回退）
- [ ] Case D: `UPTREND` 与 `DOWNTREND` 均映射到 `TREND`
- [ ] Case E: FUSE + 可交易仓位（全部平掉）
- [ ] Case F: FUSE + dust 仓位（保留且 `DUST_LOCKED`）
- [ ] Case G: dust 锁定后尝试加仓（必须拒绝）

验收结论规则：
- 任一 P0 检查项失败，则本轮版本 `FAIL`
- 三大类全部通过，方可进入下一 Gate 阶段

---

## 5. 闭环保障验收（防“无信号/无交易/无学习反馈”）

### 5.1 信号活跃度与漏斗可观测
- [ ] 实现 `signal_heartbeat`：连续 `12` 个 5m 周期无有效信号触发告警
- [ ] 实现信号漏斗指标：`raw_signal -> portfolio -> risk_adjusted -> order_intent -> ack/fill`
- [ ] 每层都能看到“数量、通过率、拒绝原因 TopN”

通过标准：
- 能定位“无交易”是因为无信号还是被中间层过滤

失败判定：
- 仅看到最终成交为0，无法定位卡点

### 5.2 健康门禁可解释
- [ ] 看板提供 `data_ok`、`trade_ok`、`filters_pass_rate` 的时序
- [ ] 当 `data_ok=false` 或 `trade_ok=false` 时，审计必须解释“为何无交易”

通过标准：
- 系统层门禁导致的停摆可解释、可追溯

### 5.3 学习触发保护（避免稀疏样本误更新）
- [ ] `min_decision_epochs` 未达标时，仅评估不更新
- [ ] `min_fills_for_update` 未达标时，仅评估不更新
- [ ] 记录审计事件 `LEARN_SKIPPED_INSUFFICIENT_DATA`
- [ ] 样本计数必须包含“空仓决策周期”，防止系统在震荡期因无成交而停止进化

通过标准：
- 样本稀疏时不发生盲目调参

### 5.4 基线回退与恢复
- [ ] 定义 `baseline` 参数/权重快照并可一键切回
- [ ] 连续退化或长期无交易时自动回退到 `baseline`
- [ ] **修正**：仅当“长期无交易”且“Baseline (Shadow) 有盈利交易”时才触发回退。若两者均静默，视为正常市场行为，不触发回退。

通过标准：
- 不会陷入“新参数无反馈但持续运行”的空转状态

### 5.5 闭环完成判定（学习->调整->验证）
- [ ] 至少一次学习评估触发（有输入、有输出）
- [ ] 至少一次合法参数/权重更新成功落地
- [ ] 更新后至少经过一轮 Gate 验证并给出 PASS/FAIL
- [ ] 回滚演练至少一次通过

通过标准：
- 形成可验证闭环：`学习评估 -> 参数调整 -> Gate验证 ->（必要时）回滚`

### 5.6 额外集成场景（建议）
- [ ] Case H: 连续12个5m周期无信号（触发 heartbeat 告警）
- [ ] Case I: 有 raw signal 但被 Risk 全部拦截（漏斗可定位）
- [ ] Case J: 样本不足（学习跳过且写审计）
- [ ] Case K: 更新后性能连续2周期劣化（自动回退 baseline）
- [ ] Case L: 日信号数不足阈值（Gate 触发 `FAIL_LOW_ACTIVITY_SIGNALS`）
- [ ] Case M: 日成交数不足阈值（Gate 触发 `FAIL_LOW_ACTIVITY_FILLS`）
- [ ] Case N: 同一 intent 连续重试 3 次（交易所仅 1 笔有效订单）
- [ ] Case O: 保护单启用且开仓成功（SL 及时挂出，TP可选）
- [ ] Case P: SL 挂单失败（触发 `EXEC_PROTECTIVE_ORDER_MISSING` + 进入 `REDUCE_ONLY`/冻结）
- [ ] Case Q: TP 挂单失败（记录 `EXEC_TP_ATTACH_FAILED`，持仓继续但可审计）

---

## 6. 因子-模型-风控闭环（前两级）验收清单（阶段3准备）

> 说明：本节用于你提出的  
> 第一级 `Miner`（遗传规划/符号回归） + 第二级 `Integrator`（CatBoost）  
> 当前代码主链路可先保持不变，先完成“离线可复现 + 影子可观测”验收。

### 6.0 Stage R0：研究数据准备（Bybit 历史 K 线）

目标：准备可复现实验输入数据，避免 R1/R2 因数据缺失或样本过少失败。  
建议运行：每次新一轮实验前拉取一次。

建议命令（当前代码可执行）：
```bash
# 本机 Python
python3 tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv

# Docker（复用研究镜像）
docker compose run --rm --entrypoint python3 ai-trade-research \
  tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv
```

通过标准（必须全部满足）：
- [ ] 日志出现 `FETCH_START`、`FETCH_PAGE`、`FETCH_DONE`
- [ ] 输出文件存在，表头为 `timestamp,open,high,low,close,volume`
- [ ] 输出行数满足 R1/R2 最低样本要求（建议 `bars >= 3000`）
- [ ] 时间戳单调递增且无明显大范围空洞（允许少量交易时段缺口）

失败即阻断：
- [ ] 文件缺失或列不完整（R1/R2 不得启动）
- [ ] 样本数量远小于窗口配置（易触发单类标签/切分不可训练）

### 6.1 Stage R1：Miner 离线因子挖掘

目标：稳定产出可执行因子公式集，并验证 OOS 有效性。  
建议运行：固定历史数据窗口，至少两次重复实验（同随机种子）。

建议命令（当前代码可执行）：
```bash
./build/trade_bot \
  --run_miner \
  --miner_csv=./data/research/ohlcv_5m.csv \
  --miner_top_k=10 \
  --miner_output=./data/research/miner_report.json
```

通过标准（必须全部满足）：
- [ ] 产出 `factor_set_version` 与完整因子元数据（表达式、IC、复杂度）
- [ ] 因子函数包含时序算子能力：`ts_delay/ts_delta/ts_rank/ts_corr`
- [ ] 同种子重复运行，Top 因子集合可复现（允许小幅排序差异）
- [ ] OOS IC 不劣于随机基线（需有对照报告）
- [ ] 因子适应度报告包含 Spearman IC 分布（均值/分位数/稳定性）
- [ ] 时序算子单测通过（边界窗口、空值、窗口长度不足）

失败即阻断：
- [ ] 仅有 in-sample 优势，OOS 全面失效
- [ ] 公式不可执行或存在未来信息泄漏

### 6.2 Stage R2：Integrator 离线训练与反泄漏

目标：完成 CatBoost 时序训练链路并确认无 Look-ahead。  
建议运行：Rolling/TimeSeriesSplit 全量评估一次。

建议命令（当前代码可执行）：
```bash
# 本机 Python
python3 tools/integrator_train.py \
  --csv=./data/research/ohlcv_5m.csv \
  --miner_report=./data/research/miner_report.json \
  --output=./data/research/integrator_report.json \
  --model_out=./data/models/integrator_latest.cbm \
  --split_method=rolling \
  --n_splits=5 \
  --train_window_bars=800 \
  --test_window_bars=120 \
  --rolling_step_bars=120 \
  --predict_horizon_bars=1

# Docker（推荐，避免本机依赖差异）
docker compose run --rm ai-trade-research \
  --csv=./data/research/ohlcv_5m.csv \
  --miner_report=./data/research/miner_report.json \
  --output=./data/research/integrator_report.json \
  --model_out=./data/models/integrator_latest.cbm
```

通过标准（必须全部满足）：
- [ ] 明确训练/验证时间切分，禁止随机 K-Fold
- [ ] 标签定义与特征时间对齐可审计（`t` 特征预测 `t+1...t+h`）
- [ ] `feature_importance` 可导出，且可识别一级因子贡献
- [ ] 生成 `model_version`、`feature_schema_version`、`metrics_oos`
- [ ] 训练日志可证明使用时序安全流程（Rolling/TimeSeriesSplit，固定窗口边界）
- [ ] 存在基线对照（当前规则或简单模型），并输出增益/退化结论

失败即阻断：
- [ ] 发现未来字段泄漏
- [ ] 线上特征 schema 与训练 schema 不一致

### 6.3 Stage R3：在线影子模式（不接管下单）

目标：模型可在线推理并可观测，但不直接驱动真实下单。  
建议运行：Bybit demo 连续运行 `>= 2h`。

通过标准（必须全部满足）：
- [ ] 运行日志包含模型推理结果（`model_score`/`p_up`/`p_down`）
- [ ] 模型健康状态可见（可用/降级/过期）
- [ ] 模型异常时自动降级到基线策略，不触发停机风暴
- [ ] 第三级（Regime/Gate/Risk）规则仍一票否决
- [ ] 影子模式关闭时，主交易路径行为与历史版本一致（无行为漂移）

失败即阻断：
- [ ] 模型不可用导致交易链路中断
- [ ] 模型输出绕过硬风控

### 6.4 进入“代码实现阶段”的前置门槛
- [ ] R1 通过
- [ ] R2 通过
- [ ] R3 通过（影子模式）
- [ ] 满足后才允许把第二级输出接入真实下单决策路径（灰度方式）
