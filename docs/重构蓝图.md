# 全工程前瞻性重构蓝图（v1）

> 目标：在不破坏当前“可运行闭环”的前提下，把 `ai-trade` 从“可跑”升级为“可持续演进、可治理、可审计、可规模化”的工程体系。

## 1. 重构原则

1. 业务连续性优先：任何阶段都不能中断现有 `ai-trade + watchdog + scheduler` 闭环。
2. 先治理再扩张：先统一契约、测试、发布、回滚，再扩大功能面。
3. 数据先行：所有策略评估与 AI 进化以结构化数据和报告为准，不以日志主观判断。
4. 安全边界刚性：风控规则、发布审批、配置变更都必须可追溯且可回滚。
5. 演进式重构：每一阶段都可独立交付并产生收益，不做“大爆炸式重写”。

## 2. 目标架构（Target Architecture）

### 2.1 四平面架构

1. Execution Plane（交易执行平面）
   - 现有 C++ 交易内核：行情、策略、风控、执行、OMS、对账。
   - 只负责低延迟决策与执行，不承担运营管理页面职责。

2. Control Plane（控制治理平面）
   - 参数管理、发布审批、灰度开关、回滚控制、运行态巡检。
   - 提供 API 与 Web 控制台（`ai-trade-web`）。

3. Data Plane（数据与观测平面）
   - 统一事件/报告契约、指标聚合、时序统计、报表查询。
   - 先基于现有 JSON 报告 + 日志解析，逐步过渡到结构化事件流。

4. ML Plane（研究与模型治理平面）
   - Miner/Integrator 训练、评估、注册、激活、影子验证、晋级。
   - 统一模型元数据与门禁，避免“模型已训练但线上不可证”。

### 2.2 仓库分层目标

1. `src/`：交易内核（执行平面）。
2. `tools/`：闭环编排、验收、报表、治理脚本。
3. `apps/ai_trade_web/`：控制平面服务与前端。
4. `docs/`：架构、规范、运行手册、ADR（Architecture Decision Record）。
5. `ops/`：部署、巡检、定时任务、灾备脚本。

## 3. 最佳实践落地清单

### 3.1 工程治理

1. 统一命令入口：`Makefile` + `tools/quality_gate.sh`。
2. 强制质量门禁：编译、单测、compose 一致性、报告契约校验。
3. 变更可追踪：配置、模型、发布动作全部落审计记录。
4. 文档与代码同步：关键运行路径以文档基线为验收项。

### 3.2 数据契约

1. `latest_closed_loop_report.json` / `latest_runtime_assess.json` / `latest_run_meta.json` 建立“强字段契约”。
2. 新增契约校验脚本，纳入 CI 与本地质量门禁。
3. 报告字段版本化，避免 Web 与脚本因字段漂移崩溃。

### 3.3 测试体系

1. 内核测试：C++ 单元测试（执行/风控/对账核心路径）。
2. 工具测试：Python 单测（验收脚本、compose 一致性、回收策略、报告契约）。
3. 端到端冒烟：compose 启停 + 最新报告可生成。
4. 发布门禁：CD 部署后自动验收，不通过即回滚。

### 3.4 可运维性

1. 统一健康检查：容器健康 + 关键文件健康 + 门禁状态健康。
2. 统一报表入口：latest + run_id 历史视图。
3. 明确故障分层：运行故障、策略故障、模型故障、配置故障。

## 4. 分阶段实施路线

## Phase A（当前开始）：工程底座重构（1-2 周）

目标：建立“可持续重构”的基础设施。

1. 引入完整重构蓝图与工程规范基线。
2. 落地统一质量门禁脚本与标准命令入口。
3. 建立报告契约校验并纳入 CI。
4. 新增 `ai-trade-web` 后端骨架（只读，不写参数）。

交付标准：
1. 当前闭环流程无回归。
2. 新增门禁在本地与 CI 均可运行。
3. Web 能读取 latest 报告与历史 run 列表。

## Phase B：控制平面可用化（2-4 周）

目标：把“看报告”升级为“可治理”。

1. 参数管理（草稿/校验/发布/回滚）
2. 变更审批与审计日志。
3. 策略/模型状态面板（shadow/canary/active）。
4. 异常操作保护（只读模式、冻结开关）。

## Phase C：数据平面结构化（3-6 周）

目标：减少日志解析依赖，提升评估可信度。

1. 将关键运行事件结构化输出（JSONL/事件流）。
2. 构建标准化策略评估数据集。
3. 打通报表查询 API 与看板。

## Phase D：模型治理强化（4-8 周）

目标：自学习/进化“可证明有效”。

1. 模型晋级流水线（shadow->canary->active）。
2. 回测/影子/运行态三位一体对比评估。
3. 策略进化收益归因与回滚自动化。

## 5. 风险与回滚策略

1. 所有新增功能默认“旁路模式”（不影响交易主链路）。
2. compose 新服务通过 profile 启用，默认不参与生产关键路径。
3. 任一阶段出现回归，优先回滚新增控制平面服务，不动交易内核。
4. 阶段验收不通过，不进入下一阶段。

## 6. 本次改造（v1）范围

1. 新增本蓝图文档（全工程目标与路径）。
2. 新增工程质量门禁：`Makefile` + `tools/quality_gate.sh`。
3. 新增报告契约校验脚本与单测。
4. 新增 `apps/ai_trade_web` 只读后端骨架与 compose 接入（profile）。
5. CI 增加新测试注册检查。

## 7. 已进入的下一步（v1.1，Phase-B 起步）

1. 参数治理链路落地（草稿/校验/发布/回滚/审计 API）。
2. 写入保护默认关闭：`AI_TRADE_WEB_ENABLE_WRITE=false`。
3. 写入强认证：`AI_TRADE_WEB_ADMIN_TOKEN` 必须配置且请求头匹配。
4. 发布保护默认开启：要求 latest 运行验收为 `PASS` 才允许发布。

---

后续每次迭代都应在本蓝图中追加“已完成项/下一步项”，避免重构漂移。
