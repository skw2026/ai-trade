# 策略、Regime、自进化（Bandit）— 工程落地规范

## 1. 策略标准接口（无代码版）
策略输入：
- FeatureSnapshot（5m主）
- RegimeState（含event_window）
- AccountState（权益、回撤、liq_distance、margin_used等）

策略输出（Signal）必须满足：
- suggested_notional_usd 为唯一敞口口径
- symbol 必填（由 UniverseSelector 产出的 active_symbols 决定）
- valid_until_ms 必填（过期作废）
- reason_codes 非空
- 不允许直接下单、不允许修改风控参数

当前实现对齐：
- `signal_valid_for_ms` 生成 `valid_until_ms`
- `reason_codes` 在 Strategy/Portfolio/Model 叠加后保持非空

策略回调（可选）：
- on_order_update(order_event): 感知订单状态
- on_fill(fill_event): 感知成交，用于更新策略内部状态（如均值回归的 entry_price）

## 2. 三大策略：最小可用实现（MVP能跑）
### 2.1 Trend（趋势突破）
特征依赖：ema_fast/slow, ma_slope, atr_5m, rv_1h, breakout_high/low_N
入场：
- 多：ema_fast>ema_slow & ma_slope>0 & price>breakout_high_N & rv_1h<rv_cap
- 空：ema_fast<ema_slow & ma_slope<0 & price<breakout_low_N & rv_1h<rv_cap
出场：
- 多：price<ema_slow 或 price<entry - k_atr*atr
- 空：price>ema_slow 或 price>entry + k_atr*atr
输出：
- strength=clamp((price-breakout)/(k_atr*atr),0,1)
- suggested_notional_usd=direction * base_notional * strength
reason_codes：STR_BREAKOUT + STR_TREND_UP/DOWN + REG_*

当前实现对齐：
- 基础方向：EMA fast/slow
- 可选过滤：`trend_breakout_lookback_ticks`、`trend_slope_lookback_ticks`、`trend_vol_cap_annual`
- 可选强度缩放：`trend_strength_scale`（0=关闭）
- 防御分支可启用独立信号源：`defensive_rank_lookback_ticks`（`ts_rank(close,N)`），避免与 Trend 共用同一 slow EMA

### 2.2 MeanRev（均值回归，阶段2上线）
特征依赖：zscore(lookback=96), ma_slope或ret_4h, atr_5m
过滤：
- abs(ma_slope)>slope_cap 或 abs(ret_4h)>trend_cap → 禁止入场
- Regime!=RANGE → 输出0（禁用）
入/出场：
- zscore>z_enter 做空；zscore<-z_enter 做多
- zscore回归至z_exit出场；z_stop灾难止损
reason_codes：STR_MEAN_REVERT + REG_RANGE

### 2.3 VolTarget（波动率目标覆盖）
目的：波动上升自动减仓；EXTREME强力降档
输入：rv_1h/rv_4h、AccountState（liq_distance/margin_used）、RegimeState
规则：
- scale=clamp(rv_target/max(rv_1h,rv_floor),min_scale,1)
- EXTREME/event_window：scale上限更低（更强减仓）
- 杠杆上限由 `strategy.vol_target_max_leverage` 控制；不再写死常量
- 低波动压制：启用 `strategy.vol_target_low_vol_leverage_cap_enabled` 后，
  当年化波动率低于 `vol_target_low_vol_annual_threshold` 时，
  杠杆上限收紧到 `vol_target_low_vol_max_leverage`
- 目标仓位防抖：`vol_target_rebalance_min_abs_usd / vol_target_rebalance_min_ratio`
  可抑制权益/波动率微抖动导致的连续小额调仓
输出：
- suggested_notional_usd = current_notional_usd * (scale - 1.0)（通常负值）
reason_codes：STR_VOL_TARGET_ADJUST + REG_EXTREME/REG_EVENT_WINDOW

## 3. Regime（市场状态识别）
输出：UPTREND/DOWNTREND/RANGE/EXTREME + confidence + reason_codes
MVP最小实现：
- EXTREME：rv_1h突增、点差异常、滑点异常、event_window=true
- 工程抗抖：可通过 `regime.switch_confirm_ticks` 要求新状态连续确认后再切换
- 极端触发模式：可通过 `regime.extreme_requires_both` 选择 jump/vol 的 AND 或 OR 语义
- 成交量尖峰补充触发：`regime.volume_extreme_multiplier`（>1 启用，`event.volume > ewma_volume * multiplier`）
阶段2增强：
- 四态规则完善（均线结构、收益结构、波动结构组合）
原则：
- 宏观/名人/事件不直接做方向预测，优先产生 event_window 风险标签用于降档

## 4. 组合层（Portfolio）固定流水线
1) 信号校验：过期/非法/低置信丢弃
2) 组合加权：raw_notional = Σ(w_i * direction_i * notional_i)
3) Regime scale（阶段2）：不同策略族在不同Regime缩放
4) 风险预算裁剪：cap_notional（按rv、预算、相关性惩罚）
5) 输出 TargetPosition（并记录各策略贡献components用于审计）

## 5. 自进化（Bandit调权，阶段2）
允许变更：策略权重（受控）
硬约束（必须实现）：
- 单策略权重≤60%
- 单次变化≤±5%
- 冷却期（M周期）
- EXTREME：冻结或只下调
必须审计：
- 每次权重变化输出 PORT_WEIGHT_UP/DOWN + 变化幅度 + 原因（贡献/风险/成本）
- 反事实与因子IC协同：当反事实候选未达改进门槛时，可按配置回退到 factor-IC 调权，并记录 fallback 使用情况
- 低成交窗口保护：当反事实路径因 fill 不足不满足更新门槛时，若开启 fallback 则直接转 factor-IC 调权，避免学习链路空转
- 反事实优越性门控：可按 `counterfactual_superiority_*` 配置对“候选-当前”逐tick配对差值做 t-stat 检验，仅在统计显著时允许反事实更新
- 方向一致性防抖：可配置 `min_consecutive_direction_windows`，要求连续 N 个窗口给出同方向结论后才更新；未达门槛会输出 `EVOLUTION_DIRECTION_CONSISTENCY_PENDING`
- 资金费率口径：优先使用行情事件实时 funding（按 interval 折算），缺失时回退 `virtual_funding_rate_per_tick`

**Reward 函数定义 (目标函数)**：
当前支持两种模式：
- 经典 bps 模式（默认）：
$$ R_t = \alpha \cdot \text{pnl\_bps}_t - \beta \cdot \text{drawdown\_bps}_t - \gamma \cdot \text{churn\_bps}_t $$
- Sharpe-like 模式（`objective_use_sharpe_like=true`）：
  以窗口每tick收益与回撤代理的比值作为主项，再叠加回撤/换手惩罚，降低短窗噪声误导。
- 量纲统一：相关项都按账户权益归一化，避免账户规模变化导致目标函数失真
- $\alpha$: 收益项系数
- $\beta$: 回撤惩罚系数
- $\gamma$: 敞口抖动/换手惩罚系数
  - **重要**: `TurnoverCost` 计算必须严格对齐实盘账户的 VIP 费率等级。若模型低估了费率，会导致高频过度交易；若高估了费率，会导致交易过于保守。
  - **成交流动性口径**: maker/taker 归因优先使用交易所成交字段（如 Bybit `isMaker`），仅在缺失时退化为 fee 符号判断，避免因费率结构差异导致分类偏差。
回滚要求：
- Gate失败或线上退化触发回滚；默认恢复到初始化基线权重（可配置为回退到上一锚点）
- `self_evolution.enabled=true` 时，`objective_beta_drawdown` 与 `objective_gamma_notional_churn` 必须大于 0（避免学习目标退化为“仅追逐PnL”）

## 7. 成本门动态化（已落地）
- 入口成本门 `required_edge_bps` 由静态成本 + 动态修正组成：
  - Regime 修正（TREND 放宽、RANGE/EXTREME 惩罚）
  - 波动修正（低波动放宽、高波动惩罚）
  - 流动性修正（maker 占比高放宽、unknown 占比高惩罚）
- 新增 near-miss 容差参数 `entry_gate_near_miss_tolerance_bps`：
  - 允许“略低于 required_edge”的边缘信号进入执行层，减少长期全拦截死锁
  - 可选启用 `entry_gate_near_miss_maker_allow`（仅 maker 且不允许回退 market），用于 demo 环境提升样本流量
  - `entry_gate_near_miss_maker_max_gap_bps` 的语义是“在 tolerance 之上的附加 gap”（不是绝对 gap）
  - 运行态持续输出 `entry_gate.observed_near_miss_ratio / observed_near_miss_allowed_ratio` 与 `execution_window.filtered_cost_near_miss_ratio / passed_cost_near_miss_ratio`
- 新增执行质量硬保护参数：
  - `quality_guard_required_edge_floor_bps`：当执行质量守卫激活时，为 `required_edge_bps` 设置硬下限，防止低边际订单继续放行。
- 新增集中度惩罚参数：
  - `concentration_top1_share_threshold / concentration_penalty_bps / concentration_min_symbols`：
    当持仓集中在单币且超过阈值时，对该币新增入场边际惩罚，降低单币继续加仓概率。
- 所有修正项都进入运行态日志与报告指标，支持闭环验收和参数回调。

## 8. 运行态可观测增强（已落地）
- `RUNTIME_STATUS.concentration`：输出 `top1_share/symbol_count`，用于识别单币过度集中。
- `runtime_assess` 新增软告警：
  - 高 near-miss 拦截占比（提示复核边际估计与容差）
  - 多币场景下 top1 集中度过高（提示复核 Universe 与单币风险预算）
- 执行语义增强：
  - 新增 in-flight 仓位口径：当前仓位可叠加“在途净仓位”，降低 `max_order_notional` 场景下的串行拆单阻塞
  - 同方向在途单由 `max_inflight_orders_per_symbol_direction` 控制；Entry 限额不再被同向 Reduce 错误阻塞，缩短反手链路时延
  - 运行态新增 `rebalance_gap_*` 观测：显式区分“因 min_rebalance 防抖而收敛”与“策略/执行异常未收敛”
  - SL/TP 保护单按条件触发单提交（MarkPrice 触发），避免“挂保护单即瞬时平仓”
  - `OrderIntent` 增加 `liquidity_preference`，非紧急开仓优先 maker，风险收敛单优先 taker
  - Canary 引入 `canary_min_notional_usd`，低于经济阈值时直接抹零，避免粉尘交易
  - Active 引入 `active_min_notional_usd`，低置信度部分接管下的小仓位将直接转空仓，避免粉尘磨损
  - 反手执行支持可选 `execution.direct_flip_entry_enabled`：在单向持仓模式下可直接按净差额发单，降低“先平后开”延迟
  - Integrator 取消“伪造打分 fallback”：模型不可用时统一 `shadow_unavailable` 降级，不修改原策略信号

## 6. 智能筛币协同（新增）
### 6.1 模块职责边界
- UniverseSelector 负责“选什么币交易”（币对集合层决策）
- StrategyEngine 负责“如何交易该币”（方向与仓位层决策）
- RiskEngine 负责“是否允许交易”（硬约束层决策）

### 6.2 协同流程
1. UniverseSelector 每 1h（可配置）输出 `active_symbols`
2. StrategyEngine 仅在 `active_symbols` 上计算并输出 Signal
3. Portfolio 按账户预算在 `active_symbols` 间分配仓位
4. Risk/Execution 做最终约束与执行

### 6.3 降级规则
- 若 UniverseSelector 失败，使用 `fallback_symbols` 并审计 `UNIVERSE_SELECTOR_DEGRADED`
- 若 `active_symbols` 为空且 fallback 也不可用，触发 Gate `FAIL_EMPTY_UNIVERSE`
