# AI 自闭环实现路径（先跑通，再优化）

## 1. 目标与优先级

当前执行顺序固定为两步：
1. 先确保自闭环流程稳定可运行（可持续执行、可验收、可审计）。
2. 再基于运行报告做工程优化（按数据驱动，不凭感觉改参数）。

本文件对应当前仓库实现（`tools/closed_loop_runner.sh` + `docker-compose.prod.yml` + `ops/watchdog.py`）。

## 2. P0：先把自闭环跑起来

### 2.1 最小前置条件

- 目录：代码部署目录存在（建议 `/opt/ai-trade`）。
- 环境文件：`/opt/ai-trade/.env.runtime` 存在，至少包含：
  - `AI_TRADE_BYBIT_DEMO_API_KEY`
  - `AI_TRADE_BYBIT_DEMO_API_SECRET`
- 可选但建议设置：
  - `AI_TRADE_IMAGE`（未设置时默认 `ai-trade:latest`）
  - `AI_TRADE_RESEARCH_IMAGE`（未设置时默认 `ai-trade-research:latest`）
  - `AI_TRADE_PROJECT_DIR=/opt/ai-trade`（用于 scheduler 二次 compose 路径对齐）
  - `AI_TRADE_ENV_FILE=.env.runtime`（scheduler 读取的 env 文件名）

### 2.2 启动顺序（生产）

```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a

# 建议固定绝对路径，避免 Docker socket 二次 compose 时路径漂移
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime

# 启动交易主服务 + 看门狗 + 调度器
# scheduler 会周期执行 full（train + assess）
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d ai-trade watchdog scheduler
```

### 2.3 首次验收（必须执行）

```bash
# 1) 运行态健康
docker ps --format 'table {{.Names}}\t{{.Status}}' | rg 'ai-trade|ai-trade-watchdog|ai-trade-scheduler'

# 2) 看门狗日志（应看到 All systems operational）
docker logs --tail 200 ai-trade-watchdog

# 3) 调度器日志（应看到 closed loop full 执行记录）
docker logs --tail 200 ai-trade-scheduler

# 4) 报告产物（固定入口）
ls -lah data/reports/closed_loop/latest_closed_loop_report.json
ls -lah data/reports/closed_loop/latest_runtime_assess.json
ls -lah data/reports/closed_loop/latest_run_meta.json
```

### 2.4 P0 通过标准

- `ai-trade`、`ai-trade-watchdog`、`ai-trade-scheduler` 持续运行无频繁重启。
- `latest_runtime_assess.json` 有有效 `verdict`。
- `latest_closed_loop_report.json` 可解析且包含 `overall_status`。
- 近 24h 至少产生一次完整 run 目录：`data/reports/closed_loop/<UTC_RUN_ID>/`。

### 2.5 常见失败与定位

- `scheduler` 报路径错误：优先检查 `AI_TRADE_PROJECT_DIR` 是否为宿主机绝对路径。
- `watchdog` 无法检查容器：检查 `/var/run/docker.sock` 挂载与权限。
- `full` 失败但服务存活：先看 `ai-trade-scheduler` 日志，再看本次 run 目录内 `runtime.log` 与 `runtime_assess.json`。
- research 相关失败：检查 `AI_TRADE_RESEARCH_IMAGE` 是否可拉取且包含 `tools/*` 依赖。

### 2.6 `docker-compose.yml` vs `docker-compose.prod.yml`（闭环相关）

| 维度 | `docker-compose.yml`（开发） | `docker-compose.prod.yml`（生产） |
| --- | --- | --- |
| `ai-trade` 来源 | 本地 `build` | `AI_TRADE_IMAGE` 预构建镜像 |
| `ai-trade-research` 来源 | 本地 `Dockerfile.research` 构建 | `AI_TRADE_RESEARCH_IMAGE`（`profile: research`） |
| 自闭环常驻服务 | 无 `scheduler/watchdog` | 内置 `scheduler` + `watchdog` |
| 数据卷路径策略 | 直接 `./...` | `AI_TRADE_PROJECT_DIR` + 宿主绝对路径对齐 |
| 推荐用途 | 本地开发与调试 | 部署后持续闭环运行 |

规则：
- 本地调试 `train/assess/full` 可直接用 `docker-compose.yml`。
- 线上持续闭环必须使用 `docker-compose.prod.yml`，并固定 `AI_TRADE_PROJECT_DIR`。

### 2.7 CI/CD 强闭环（默认开启）

`main` 分支 CD 现在是“部署 + 运行态闭环门禁”双门槛，顺序如下：
1. Build/Test 通过后推送镜像。
2. ECS 部署新镜像并等待 `ai-trade` 健康检查。
   - 默认先停止 `watchdog`、`scheduler`，仅启动 `ai-trade` 做门禁。
   - 门禁通过后再拉起 `watchdog`、`scheduler`。
3. 健康后立即执行 `tools/closed_loop_runner.sh assess`（默认 `DEPLOY + 30m`）。
4. 仅当以下条件同时满足才判定部署成功：
   - `data/reports/closed_loop/latest_runtime_assess.json` 的 `verdict=PASS`
   - `data/reports/closed_loop/latest_closed_loop_report.json` 的 `overall_status=PASS`
5. 任一条件不满足，自动回滚到上一个镜像并使 CD 失败。
6. CD 自动回传 `latest_closed_loop_report.json` / `latest_runtime_assess.json` / `latest_run_meta.json` 为 artifact，便于审计留痕。

可通过仓库 `Actions Variables` 调整门禁参数：
- `CLOSED_LOOP_ENFORCE`（默认 `true`）
- `CLOSED_LOOP_ACTION`（默认 `assess`）
- `CLOSED_LOOP_STAGE`（默认 `DEPLOY`）
- `CLOSED_LOOP_SINCE`（默认 `30m`）
- `CLOSED_LOOP_MIN_RUNTIME_STATUS`（默认空，使用阶段内置阈值）
- `CLOSED_LOOP_OUTPUT_ROOT`（默认 `/opt/ai-trade/data/reports/closed_loop`）
- `CLOSED_LOOP_STRICT_PASS`（默认 `true`）
- `DEPLOY_SERVICES`（默认 `ai-trade watchdog scheduler`）
- `GATE_DEFER_SERVICES`（默认 `watchdog scheduler`）

可通过运行环境变量调整 S5 自学习门禁力度（`closed_loop_runner.sh`）：
- `CLOSED_LOOP_VERIFY_S5_EVOLUTION_SWITCHES`（默认 `true`；校验 `use_virtual_pnl + factor-IC + learnability` 已启用）
- `CLOSED_LOOP_REQUIRE_S5_FACTOR_IC_ACTION`（默认 `false`；强制要求 factor-IC 有实际调权动作）
- `CLOSED_LOOP_REQUIRE_S5_LEARNABILITY_ACTIVITY`（默认 `false`；强制要求 learnability 有 pass/skip 活动）

### 2.8 控制平面（`ai-trade-web`，phase-1 只读）

目标：在不影响交易主链路的前提下，统一查看报告/模型/配置基线。

启动（开发环境）：

```bash
docker compose --profile web up -d ai-trade-web
```

启动（生产环境）：

```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
docker compose -f docker-compose.prod.yml --env-file .env.runtime --profile web up -d ai-trade-web
```

默认 API：
- `GET /healthz`
- `GET /api/v1/reports/latest`
- `GET /api/v1/reports/runs`
- `GET /api/v1/models/active`
- `GET /api/v1/config/profiles`

说明：
- 控制平面支持只读与治理写入双模式：默认只读；开启 `AI_TRADE_WEB_ENABLE_WRITE=true` 后可执行草稿/校验/发布/回滚。
- `ai-trade-web` 通过 profile 启动，默认不参与闭环关键路径，不影响 deploy gate。
- 趋势看板（`Strategy / Execution Trends`）默认包含：
  - `self_evolution_action_count`
  - `self_evolution_virtual_action_count`
  - `self_evolution_counterfactual_action_count`
  - `self_evolution_counterfactual_update_count`
  - `self_evolution_factor_ic_action_count`
  - `self_evolution_learnability_skip_count`
  - `flat_start_rebase_applied_count`
  - `integrator_policy_applied_ratio`
  - `order_filtered_cost_count`
  - `reconcile_mismatch_count`
  - `equity_change_pct / max_drawdown_pct_observed`

### 2.9 参数治理（phase-B）

在控制平面开启写入前，必须明确以下安全约束：

1. 显式开启写入：`AI_TRADE_WEB_ENABLE_WRITE=true`。
2. 配置管理员令牌：`AI_TRADE_WEB_ADMIN_TOKEN=<strong-token>`。
3. 默认发布保护：`AI_TRADE_WEB_REQUIRE_LATEST_PASS=true`，仅当 latest 运行验收通过时允许发布。
4. 生产环境建议仅内网访问控制平面端口（`AI_TRADE_WEB_BIND_ADDRESS=127.0.0.1` + 反向代理白名单）。

核心治理 API：
- `PATCH /api/v1/governance/state`（只读锁、冻结发布、发布保护开关）
- `POST /api/v1/config/drafts`（创建草稿）
- `GET /api/v1/config/drafts/{draft_id}/preview`（发布前变更预览与风险提示）
- `POST /api/v1/config/drafts/{draft_id}/validate`（草稿校验）
- `POST /api/v1/config/drafts/{draft_id}/approve`（高风险草稿审批）
- `POST /api/v1/config/drafts/{draft_id}/publish`（发布；必须携带 `preview_digest + confirm_phrase` 二次确认）
- `POST /api/v1/config/rollback`（按备份回滚）
- `GET /api/v1/governance/audit`（操作审计）

高风险发布治理（phase-C）：
- `high_risk_two_man_rule=true` 时，高风险变更必须至少 `high_risk_required_approvals` 个不同 actor 审批后才可发布。
- 高风险审批后需等待 `high_risk_cooldown_seconds` 冷却时间后才可发布。
- 控制台流程固定为：`Preview -> Approve -> Confirm Phrase -> Publish`。

## 3. P1：基于运行报告做优化

### 3.1 优化输入只认报告

每轮优化前先读取：
- `data/reports/closed_loop/latest_closed_loop_report.json`
- `data/reports/closed_loop/latest_runtime_assess.json`
- `data/reports/closed_loop/latest_run_meta.json`

核心观察维度：
- 运行态：`overall_status`、`runtime_verdict`、Gate fail 原因。
- 资金结果：`account_outcome.equity_change_pct`、`max_drawdown_pct_observed`。
- 执行质量：成交活跃度、节流命中率、`reduce_only/gate_halted` 触发情况。
- S5 强闭环阻断：`runtime_assess` 需满足“至少 1 个 `GATE_CHECK_PASSED` + 平仓起跑口径”；
  若窗口起点非平仓，会自动重定位到首个 `abs_notional <= 50` 的样本继续评估，并在指标中记录 `flat_start_rebase_applied_count=1`；
  若无可重定位样本则 FAIL。

### 3.2 优化节奏（建议周循环）

1. 固定 3-7 天窗口收集闭环报告。
2. 仅选择一个主问题进入迭代（例如高回撤或低活跃）。
3. 小步改动（参数/策略/执行其一），保持可归因。
4. 再跑一轮 `assess/full`，对比关键指标再决定保留或回滚。

## 4. 代码与文档一致性对齐

### 4.1 当前实现基线（必须与文档一致）

- 调度脚本：`tools/closed_loop_runner.sh`
- 产物回收脚本：`tools/recycle_artifacts.sh`
- 生产编排：`docker-compose.prod.yml`
- 本地编排：`docker-compose.yml`
- 看门狗：`ops/watchdog.py`
- 定时任务模板：`ops/cron/install_closed_loop_cron.sh`、`ops/cron/closed-loop.cron.example`

### 4.2 对齐规则

- 任何 `docker-compose.prod.yml` 的路径/变量调整，必须同步更新：
  - `README.md`
  - `docs/配置手册.md`
  - `.env.example`
- 任何 `closed_loop_runner.sh` 参数变化，必须同步更新：
  - `README.md` 闭环示例
  - `docs/开发指南.md` 与 `docs/配置手册.md`
- 合并前至少执行一次：
  - `docker compose -f docker-compose.yml config`
  - `AI_TRADE_IMAGE=dummy docker compose -f docker-compose.prod.yml --profile research config`

## 5. 近期执行清单

- [ ] 在目标环境完成 P0 启动与首次验收。
- [ ] 固定收集 3-7 天报告样本。
- [ ] 输出首轮优化项（仅 1-2 项，保持小步可回滚）。
- [ ] 每次改动后执行文档对齐检查。
- [ ] 验证磁盘治理链路：`recycle_artifacts`（报告/日志） + `docker_gc`（镜像层/构建缓存）。
