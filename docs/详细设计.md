# 系统详细设计（TRD）

## 1. 目的
定义系统实现级设计：模块接口、线程模型、状态机、存储一致性、错误处理、测试与发布约束。

## 2. 总体实现原则
- 单写者原则：Risk/OMS/AccountState 由单线程（Actor）串行处理。
- 事件不可变：跨模块只传递不可变事件对象。
- 先审计再执行：关键决策与执行动作必须有 reason_codes。
- 幂等优先：订单重试使用同一 client_order_id。

## 3. 目录与模块映射
- `src/core`：Config/Log/EventBus/Clock/Version
- `src/exchange`：交易所适配（REST/WS、签名、规则缓存）
- `src/market`：行情聚合与快照（来自 exchange 输入）
- `src/universe`：UniverseSelector（智能/AI筛币）
- `src/strategy`：StrategyEngine + 基础特征计算 + 插件策略
- `src/regime`：RegimeEngine
- `src/system`：交易主编排（组合层/执行链路调度）
- `src/risk`：RiskEngine
- `src/execution`：ExecutionEngine
- `src/oms`：OrderFSM + AccountState + Reconcile
- `src/storage`：WAL/快照持久化
- `src/monitor`：Metrics/Audit/GateReporter
- `src/evolution`：自进化控制器（阶段2双权重链路）
- `src/app`：应用装配与进程生命周期管理
- `src/research`（规划）：Miner 离线因子挖掘
- `src/model`（规划）：Integrator 训练/推理与模型版本管理

## 4. 模块接口（核心）
### 4.1 UniverseSelector -> Downstream
```cpp
struct SymbolScore {
  std::string symbol;
  double score;
  std::vector<std::string> reason_codes;
};

struct UniverseSnapshot {
  EventHeader header;
  std::vector<std::string> active_symbols;
  std::vector<SymbolScore> symbol_scores;
  bool degraded_to_fallback;
  std::vector<std::string> reason_codes;
};
```

约束：
- `active_symbols` 不能为空（否则触发 FAIL_EMPTY_UNIVERSE）；
- 每个 active symbol 必须在交易所可交易列表与风控白名单交集内；
- 降级到 fallback 时必须写审计 `UNIVERSE_SELECTOR_DEGRADED`。

### 4.2 Strategy -> Portfolio
```cpp
struct Signal {
  EventHeader header;
  std::string strategy_id;
  double suggested_notional_usd; // signed
  int direction;                 // must match notional sign
  double confidence;
  int64_t valid_until_ms;
  std::vector<std::string> reason_codes;
};
```

### 4.3 Portfolio -> Risk
```cpp
struct TargetPosition {
  EventHeader header;
  double target_notional_usd;
  std::vector<Component> components;
  std::vector<std::string> reason_codes;
};
```

### 4.4 Risk -> Execution
```cpp
struct RiskAdjustedPosition {
  EventHeader header;
  double adjusted_notional_usd;
  RiskMode risk_mode;
  std::vector<std::string> reason_codes;
};
```

### 4.5 Execution -> OMS
```cpp
struct OrderIntent {
  EventHeader header;
  std::string intent_id;
  std::string strategy_id; // 用于审计追踪
  std::string symbol;
  Side side;
  double qty;
  double price;
  bool reduce_only;
  std::vector<std::string> reason_codes;
};
```

### 4.6 Exchange Account Snapshot（Bybit门禁）
```cpp
struct ExchangeAccountSnapshot {
  AccountMode account_mode;   // CLASSIC / UNIFIED
  MarginMode margin_mode;     // ISOLATED / CROSS / PORTFOLIO
  PositionMode position_mode; // ONE_WAY / HEDGE
};
```
启动流程要求：
- 连接交易所后必须读取账户快照；
- Bybit 模式下，若与配置期望不一致（如非逐仓），直接拒绝启动。
- MVP 实现补充：
  - 通过 `Public WS + Private WS` 完成实盘最小闭环：
    `tickers(ws) -> signal -> order/create(rest) -> execution(ws) -> fill`
  - 已实现双通道降级兜底：
    - 行情：`Public WS -> /v5/market/tickers`
    - 成交：`Private WS -> /v5/execution/list`

### 4.7 Stage3 规划接口（因子-模型-风控闭环前两级）
```cpp
struct FactorDefinition {
  std::string factor_id;
  std::string expression;
  double fitness_ic_train;
  double fitness_ic_oos;
  double complexity_score;
  std::string factor_set_version;
};

struct ModelScore {
  EventHeader header;
  std::string model_version;
  std::string feature_schema_version;
  double score;
  double p_up;
  double p_down;
  std::vector<std::string> reason_codes; // MODEL_* + REG_*
};
```

约束：
- `FactorDefinition`/`ModelScore` 默认只进入审计和影子链路；
- 接入真实交易决策前，必须通过 Gate 的 R1/R2/R3 阶段验收；
- `ModelScore` 不得绕过 `RiskEngine` 和 `GateMonitor` 的一票否决。

## 5. 关键状态机
### 5.1 风控状态机
- `NORMAL -> DEGRADED -> COOLDOWN -> FUSE`
- 任何状态可因 `trade_ok=false` 进入 `REDUCE_ONLY`
- **FUSE 特殊状态**: 进入 FUSE 后，若存在无法平仓的尘埃仓位，标记为 `DUST_LOCKED`。此状态下禁止加仓，仅允许通过 `Force Unlock Symbol` 人工解除。

### 5.2 订单状态机（允许转移）
- `NEW -> SENT`
- `SENT -> ACK | REJECTED | CANCELLED`
- `ACK -> PARTIAL | FILLED | CANCELLED | REJECTED`
- `PARTIAL -> PARTIAL | FILLED | CANCELLED | REJECTED`
- 终态：`FILLED/CANCELLED/REJECTED`

## 6. 线程与并发模型
- 线程组：
  - IO线程池：Exchange WS/REST
  - 计算线程池：Feature/Regime/Strategy
  - 单写者线程：Portfolio/Risk/Execution/OMS
- 通信：无锁队列（RingBuffer）+ 背压水位。
- 顺序保证：单 symbol 在单写者线程内顺序处理。

## 7. 存储一致性设计
### 7.1 存储分层
- Snapshot：周期状态快照（AccountState/StrategyState）
- WAL：关键事件（OrderIntent/OrderEvent/FillEvent/RiskAction/ConfigChange）
- Archive（可选）：全量行情与特征用于离线分析

### 7.2 一致性语义
- 关键动作采用“先 WAL 持久化，再执行外部动作”。
- `client_order_id` 首次生成后持久化到 WAL。
- 恢复流程：Load Snapshot -> Replay WAL(seq) -> Reconcile REST。

### 7.3 去重与重放
- 幂等键：`client_order_id`
- 去重键：`exchange_order_id + status_version`
- 回放幂等：若 intent 已执行完成，重放时只补状态不重下单。

## 8. 执行与保护单实现细节
### 8.1 普通执行
- `delta = target - current`
- 受限于 `max_order_notional`、`min_notional`、`step_size/tick_size`
- **幽灵仓位修正**: 若 `abs(target) < min_notional` 且 `target != 0`，强制修正 `target = 0`，防止因“买不起”导致的死循环。
- `COOLDOWN/REDUCE_ONLY` 仅允许净减仓

### 8.2 可选保护单（SL优先，TP次之）
- 开关：`execution.protection.enabled`
- 开仓后 `attach_timeout_ms` 内必须挂 SL（`require_sl=true`）
- TP 可选（`enable_tp=true`）
- 语义：
  - SL 与 TP 同时触发时，SL 优先
  - 一侧成交后撤销另一侧（OCO）
- 降级：
  - SL 失败：触发 `EXEC_PROTECTIVE_ORDER_MISSING` + `REDUCE_ONLY/冻结symbol`
  - TP 失败：记录 `EXEC_TP_ATTACH_FAILED` 并继续管理仓位

## 9. 风险与组合实现细则
### 9.1 权重约束
- `0 <= w_i <= 0.6`
- `sum(w_i)=1`（容差 `1e-6`）
- 单策略降级模式：`active_strategy_count=1` 可 `w=1.0`（审计）

### 9.2 Regime 映射一致性
- 在 `RegimeEngine` 初始化时，校验配置中的 `regime_bucket_mapping` 是否完整覆盖四态。
- 校验所有 bucket 值是否在 `regime_buckets` 定义列表中。

### 9.3 自进化触发门槛（当前实现）
- 评估周期：`tick % max(update_interval_ticks, min_update_interval_ticks) == 0`
- 更新步长：`abs(delta_weight) <= max_weight_step`
- 回滚触发：连续 `rollback_degrade_windows` 个窗口满足
  - `objective_score <= rollback_degrade_threshold_score`
- 回滚后冷却：`rollback_cooldown_ticks` 内仅评估不更新

### 9.4 Gate 活跃度门槛
- `effective_signals_per_day >= min_effective_signals_per_day`
- `fills_per_day >= min_fills_per_day`

### 9.5 AccountState 多仓位模型
- 账户状态使用 `unordered_map<symbol, PositionState>` 维护各币对持仓；
- `current_notional_usd()` 返回账户总名义值，`current_notional_usd(symbol)` 返回单币对名义值；
- 权益与回撤在账户维度统一计算，避免“单币对状态误代表全账户”。

### 9.6 UniverseSelector 选择逻辑（新增）
- 候选池来源：`configured_candidates ∩ exchange_instruments`
- 评分特征（最小集）：成交额、点差、波动率、资金费率/交易成本
- 选择流程：
  - 过滤（交易规则、风控白名单、最小流动性）
  - 打分排序
  - 约束截断（`max_active_symbols`、行业/相关性上限）
  - 输出 `UniverseSnapshot`
- 稳定性约束：
  - 连续窗口集合变动率不得超过 `universe_turnover_cap`
  - 超限时优先保留上一窗口高分标的
- 失效降级：
  - 打分失败或输入缺失时使用 `fallback_symbols`
  - 若 fallback 仍为空，则触发 Gate `FAIL_EMPTY_UNIVERSE`

## 10. 错误码与审计码（最小集）
- 执行：
  - `EXEC_FILTER_IGNORE`
  - `EXEC_DUST_POSITION_STUCK` (FUSE时尘埃仓残留)
  - `EXEC_RATE_LIMIT_BACKOFF`
  - `EXEC_ORDER_REJECT_DEGRADE`
  - `EXEC_PROTECTIVE_ORDER_MISSING`
  - `EXEC_TP_ATTACH_FAILED`
- 风险：
  - `RISK_DATA_GAP_DOWNGRADE`
  - `RISK_TRADE_DISCONNECT_REDUCE_ONLY`
  - `RISK_IMMUTABLE_GUARD` (尝试修改硬风控参数)
- 组合/学习：
  - `PORT_WEIGHT_INVALID_REJECTED`
  - `PORT_SINGLE_STRATEGY_MODE`
  - `EVOLUTION_WEIGHT_INCREASE_TREND`
  - `EVOLUTION_WEIGHT_DECREASE_TREND`
  - `EVOLUTION_ROLLBACK_TRIGGERED`
  - `EVOLUTION_COOLDOWN_ACTIVE`
- OMS：
  - `OMS_RECONCILE_MISMATCH`

## 11. 配置映射（关键）
- `risk.*`：硬风控参数，禁热更新
- `universe.*`：筛币候选、过滤阈值、打分权重与降级策略
- `self_evolution.*`：当前实现为双策略权重更新/回滚约束（不含复杂模型训练）
- `research.*`（规划）：Miner 搜索空间、算子白名单、历史样本窗口
- `integrator.*`（规划）：CatBoost 时序切分、模型版本、影子推理开关
- `gate.*`：活跃度门槛
- `execution.protection.*`：保护单开关与参数

## 12. 测试设计
### 12.1 单元测试
- 风控状态机转移
- UniverseSelector 候选过滤与打分排序
- 权重约束校验
- 订单状态机转移合法性
- `client_order_id` 幂等与持久化

### 12.2 集成测试
- Replay：固定样本回放一致性
- Paper/Sim：限频、拒单、部分成交、断连重连
- WS异常与恢复：Private/Public WS 断连后自动回退 REST
- 成交去重：WS/REST 重复 `execId` 不重复入账
- WAL恢复：重启后 `Load Snapshot -> Replay WAL -> Reconcile` 闭环一致
- UniverseSelector：降级到 fallback、空集合触发 FAIL
- 保护单：SL挂单超时降级、TP失败可审计、OCO撤销
- Stage3 规划链路：Rolling/TimeSeriesSplit 防前视偏差校验、影子推理可观测性校验

### 12.3 Gate验收
- KRI 一票否决
- 活跃度门槛
- 回滚演练

## 13. 发布与回滚流程
- 发布前：Replay PASS + Sim PASS + Shadow PASS
- 发布中：灰度限额（symbol/仓位）
- 发布后：连续劣化自动回滚到上一稳定快照

## 14. 版本与追溯
每次发布必须记录：
- `config_version`
- `strategy_bundle_version`
- `regime_version`
- `git_commit`
