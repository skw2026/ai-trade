# 事件契约与字段规范（可回放/可回归的核心）

## 1. 通用字段规范（所有事件必带）
- event_id：全局唯一（uuid或雪花）
- seq：单进程递增序列（用于回放顺序）
- ts_local_ms：本地时间戳（毫秒）
- ts_exchange_ms：交易所时间戳（若事件来自交易所）
- symbol：BTC/ETH/SOL 永续标的（规范化，如 BTCUSDT_PERP）
- version_set：
  - config_version
  - strategy_bundle_version（策略集合版本）
  - regime_version
  - git_commit（可选）
- reason_codes[]：非空（关键决策事件必须）

#### C++ 定义参考
```cpp
struct EventHeader {
    std::string event_id;
    uint64_t seq;
    int64_t ts_local_ms;
    int64_t ts_exchange_ms;
    std::string symbol;
    struct VersionSet {
        std::string config_ver;
        std::string strategy_ver;
    } version;
    
    // 序列化宏 (nlohmann/json)
    // NLOHMANN_DEFINE_TYPE_INTRUSIVE(EventHeader, event_id, seq, ts_local_ms, ...)
};
```

## 2. 关键事件类型（最小集）
### 2.1 MarketEvent
用途：行情输入（可回放）
字段要点：
- type：BOOK_TICKER / TRADE / MARK_PRICE / FUNDING / KLINE（可选）
- payload：最小包含 best_bid/ask、mark_price、last_trade（按type）

### 2.2 FeatureSnapshot
用途：策略与Regime输入快照（可复现）
字段要点：
- timeframe：5m（主）
- features：
  - ema_fast, ema_slow, ma_slope
  - atr_5m
  - rv_1h
  - breakout_high_N, breakout_low_N
  - zscore（阶段2）
- features_hash：用于回归一致性校验

### 2.3 RegimeState
字段要点：
- regime：UPTREND/DOWNTREND/RANGE/EXTREME
- confidence：0..1
- flags：event_window(bool)
- reason_codes：REG_*

### 2.4 Signal（策略输出）
强制口径：
- suggested_notional_usd（唯一敞口口径）
字段要点：
- signal_type：TARGET_POSITION / RISK_ONLY
- direction：-1/0/1
- strength/confidence：0..1
- valid_until_ms：过期即丢弃
- risk_hint：max_leverage_suggested、allow_add_position、urgency
- reason_codes：STR_* + REG_*（至少一个）

#### C++ 定义参考
```cpp
struct Signal {
    EventHeader header;
    std::string strategy_id;
    double suggested_notional_usd; // 核心输出
    int direction;                 // 1, -1, 0
    double confidence;             // 0.0 - 1.0
    int64_t valid_until_ms;
    std::vector<std::string> reason_codes;
};
```

### 2.5 TargetPosition（组合层输出）
字段要点：
- target_notional_usd（组合后的目标敞口）
- components：每个策略的贡献（可选但强烈建议，用于审计）
  - strategy_id
  - weight
  - contributed_notional_usd
- reason_codes：PORT_* +（继承部分STR/REG）

### 2.6 RiskAction / RiskAdjustedPosition（风控输出）
RiskAction：
- action_type：DOWNGRADE/REDUCE/COOLDOWN/FUSE/REDUCE_ONLY/FREEZE_SYMBOL/UNFREEZE_SYMBOL
- severity：1..5
- details：触发阈值、目标恢复条件等
RiskAdjustedPosition：
- adjusted_notional_usd
- risk_mode：NORMAL/DEGRADED/COOLDOWN/FUSE/REDUCE_ONLY
- reason_codes：RISK_*

#### C++ 定义参考
```cpp
enum class RiskMode { NORMAL, DEGRADED, COOLDOWN, FUSE, REDUCE_ONLY };

struct RiskAdjustedPosition {
    EventHeader header;
    double adjusted_notional_usd;
    RiskMode risk_mode;
    std::vector<std::string> active_limits; // 触发的风控规则
};
```

### 2.7 OrderEvent / FillEvent（执行与成交）
OrderEvent：
- client_order_id（幂等关键）
- side、type、qty、price、tif
- state：SENT/ACK/REJECT/CANCELLED/FILLED/PARTIAL
FillEvent：
- fill_qty、fill_price、fee、slippage_bps（可计算）

## 3. 幂等与时序规则
- client_order_id 生成规则：{symbol}-{ts_local_ms}-{seq}-{intent_hash}
- 重试必须使用同一个 client_order_id
- 回放时以 seq 排序重建处理顺序
- 任一模块输出必须可由输入事件复现（至少在同版本、同配置下）

## 4. reason_codes 规范
- 必须：每个“决策事件”（Regime/Signal/Target/RiskAction/OrderIntent）reason_codes 非空
- 统一前缀：STR_/REG_/PORT_/RISK_/EXEC_/OMS_
- 禁止：随意字符串；必须来自受控枚举表（配置/代码共享）
