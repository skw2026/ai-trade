# 配置手册 (Configuration)

系统严格遵循“配置驱动”原则。所有风控阈值、策略参数必须显式定义。

## 配置文件结构 (YAML)

```yaml
system:
  id: "bot-v1-prod"
  mode: "paper" # live, paper, replay
  log_level: "info"
  data_path: "./data"
  webhook_url: "${AI_TRADE_WEBHOOK_URL}" # Slack/DingTalk/Telegram 告警地址
  
exchange:
  platform: "binance_perp"
  api_key: "${AI_TRADE_API_KEY}" # 从环境变量读取
  api_secret: "${AI_TRADE_API_SECRET}"
  testnet: true
  timeout_ms: 2000
  rate_limit_buffer: 0.9 # 达到限频 90% 时主动降速

# ==========================================
# 硬风控配置 (Hard Risk Rules) - 核心保护层
# ==========================================
risk:
  # 账户级回撤控制
  max_drawdown:
    degraded_threshold: 0.08  # 8% -> 降档
    cooldown_threshold: 0.12  # 12% -> 强减仓
    fuse_threshold: 0.20      # 20% -> 熔断
  
  # 强平距离保护
  liquidation:
    min_distance_p95: 0.08    # 强平距离 < 8% 触发强减
    target_restore: 0.10      # 恢复目标

  # 杠杆限制 (白名单)
  leverage_limits:
    BTCUSDT: 3
    ETHUSDT: 3
    SOLUSDT: 2
    DEFAULT: 0 # 禁止其他币种

  # 极端行情保护
  extreme_market:
    force_leverage: 1         # 极端行情强制 1x
    allow_open: false         # 禁止开新仓

# ==========================================
# 策略配置
# ==========================================
strategy:
  active_strategies: ["trend_v1", "vol_target_v1"]
  
  # 组合层配置
  portfolio:
    max_leverage_total: 2.5
    rebalance_threshold: 0.02 # 偏离 2% 才调仓 (防磨损)

  # 策略具体参数
  params:
    trend_v1:
      ema_fast: 12
      ema_slow: 26
      atr_period: 14
      weight_cap: 0.6
    
    vol_target_v1:
      target_vol: 0.40 # 年化波动率目标 40%
      lookback_hours: 24

# ==========================================
# 自进化配置 (Self Evolution)
# ==========================================
self_evolution:
  enabled: true
  update_interval_minutes: 60        # 默认每1h评估一次
  min_decision_epochs: 200           # 决策样本门槛（含空仓周期）
  min_fills_for_update: 20           # 成交样本门槛（避免零交易误更新）
  improvement_threshold: 0.02        # 标准化相对提升门槛（默认2%）
  improvement_metric: "relative"     # (J_new-J_base)/max(abs(J_base),eps)
  cooldown_hours: 6                  # 连续两次更新最小间隔
  rollback_freeze_hours: 24          # 回滚后暂停学习窗口

  objective:
    alpha_pnl_net: 1.0
    beta_drawdown: 2.0
    gamma_turnover_cost: 1.0
    delta_tail_risk: 1.5

  learning_windows:
    - days: 7
      weight: 0.5
    - days: 30
      weight: 0.3
    - days: 90
      weight: 0.2

  regime_buckets: ["TREND", "RANGE", "EXTREME"]
  regime_bucket_mapping:
    UPTREND: TREND
    DOWNTREND: TREND
    RANGE: RANGE
    EXTREME: EXTREME

  safety:
    max_single_strategy_weight: 0.6  # 单策略上限
    max_weight_step: 0.05            # 单次权重变化<=±5%
    enforce_non_negative_weights: true
    enforce_weight_sum_one: true      # 活跃策略权重和必须为1
    weight_sum_tolerance: 1e-6
    allow_single_strategy_full_weight: true # 单策略降级模式允许w=1.0
    extreme_reduce_only: true        # EXTREME下仅允许降风险

gate:
  min_effective_signals_per_day: 24  # 最小活跃信号门槛
  min_fills_per_day: 4               # 最小成交门槛

# ==========================================
# 执行引擎配置
# ==========================================
execution:
  max_order_notional: 50000 # 单笔最大金额
  max_slippage_bps: 20      # 最大允许滑点 (基点)
  order_timeout_ms: 10000   # 订单超时时间
  retry_policy:
    max_attempts: 3
    backoff_ms: 500
```

## 环境变量

为了安全，敏感信息不应直接写入 YAML 文件：

- `AI_TRADE_API_KEY`
- `AI_TRADE_API_SECRET`
- `AI_TRADE_WEBHOOK_URL` (用于告警)

## 配置加载逻辑

> **注意**: 风控参数 (`risk.*`) 不支持热加载。修改风控参数必须重启进程，以防止运行时意外修改导致风控失效。

1. 加载默认硬编码配置 (Safe Defaults)。
2. 加载 YAML 配置文件。
3. 加载环境变量覆盖。
4. **校验**: 
   - 检查风控参数是否宽松于硬编码限制（如 YAML 设置熔断为 50%，系统应拒绝启动）。
   - 检查 API Key 格式。
   - 检查自进化配置合法性（窗口权重和=1、步长和冷却期边界、Regime桶合法）。
   - 检查学习更新门槛（`min_decision_epochs` 与 `min_fills_for_update`）不为0。
   - 检查提升阈值口径（`improvement_metric=relative`）与阈值范围。
   - 检查权重约束（`0<=w_i<=max_single_strategy_weight`、权重和=1）。
   - 检查单策略特例：仅在 `active_strategies=1` 且 `allow_single_strategy_full_weight=true` 时允许 `w=1.0`。
   - 检查 Regime 映射完整性（四态必须全部覆盖，且值只能在 `regime_buckets` 内）。
   - 检查学习模块写入边界：禁止任何 `risk.*` 字段被学习结果覆盖。
