# 配置手册 (Configuration)

系统严格遵循“配置驱动”原则。所有风控阈值、策略参数必须显式定义。

Bybit V5 参考：<https://bybit-exchange.github.io/docs/v5/guide>

## 配置文件结构 (YAML)

```yaml
system:
  id: "bot-v1-prod"
  mode: "paper" # live, paper, replay
  primary_symbol: "BTCUSDT"
  log_level: "info"
  data_path: "./data"
  max_ticks: 0                    # 0=持续运行；>0=达到tick数后退出
  status_log_interval_ticks: 20   # 运行状态日志周期；0=关闭
  remote_risk_refresh_interval_ticks: 10 # 远端风险字段刷新周期；0=关闭
  reconcile:
    enabled: true
    interval_ticks: 10
    tolerance_notional_usd: 5.0
    mismatch_confirmations: 2      # 连续N次对账不一致才触发halt（防瞬时抖动）
    pending_order_stale_ms: 30000  # 在途净仓位订单超时阈值（ms）
  webhook_url: "${AI_TRADE_WEBHOOK_URL}" # Slack/DingTalk/Telegram 告警地址
  
exchange:
  platform: "bybit"
  api_key: "${AI_TRADE_API_KEY}" # 从环境变量读取
  api_secret: "${AI_TRADE_API_SECRET}"
  bybit:
    testnet: true
    demo_trading: false            # true=Bybit Demo Trading（主网模拟盘）
    category: "linear"
    account_type: "UNIFIED"           # 对应 wallet-balance accountType
    expected_account_mode: "UNIFIED"  # 账户门禁：UNIFIED/CLASSIC
    expected_margin_mode: "ISOLATED"  # ISOLATED/CROSS/PORTFOLIO
    expected_position_mode: "ONE_WAY" # ONE_WAY/HEDGE
    public_ws_enabled: true           # 行情通道优先使用 Public WS
    public_ws_rest_fallback: true     # Public WS 不可用时回退 REST market/tickers
    private_ws_enabled: true          # 成交通道优先使用私有WS
    private_ws_rest_fallback: true    # WS不可用时自动回退 REST execution/list
    ws_reconnect_interval_ms: 15000   # 降级到REST后尝试重连WS的间隔（0=每轮都尝试）
    execution_poll_limit: 50          # REST成交轮询单次拉取上限
  timeout_ms: 2000
  rate_limit_buffer: 0.9 # 达到限频 90% 时主动降速

# ==========================================
# 智能筛币配置 (Universe Selector)
# ==========================================
universe:
  enabled: true
  update_interval_minutes: 60
  max_active_symbols: 3
  min_active_symbols: 1
  fallback_symbols: ["BTCUSDT", "ETHUSDT"]
  candidate_symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"]
  filters:
    min_24h_turnover_usd: 50000000
    max_spread_bps: 8
    max_funding_abs: 0.002
  score_weights:
    liquidity: 0.40
    volatility: 0.25
    spread_cost: 0.25
    funding_stability: 0.10
  constraints:
    turnover_cap: 0.5            # 窗口间集合变更比例上限
    extreme_keep_top_n: 1        # EXTREME 下至少保留前N个低风险币对

# 说明：
# 运行时会将 candidate_symbols + fallback_symbols + system.primary_symbol
# 与交易所返回的可交易 symbol 元信息做交集，作为最终可选交易池。

# ==========================================
# 硬风控配置 (Hard Risk Rules) - 核心保护层
# ==========================================
risk:
  # 账户级回撤控制
  max_drawdown:
    degraded_threshold: 0.08  # 8% -> 降档
    cooldown_threshold: 0.12  # 12% -> 强减仓
    fuse_threshold: 0.20      # 20% -> 熔断
  
  # 强平距离保护
  liquidation:
    min_distance_p95: 0.08    # 强平距离 < 8% 触发强减
    target_restore: 0.10      # 恢复目标

  # 杠杆限制 (白名单)
  leverage_limits:
    BTCUSDT: 3
    ETHUSDT: 3
    SOLUSDT: 2
    DEFAULT: 0 # 禁止其他币种

  # 极端行情保护
  extreme_market:
    force_leverage: 1         # 极端行情强制 1x
    allow_open: false         # 禁止开新仓

# ==========================================
# 策略配置
# ==========================================
strategy:
  active_strategies: ["trend_v1", "vol_target_v1"]
  
  # 组合层配置
  portfolio:
    max_leverage_total: 2.5
    rebalance_threshold: 0.02 # 偏离 2% 才调仓 (防磨损)

  # 策略具体参数
  params:
    trend_v1:
      ema_fast: 12
      ema_slow: 26
      atr_period: 14
      weight_cap: 0.6
    
    vol_target_v1:
      target_vol: 0.40 # 年化波动率目标 40%
      lookback_hours: 24

  # 策略防抖与信号参数
  signal_notional_usd: 1000      # 基础信号目标名义值
  signal_deadband_abs: 0.5       # 价格变化绝对死区
  min_hold_ticks: 3              # 反向前最小保持tick

# ==========================================
# 自进化配置 (Self Evolution)
# ==========================================
self_evolution:
  enabled: false
  update_interval_ticks: 60          # 评估周期（tick）
  min_update_interval_ticks: 60      # 最小更新间隔（tick）
  min_abs_window_pnl_usd: 0.0        # 窗口绝对盈亏低于该值则跳过学习更新
  min_bucket_ticks_for_update: 0     # 单个 Regime 桶样本 tick 门槛（0=关闭该门槛）
  objective_alpha_pnl: 1.0           # 目标函数：PnL系数
  objective_beta_drawdown: 0.0       # 目标函数：回撤惩罚系数（按 drawdown_bps）
  objective_gamma_notional_churn: 0.0 # 目标函数：名义敞口抖动惩罚系数（USD）
  max_single_strategy_weight: 0.60   # 单策略权重上限（双策略时需>=0.5）
  max_weight_step: 0.05              # 单次权重变化上限
  rollback_degrade_windows: 2        # 连续退化窗口数达到阈值触发回滚
  rollback_degrade_threshold_score: 0.0 # 单窗口退化阈值（目标函数 score）
  rollback_cooldown_ticks: 240       # 回滚后冷却期（tick）
  initial_trend_weight: 0.50         # 初始趋势策略权重
  initial_defensive_weight: 0.50     # 初始防御策略权重（现金/防御仓）

# 说明：
# - 当前实现为“阶段2最小链路”：仅支持 trend/defensive 双权重更新与回滚。
# - 更新与回滚只影响组合层目标名义值，不会覆盖 risk.* 不可动层配置。
# - 自进化窗口按 Regime bucket 逐 tick 归因；评估时选择窗口内样本 tick 最多的 bucket。
# - `min_abs_window_pnl_usd` 可避免在“窗口几乎无盈亏反馈”时发生机械调权。
# - `min_bucket_ticks_for_update` 可避免某 bucket 样本过少时误更新。
# - 目标函数：`score = alpha*pnl - beta*drawdown_bps - gamma*notional_churn_usd`。
# - 退化判定：`score <= rollback_degrade_threshold_score`。
# - `beta/gamma` 越大，学习越偏保守（更惩罚回撤与仓位抖动）。
# - `config/bybit.demo.evolution.yaml` 当前将 `update_interval_ticks` 设为 `1200`，用于阶段验收。
# - `config/bybit.demo.s5.yaml` 用于阶段 S5 连续稳态运行（默认 Gate 仅告警不触发运行时动作）。

# ==========================================
# Regime 识别配置
# ==========================================
regime:
  enabled: true
  warmup_ticks: 20          # warmup 期仅输出 RANGE，避免冷启动误判
  ewma_alpha: 0.20          # EWMA 平滑系数 (0,1]
  trend_threshold: 0.0008   # 趋势阈值（绝对收益率）
  extreme_threshold: 0.0030 # 单tick极端波动阈值
  volatility_threshold: 0.0018 # EWMA绝对收益阈值（波动代理）

# 说明：
# - 输出四态：UPTREND / DOWNTREND / RANGE / EXTREME。
# - 同时输出三桶：TREND / RANGE / EXTREME（UPTREND 与 DOWNTREND 映射为 TREND）。
# - 当前实现已把 Regime 接入运行态日志与自进化分桶权重链路。

gate:
  min_effective_signals_per_day: 24  # 最小活跃信号门槛
  min_fills_per_day: 4               # 最小成交门槛
  heartbeat_empty_signal_ticks: 12   # 连续空信号心跳告警阈值
  window_ticks: 288                  # Gate 统计窗口长度（tick）
  enforce_runtime_actions: false     # false=仅告警；true=触发运行时动作
  fail_to_reduce_only_windows: 0     # 连续失败N个窗口进入只减仓（0=关闭）
  fail_to_halt_windows: 0            # 连续失败N个窗口进入停机（0=关闭）
  reduce_only_cooldown_ticks: 0      # 只减仓最短冷却tick（0=不强制）
  halt_cooldown_ticks: 0             # 停机最短冷却tick（0=不强制）
  pass_to_resume_windows: 1          # 连续通过N个窗口后恢复（0=立即恢复）

# ==========================================
# 执行引擎配置
# ==========================================
execution:
  max_order_notional: 50000 # 单笔最大金额
  min_rebalance_notional_usd: 25      # 小于该名义差值不调仓（防抖）
  min_order_interval_ms: 3000          # 同一symbol最小下单间隔（毫秒，0=关闭）
  reverse_signal_cooldown_ticks: 4     # 反向信号冷却tick数（0=关闭）
  max_slippage_bps: 20      # 最大允许滑点 (基点)
  order_timeout_ms: 10000   # 订单超时时间
  protection:
    enabled: false               # 订单级保护单开关（SL优先，TP次之）
    require_sl: true             # 开仓后必须挂SL
    enable_tp: true              # 开仓后可选挂TP
    attach_timeout_ms: 1500      # 保护单挂单确认时窗
    stop_loss_atr_mult: 1.5      # SL距离（示例：ATR倍数）
    take_profit_rr: 1.2          # TP风险收益比（相对SL距离）
    cancel_opposite_on_fill: true # 一侧成交后撤销另一侧（OCO语义）
  retry_policy:
    max_attempts: 3
    backoff_ms: 500

strategy:
  signal_notional_usd: 1000      # 基础信号目标名义值
  signal_deadband_abs: 0.5       # 价格变化绝对死区
  min_hold_ticks: 3              # 反向前最小保持tick
```

## 环境变量

为了安全，敏感信息不应直接写入 YAML 文件：

- `AI_TRADE_BYBIT_TESTNET_API_KEY`
- `AI_TRADE_BYBIT_TESTNET_API_SECRET`
- `AI_TRADE_BYBIT_DEMO_API_KEY`
- `AI_TRADE_BYBIT_DEMO_API_SECRET`
- `AI_TRADE_BYBIT_MAINNET_API_KEY`
- `AI_TRADE_BYBIT_MAINNET_API_SECRET`
- `AI_TRADE_API_KEY`（通用回退）
- `AI_TRADE_API_SECRET`（通用回退）
- `AI_TRADE_WEBHOOK_URL` (用于告警)

读取优先级：
- 当 `exchange.bybit.demo_trading=true`：优先读取 `AI_TRADE_BYBIT_DEMO_*`，缺失时回退 `AI_TRADE_API_*`。
- 当 `exchange.bybit.testnet=true`：优先读取 `AI_TRADE_BYBIT_TESTNET_*`，缺失时回退 `AI_TRADE_API_*`。
- 当 `exchange.bybit.testnet=false`：优先读取 `AI_TRADE_BYBIT_MAINNET_*`，缺失时回退 `AI_TRADE_API_*`。

注意：
- `demo_trading=true` 与 `testnet=true` 互斥，配置加载会直接失败。
- Demo Trading 仅影响 REST 与 Private WS 端点（`api-demo` / `stream-demo`）；Public WS 仍按正常主网端点处理。

## 配置加载逻辑

> **注意**: 风控参数 (`risk.*`) 不支持热加载。修改风控参数必须重启进程，以防止运行时意外修改导致风控失效。

1. 加载默认硬编码配置 (Safe Defaults)。
2. 加载 YAML 配置文件。
3. 加载环境变量覆盖。
4. **校验**: 
   - 检查风控参数是否宽松于硬编码限制（如 YAML 设置熔断为 50%，系统应拒绝启动）。
   - 检查 API Key 格式。
   - 检查自进化配置合法性（更新周期、步长、回滚窗口、冷却期）。
   - 检查自进化样本门槛：`self_evolution.min_abs_window_pnl_usd >= 0`。
   - 检查权重约束（`0<=w_i<=max_single_strategy_weight`、权重和=1）。
   - 检查保护单配置：`enabled=true` 时必须 `require_sl=true` 且 `attach_timeout_ms>0`。
   - 检查执行防抖参数：`execution.min_order_interval_ms >= 0`、`execution.reverse_signal_cooldown_ticks >= 0`、`execution.min_rebalance_notional_usd >= 0`。
   - 检查策略防抖参数：`strategy.signal_notional_usd >= 0`、`strategy.signal_deadband_abs >= 0`、`strategy.min_hold_ticks >= 0`。
   - 检查运行控制参数：`system.max_ticks >= 0`、`system.status_log_interval_ticks >= 0`、`system.remote_risk_refresh_interval_ticks >= 0`。
   - 检查对账参数：`system.reconcile.mismatch_confirmations > 0`、`system.reconcile.pending_order_stale_ms > 0`。
   - 检查 Gate 运行时动作参数：`fail_to_reduce_only_windows/fail_to_halt_windows/reduce_only_cooldown_ticks/halt_cooldown_ticks/pass_to_resume_windows >= 0`。
   - 检查 `system.primary_symbol` 非空。
   - 检查 Bybit 账户门禁参数合法：`expected_account_mode / expected_margin_mode / expected_position_mode`。
   - 检查 Bybit 环境模式：禁止 `testnet=true` 与 `demo_trading=true` 同时启用。
   - 检查 Bybit 通道参数：`execution_poll_limit > 0`、`ws_reconnect_interval_ms >= 0`，并建议
     `public_ws_enabled=true + public_ws_rest_fallback=true + private_ws_enabled=true + private_ws_rest_fallback=true`。
   - 检查 UniverseSelector 参数：`min_active_symbols >= 1`、`max_active_symbols >= min_active_symbols`、`fallback_symbols` 非空。
   - 检查 UniverseSelector 权重和为 1（容差 `1e-6`）。
   - 检查候选池与交易所可交易列表有交集，否则拒绝启动或降级。
   - 检查 Regime 映射完整性（四态必须全部覆盖，且值只能在 `regime_buckets` 内）。
   - 检查学习模块写入边界：禁止任何 `risk.*` 字段被学习结果覆盖。

## 阶段3（因子-模型-风控闭环前两级）规划配置

> 本节为规划配置草案，当前版本默认**不读取**这些字段。  
> 目的：提前固定字段命名与版本治理口径，便于后续实现对齐。

```yaml
research:
  enabled: false
  data:
    source: "bybit_kline"          # 历史数据来源（规划）
    category: "linear"
    symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"]
    interval_minutes: 5
    lookback_days: 180
    storage_path: "./data/research"
  miner:
    engine: "gplearn"              # gplearn / deap（规划）
    random_seed: 42
    max_formula_depth: 6
    population_size: 200
    generations: 50
    operators: ["ts_delay", "ts_delta", "ts_rank", "ts_corr"]
    objective: "spearman_ic"
    min_oos_ic: 0.01

integrator:
  enabled: false
  model_type: "catboost"
  train:
    window_days: 90
    predict_horizon_bars: 12
    split_method: "rolling"        # rolling / timeseriessplit
    rolling_step_days: 1
    optuna_trials: 50
  shadow:
    enabled: true
    log_model_score: true
    require_feature_schema_match: true
  registry:
    model_dir: "./data/models"
    max_versions: 20
    rollback_on_health_fail: true
```

说明：
- `research.*` 用于离线因子挖掘（Miner），核心产物是 `factor_set_version` 与表达式元数据。
- 当前代码已支持 `--run_miner` 离线入口（CSV -> 因子报告），但 `research.*` 字段仍处于“规划中，未直接驱动运行参数”状态。
- 当前 Miner 报告已包含随机基线对照字段（`random_baseline_oos_abs_ic`、`oos_not_worse_than_random`）和滚动 IC 分布字段（`rolling_ic_train/rolling_ic_oos`）。
- `integrator.*` 用于 CatBoost 训练与影子推理（Integrator）。
  - 当前已提供离线训练脚本：`tools/integrator_train.py`（输入 `ohlcv_5m.csv + miner_report.json`，输出 `integrator_report.json + .cbm`）。
  - 当前 C++ 交易主进程尚未直接读取 `integrator.*` 字段（仍按规划字段保留口径），线上阶段默认只记审计不直接下单。
- 历史样本数据是阶段3前两级的前置依赖，需包含 OHLCV + 基础交易元数据（时间、symbol、成交量等）。
- 即便未来启用上述配置，`risk.*` 仍属于不可动层，不可被学习结果覆盖。
