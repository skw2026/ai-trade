# 配置手册 (Configuration)

系统严格遵循“配置驱动”原则。所有风控阈值、策略参数必须显式定义。

Bybit V5 参考：<https://bybit-exchange.github.io/docs/v5/guide>

## 配置文件结构 (YAML)

```yaml
system:
  id: "bot-v1-prod"
  mode: "paper" # live, paper, replay
  primary_symbol: "BTCUSDT"
  log_level: "info"
  data_path: "./data"
  max_ticks: 0                    # 0=持续运行；>0=达到tick数后退出
  status_log_interval_ticks: 20   # 运行状态日志周期；0=关闭
  remote_risk_refresh_interval_ticks: 10 # 远端风险字段刷新周期；0=关闭
  reconcile:
    enabled: true
    interval_ticks: 10
    tolerance_notional_usd: 5.0
    mismatch_confirmations: 2      # 连续N次对账不一致才触发halt（防瞬时抖动）
    pending_order_stale_ms: 30000  # 在途净仓位订单超时阈值（ms）
    anomaly_reduce_only_streak: 0  # 连续异常达到阈值后进入 anomaly reduce-only（0=关闭）
    anomaly_halt_streak: 0         # 连续异常达到阈值后进入 halt（0=关闭）
    anomaly_resume_streak: 3       # 连续健康窗口达到阈值后退出 anomaly reduce-only
  webhook_url: "${AI_TRADE_WEBHOOK_URL}" # Slack/DingTalk/Telegram 告警地址
  
exchange:
  platform: "bybit"
  api_key: "${AI_TRADE_API_KEY}" # 从环境变量读取
  api_secret: "${AI_TRADE_API_SECRET}"
  bybit:
    testnet: true
    demo_trading: false            # true=Bybit Demo Trading（主网模拟盘）
    category: "linear"
    account_type: "UNIFIED"           # 对应 wallet-balance accountType
    expected_account_mode: "UNIFIED"  # 账户门禁：UNIFIED/CLASSIC
    expected_margin_mode: "ISOLATED"  # ISOLATED/CROSS/PORTFOLIO
    expected_position_mode: "ONE_WAY" # ONE_WAY/HEDGE
    public_ws_enabled: true           # 行情通道优先使用 Public WS
    public_ws_rest_fallback: true     # Public WS 不可用时回退 REST market/tickers
    private_ws_enabled: true          # 成交通道优先使用私有WS
    private_ws_rest_fallback: true    # WS不可用时自动回退 REST execution/list
    ws_reconnect_interval_ms: 15000   # 降级到REST后尝试重连WS的间隔（0=每轮都尝试）
    execution_poll_limit: 50          # REST成交轮询单次拉取上限
  timeout_ms: 2000
  rate_limit_buffer: 0.9 # 达到限频 90% 时主动降速

# ==========================================
# 智能筛币配置 (Universe Selector)
# ==========================================
universe:
  enabled: true
  update_interval_minutes: 60
  max_active_symbols: 3
  min_active_symbols: 1
  fallback_symbols: ["BTCUSDT", "ETHUSDT"]
  candidate_symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"]
  filters:
    min_24h_turnover_usd: 50000000
    max_spread_bps: 8
    max_funding_abs: 0.002
  score_weights:
    liquidity: 0.40
    volatility: 0.25
    spread_cost: 0.25
    funding_stability: 0.10
  constraints:
    turnover_cap: 0.5            # 窗口间集合变更比例上限
    extreme_keep_top_n: 1        # EXTREME 下至少保留前N个低风险币对

# 说明：
# 运行时会将 candidate_symbols + fallback_symbols + system.primary_symbol
# 与交易所返回的可交易 symbol 元信息做交集，作为最终可选交易池。

# ==========================================
# 硬风控配置 (Hard Risk Rules) - 核心保护层
# ==========================================
risk:
  # 账户级回撤控制
  max_drawdown:
    degraded_threshold: 0.08           # 8% -> 降档
    degraded_recover_threshold: 0.06   # 回撤恢复到 6% 以下才退出降档（滞回）
    cooldown_threshold: 0.12           # 12% -> 强减仓
    cooldown_recover_threshold: 0.10   # 回撤恢复到 10% 以下才退出 cooldown（滞回）
    fuse_threshold: 0.20               # 20% -> 熔断
    fuse_recover_threshold: 0.16       # 回撤恢复到 16% 以下才退出 fuse（滞回）
  
  # 强平距离保护
  liquidation:
    min_distance_p95: 0.08    # 强平距离 < 8% 触发强减
    target_restore: 0.10      # 恢复目标

  # 杠杆限制 (白名单)
  leverage_limits:
    BTCUSDT: 3
    ETHUSDT: 3
    SOLUSDT: 2
    DEFAULT: 0 # 禁止其他币种

  # 极端行情保护
  extreme_market:
    force_leverage: 1         # 极端行情强制 1x
    allow_open: false         # 禁止开新仓

# ==========================================
# 策略配置
# ==========================================
strategy:
  active_strategies: ["trend_v1", "vol_target_v1"]
  
  # 组合层配置
  portfolio:
    max_leverage_total: 2.5
    rebalance_threshold: 0.02 # 偏离 2% 才调仓 (防磨损)

  # 策略具体参数
  params:
    trend_v1:
      ema_fast: 12
      ema_slow: 26
      atr_period: 14
      weight_cap: 0.6
    
    vol_target_v1:
      target_vol: 0.40 # 年化波动率目标 40%
      lookback_hours: 24

  # 策略防抖与信号参数
  signal_notional_usd: 1000      # 基础信号目标名义值
  signal_deadband_abs: 0.5       # 价格变化绝对死区
  signal_valid_for_ms: 15000     # 信号有效期（毫秒），超时作废
  default_tick_interval_ms: 5000 # 无法从行情推断间隔时的兜底tick间隔（毫秒）
  min_hold_ticks: 3              # 反向前最小保持tick
  trend_breakout_lookback_ticks: 0   # 趋势突破过滤窗口（0=关闭）
  trend_breakout_rank_threshold: 0.98 # 趋势突破分位阈值（[0.5,1.0]）
  trend_slope_lookback_ticks: 0      # 慢EMA斜率回看窗口（0=关闭）
  trend_slope_min_abs: 0.0           # 慢EMA最小斜率阈值（按价格归一化）
  trend_vol_cap_annual: 0.0          # 趋势策略年化波动上限（0=关闭）
  trend_strength_scale: 0.0          # 趋势强度缩放（0=关闭，>0按EMA gap/波动率缩放仓位）
  vol_target_pct: 0.40           # VolTarget 目标年化波动率
  vol_target_max_leverage: 3.0   # VolTarget 杠杆上限
  vol_target_low_vol_leverage_cap_enabled: false # 低波动场景杠杆压制开关
  vol_target_low_vol_annual_threshold: 0.10      # 低波动年化阈值
  vol_target_low_vol_max_leverage: 1.0           # 低波动场景杠杆上限
  vol_target_rebalance_min_abs_usd: 0.0          # VolTarget 目标名义最小绝对变化（USD），低于阈值不更新
  vol_target_rebalance_min_ratio: 0.0            # VolTarget 目标名义最小相对变化（相对上次目标）
  defensive_notional_ratio: 0.55 # 防御分支名义值比例（相对 trend 基线）
  defensive_entry_score: 1.25    # 防御入场阈值（偏离评分绝对值）
  defensive_trend_scale: 0.25    # TREND 桶防御缩放
  defensive_range_scale: 1.00    # RANGE 桶防御缩放
  defensive_extreme_scale: 0.45  # EXTREME 桶防御缩放

# ==========================================
# Integrator 接管配置（分级）
# ==========================================
integrator:
  enabled: true
  model_type: "catboost"
  mode: "shadow"                  # off/shadow/canary/active
  canary_notional_ratio: 0.30     # canary模式接管比例（相对原策略绝对名义值）
  canary_min_notional_usd: 50     # canary最小经济名义值；低于该值时直接抹零
  canary_confidence_threshold: 0.60 # canary最低置信阈值(|p_up-p_down|)
  canary_allow_countertrend: false  # canary是否允许与原策略反向
  active_confidence_threshold: 0.55 # active最低置信阈值，低于阈值转空仓
  active_min_notional_usd: 0        # active最小经济名义值；低于该值时转空仓，避免粉尘仓位
  active_partial_notional_ratio: 0.5 # active部分接管名义值比例（阶梯接管）
  active_full_notional_confidence_threshold: 0.80 # active全量接管阈值
  shadow:
    enabled: true
    log_model_score: true
    model_report_path: "./data/research/integrator_report.json"
    score_gain: 1.0

# 说明：
# - Integrator 不再使用“策略信号伪造打分”fallback。
# - 当模型文件/运行时不可用时，Infer 会返回 enabled=false，
#   下游统一走 `shadow_unavailable` 降级语义（不修改原策略信号）。
# - active 模式不再按 `|p_up-p_down|` 线性缩放仓位，而采用“阈值+阶梯”接管：
#   - `confidence < active_confidence_threshold`：转空仓；
#   - `active_confidence_threshold <= confidence < active_full_notional_confidence_threshold`：按 `active_partial_notional_ratio` 接管；
#   - `confidence >= active_full_notional_confidence_threshold`：全量接管。

# ==========================================
# 自进化配置 (Self Evolution)
# ==========================================
self_evolution:
  enabled: false
  update_interval_ticks: 60          # 评估周期（tick）
  min_update_interval_ticks: 60      # 最小更新间隔（tick）
  min_abs_window_pnl_usd: 0.0        # 窗口绝对盈亏低于该值则跳过学习更新
  min_bucket_ticks_for_update: 0     # 单个 Regime 桶样本 tick 门槛（0=关闭该门槛）
  min_consecutive_direction_windows: 1 # 同方向至少连续N个窗口才允许调权（方向防抖）
  use_virtual_pnl: false             # true=用虚拟PnL作为学习目标（推荐用于零成交阶段）
  use_counterfactual_search: false   # true=在权重网格上做反事实搜索
  counterfactual_fallback_to_factor_ic: true # true=反事实无提升时回退到 factor-IC 调权
  counterfactual_min_improvement_usd: 0.0 # 反事实候选相对当前策略的最小改进门槛
  counterfactual_min_improvement_ratio_of_equity: 0.0 # 反事实最小改进门槛（按权益比例）
  counterfactual_improvement_decay_per_filtered_signal_usd: 0.0 # 每个成本门拦截信号可降低的反事实门槛
  counterfactual_min_fill_count_for_update: 0 # 反事实更新最小成交样本门槛（0=关闭；不足且fallback开启时转factor-IC）
  counterfactual_min_t_stat_samples_for_update: 0 # 反事实更新最小可学习样本门槛（0=关闭）
  counterfactual_min_t_stat_abs_for_update: 0.0 # 反事实更新最小|t-stat|门槛（0=关闭）
  counterfactual_superiority_min_samples_for_update: 0 # 候选-当前“配对差值”最小样本门槛（0=关闭）
  counterfactual_superiority_min_t_stat_for_update: 0.0 # 候选-当前“配对差值”最小t-stat门槛（单侧，0=关闭）
  virtual_cost_bps: 0.0              # 虚拟PnL成本估计（按名义值变化计费，bps）
  virtual_cost_dynamic_enabled: true # true=根据窗口成本门拦截比例动态上调虚拟成本
  virtual_cost_dynamic_max_multiplier: 3.0 # 动态上调倍数上限（>=1）
  virtual_funding_rate_per_tick: 0.0 # 虚拟PnL资金费率（每tick；正值=多头支付）
  enable_factor_ic_adaptive_weights: false # true=按在线因子IC调权（trend/defensive）
  factor_ic_min_samples: 120         # 因子IC最小样本数（低于门槛不调权）
  factor_ic_min_abs: 0.01            # 因子IC绝对值门槛（低于门槛视为无有效预测力）
  factor_ic_deadzone_abs: 0.02       # IC噪声死区（<=该值视为中性，不驱动调权）
  enable_learnability_gate: false    # true=启用可学习性门控（低信噪窗口冻结学习）
  learnability_min_samples: 120      # 可学习性统计最小样本数
  learnability_min_t_stat_abs: 1.5   # 可学习性阈值：|t-stat|<阈值则跳过更新
  min_effective_weight_delta: 0.0    # 最小有效调权幅度（trend_weight 绝对变化；小于阈值则跳过）
  objective_alpha_pnl: 1.0           # 目标函数：PnL系数（按 pnl_bps）
  objective_beta_drawdown: 1.0       # 目标函数：回撤惩罚系数（按 drawdown_bps）
  objective_gamma_notional_churn: 0.005 # 目标函数：名义敞口抖动惩罚系数（按 churn_bps）
  objective_use_sharpe_like: false   # true=使用 Sharpe-like 目标（按每tick收益/回撤代理）
  max_single_strategy_weight: 0.60   # 单策略权重上限（双策略时需>=0.5）
  max_weight_step: 0.05              # 单次权重变化上限
  rollback_degrade_windows: 2        # 连续退化窗口数达到阈值触发回滚
  rollback_degrade_threshold_score: 0.0 # 单窗口退化阈值（目标函数 score）
  rollback_to_baseline_on_trigger: true # true=触发回滚时恢复到初始化基线权重；false=回退到上一锚点
  rollback_cooldown_ticks: 240       # 回滚后冷却期（tick）
  initial_trend_weight: 0.50         # 初始趋势策略权重
  initial_defensive_weight: 0.50     # 初始防御策略权重（现金/防御仓）

# 说明：
# - 当前实现为“阶段2最小链路”：仅支持 trend/defensive 双权重更新与回滚。
# - 更新与回滚作用于 trend/defensive 两个策略分量的混合权重，不会覆盖 risk.* 不可动层配置。
# - 自进化窗口按 Regime bucket 逐 tick 归因；评估时选择窗口内样本 tick 最多的 bucket。
# - `min_abs_window_pnl_usd` 可避免在“窗口几乎无盈亏反馈”时发生机械调权。
# - `min_bucket_ticks_for_update` 可避免某 bucket 样本过少时误更新。
# - 目标函数支持两种口径：
#   - `objective_use_sharpe_like=false`：权益归一化后的 bps 量纲（pnl/drawdown/churn）
#   - `objective_use_sharpe_like=true`：Sharpe-like 口径（每tick收益/回撤代理）
# - `use_virtual_pnl=true` 时，学习信号来自 `signal_notional * forward_return - estimated_cost`；
#   可在“零成交”阶段继续学习，不依赖真实成交。
# - `use_counterfactual_search=true` 时，会在 `[1-max_single_strategy_weight, max_single_strategy_weight]`
#   网格上搜索虚拟PnL最优权重，优于固定步长的单方向调权。
# - 当 `use_counterfactual_search=true` 时，优先走反事实候选；
#   若候选未达到改进门槛，且 `counterfactual_fallback_to_factor_ic=true`，会回退到 factor-IC 调权路径。
# - 当开启 `counterfactual_superiority_*` 门控时，只有在“候选-当前”逐tick配对收益差值
#   样本数与 t-stat 同时达标后，才允许走反事实更新；否则按 fallback/skip 处理。
# - 当 `use_counterfactual_search=true` 且 `window_fill_count < counterfactual_min_fill_count_for_update`：
#   若 `counterfactual_fallback_to_factor_ic=true`，会直接切换到 factor-IC 调权；
#   若关闭 fallback，则按 `EVOLUTION_COUNTERFACTUAL_FILL_COUNT_TOO_LOW` 跳过。
#   关闭 fallback 时会保持“严格反事实”并直接跳过本轮更新。
# - `enable_factor_ic_adaptive_weights=true` 在 `use_counterfactual_search=false` 时作为直接调权来源；
#   在反事实模式下仍会持续输出 IC 指标用于观测与评估。
# - `enable_factor_ic_adaptive_weights=true` 时，窗口内会计算 trend/defensive 因子与 forward return 的
#   在线相关系数（IC），并按 IC 强度自适应调权。
# - `enable_learnability_gate=true` 时，仅在窗口样本数达标且 `|t-stat|` 达标时允许更新；
#   否则产生 `EVOLUTION_LEARNABILITY_*` 跳过动作，避免噪声窗口“学坏”。
# - `min_consecutive_direction_windows>1` 时，自进化需要连续多个窗口给出同方向结论才会执行更新；
#   首个方向窗口会记录为 `EVOLUTION_DIRECTION_CONSISTENCY_PENDING`，用于抑制抖动更新。
# - `min_effective_weight_delta>0` 时，候选调权幅度若过小会输出
#   `EVOLUTION_WEIGHT_DELTA_TOO_SMALL` 并跳过，减少“有动作但无实质变化”的噪声更新。
# - 目标函数：`score = alpha*pnl_bps - beta*drawdown_bps - gamma*churn_bps`。
# - `self_evolution.enabled=true` 时，`objective_beta_drawdown` 与
#   `objective_gamma_notional_churn` 必须 > 0，防止学习目标退化为“只追逐PnL”。
# - 退化判定：`score <= rollback_degrade_threshold_score`。
# - `beta/gamma` 越大，学习越偏保守（更惩罚回撤与仓位抖动）。
# - `config/bybit.demo.evolution.yaml` 当前将 `update_interval_ticks` 设为 `3600`，优先降低短窗噪声。
# - `config/bybit.demo.s5.yaml` 用于阶段 S5 连续稳态运行（默认 Gate 仅告警不触发运行时动作）。
# - `config/bybit.demo.aggressive.yaml` 为“模拟盘激进观察档”，仅建议 Demo 使用，便于更快积累执行/学习样本。

# ==========================================
# Regime 识别配置
# ==========================================
regime:
  enabled: true
  warmup_ticks: 20          # warmup 期仅输出 RANGE，避免冷启动误判
  ewma_alpha: 0.20          # EWMA 平滑系数 (0,1]
  switch_confirm_ticks: 0   # Regime 切换确认tick；0/1=不确认，>1=连续确认后切换
  extreme_requires_both: false # true=需 jump 与 vol 同时命中才进入 EXTREME
  trend_threshold: 0.0008   # 趋势阈值（绝对收益率）
  extreme_threshold: 0.0030 # 单tick极端波动阈值
  volatility_threshold: 0.0018 # EWMA绝对收益阈值（波动代理）

# 说明：
# - 输出四态：UPTREND / DOWNTREND / RANGE / EXTREME。
# - 同时输出三桶：TREND / RANGE / EXTREME（UPTREND 与 DOWNTREND 映射为 TREND）。
# - 当前实现已把 Regime 接入运行态日志与自进化分桶权重链路。

gate:
  min_effective_signals_per_day: 24  # 最小活跃信号门槛
  min_fills_per_day: 4               # 最小成交门槛
  heartbeat_empty_signal_ticks: 12   # 连续空信号心跳告警阈值
  window_ticks: 288                  # Gate 统计窗口长度（tick）
  enforce_runtime_actions: false     # false=仅告警；true=触发运行时动作
  fail_to_reduce_only_windows: 0     # 连续失败N个窗口进入只减仓（0=关闭）
  fail_to_halt_windows: 0            # 连续失败N个窗口进入停机（0=关闭）
  reduce_only_cooldown_ticks: 0      # 只减仓最短冷却tick（0=不强制）
  halt_cooldown_ticks: 0             # 停机最短冷却tick（0=不强制）
  pass_to_resume_windows: 1          # 连续通过N个窗口后恢复（0=立即恢复）
  auto_resume_when_flat: true        # 空仓且无净仓位在途订单时允许自动恢复
  auto_resume_flat_ticks: 120        # 满足空仓稳态的最小连续tick（0=立即可恢复）

# ==========================================
# 执行引擎配置
# ==========================================
execution:
  max_order_notional: 50000 # 单笔最大金额
  min_rebalance_notional_usd: 25      # 小于该名义差值不调仓（防抖）
  direct_flip_entry_enabled: false    # 反手时允许直接按净差额发单（默认关闭，开启可降低2xRTT）
  include_inflight_notional_in_position: true # 计算当前仓位时叠加在途净仓位，减少拆单串行等待
  max_inflight_orders_per_symbol_direction: 2 # 同symbol同方向在途单上限（0=不限制）
  min_order_interval_ms: 3000          # 同一symbol最小下单间隔（毫秒，0=关闭）
  reverse_signal_cooldown_ticks: 4     # 反向信号冷却tick数（0=关闭）
  enable_fee_aware_entry_gate: true    # 开仓前成本门槛过滤
  entry_fee_bps: 5.5                   # 入场手续费估计（bps）
  exit_fee_bps: 5.5                    # 出场手续费估计（bps）
  expected_slippage_bps: 1.0           # 单侧滑点估计（bps）
  min_expected_edge_bps: 1.0           # 成本之上最小净边际缓冲（bps）
  required_edge_cap_bps: 0.0           # 开仓成本门槛上限（0=关闭；>0 时取 min(原门槛, cap)）
  entry_gate_near_miss_tolerance_bps: 0.0 # 成本门 near-miss 容差（bps；允许“略低于门槛”的信号通过）
  entry_gate_near_miss_maker_allow: false # near-miss 样本允许 maker 放行（建议仅 demo 打开）
  entry_gate_near_miss_maker_max_gap_bps: 0.0 # near-miss maker 放行“附加 gap”（bps；在 tolerance 之上，0=不额外放行被拦截样本）
  adaptive_fee_gate_enabled: true      # 是否启用“成本门自适应放宽”
  adaptive_fee_gate_min_samples: 120   # 自适应生效前最小观测样本
  adaptive_fee_gate_trigger_ratio: 0.75 # ORDER_FILTERED_COST 占比超过该阈值后开始放宽
  adaptive_fee_gate_max_relax_bps: 2.0 # 自适应最多可放宽的 bps
  dynamic_edge_enabled: true           # 启用动态成本门（regime/波动/流动性）
  dynamic_edge_regime_trend_relax_bps: 0.4   # TREND 桶放宽 required_edge（bps）
  dynamic_edge_regime_range_penalty_bps: 0.2 # RANGE 桶抬升 required_edge（bps）
  dynamic_edge_regime_extreme_penalty_bps: 0.8 # EXTREME 桶抬升 required_edge（bps）
  dynamic_edge_volatility_relax_bps: 0.4     # 低波动时放宽量（按比例缩放）
  dynamic_edge_volatility_penalty_bps: 0.6   # 高波动时惩罚量（按比例缩放）
  dynamic_edge_liquidity_maker_ratio_threshold: 0.55 # maker 占比达到阈值后开始放宽
  dynamic_edge_liquidity_unknown_ratio_threshold: 0.20 # unknown 占比达到阈值后开始惩罚
  dynamic_edge_liquidity_relax_bps: 0.4      # 流动性好时最多放宽 bps
  dynamic_edge_liquidity_penalty_bps: 0.6    # 流动性差时最多惩罚 bps
  maker_entry_enabled: true            # 开仓优先maker限价
  maker_fallback_to_market: true       # PostOnly 被拒时自动回退一次市价
  maker_price_offset_bps: 1.0          # maker限价相对参考价偏移（bps）
  maker_post_only: true                # maker限价是否强制PostOnly
  maker_edge_relax_bps: 0.0            # maker 开仓允许额外放宽的边际门槛（bps）
  cost_filter_cooldown_trigger_count: 0 # 连续成本门拦截达到阈值后触发 symbol 冷却（0=关闭）
  cost_filter_cooldown_ticks: 0        # 成本门冷却 tick（与 trigger_count 成对配置）
  quality_guard_enabled: false         # 执行质量守卫开关（按窗口成交质量动态抬升入场门槛）
  quality_guard_min_fills: 12          # 执行质量判定窗口最小成交数
  quality_guard_bad_streak_to_trigger: 2 # 连续劣化窗口达到阈值后激活守卫
  quality_guard_good_streak_to_release: 2 # 连续恢复窗口达到阈值后解除守卫
  quality_guard_min_realized_net_per_fill_usd: -0.005 # 低于阈值视为劣化（USD/Fill）
  quality_guard_max_fee_bps_per_fill: 8.0 # 高于阈值视为劣化（bps/Fill）
  quality_guard_required_edge_penalty_bps: 1.5 # 守卫激活时附加到 required_edge 的惩罚
  quality_guard_required_edge_floor_bps: 0.0 # 守卫激活时 required_edge 的最小下限（0=关闭）
  concentration_top1_share_threshold: 1.0 # 单币集中度阈值（[0,1]；>=阈值时对 top1 symbol 加惩罚）
  concentration_penalty_bps: 0.0      # 集中度惩罚上限（按超阈值比例线性放大）
  concentration_min_symbols: 2        # 至少 N 个持仓币时才启用集中度惩罚
  order_timeout_ms: 10000   # 订单超时时间
  protection:
    enabled: false               # 订单级保护单开关（SL优先，TP次之）
    require_sl: true             # 开仓后必须挂SL
    enable_tp: true              # 开仓后可选挂TP
    attach_timeout_ms: 1500      # 保护单挂单确认时窗
    stop_loss_ratio: 0.01        # SL距离比例（相对开仓价）
    take_profit_ratio: 0.015     # TP距离比例（相对开仓价）
    # 运行时语义：SL/TP 会作为 reduce-only 条件触发单提交（triggerBy=MarkPrice），
    # 不再以即时市价单方式提交，避免“挂保护单即瞬时平仓”的错误行为。
    cancel_opposite_on_fill: true # 一侧成交后撤销另一侧（OCO语义）
  retry_policy:
    max_attempts: 3
    backoff_ms: 500

strategy:
  signal_notional_usd: 1000      # 基础信号目标名义值
  signal_deadband_abs: 0.5       # 价格变化绝对死区
  min_hold_ticks: 3              # 反向前最小保持tick
  vol_target_pct: 0.40           # VolTarget 目标年化波动率
  vol_target_max_leverage: 3.0   # VolTarget 杠杆上限
  vol_target_low_vol_leverage_cap_enabled: false # 低波动杠杆压制开关
  vol_target_low_vol_annual_threshold: 0.10      # 低波动年化阈值
  vol_target_low_vol_max_leverage: 1.0           # 低波动杠杆上限
  vol_target_rebalance_min_abs_usd: 0.0          # VolTarget 目标名义最小绝对变化（USD）
  vol_target_rebalance_min_ratio: 0.0            # VolTarget 目标名义最小相对变化
  defensive_notional_ratio: 0.55 # 防御分支名义值比例（相对 trend 基线）
  defensive_entry_score: 1.25    # 防御入场阈值（偏离评分绝对值）
  defensive_trend_scale: 0.25    # TREND 桶防御缩放
  defensive_range_scale: 1.00    # RANGE 桶防御缩放
  defensive_extreme_scale: 0.45  # EXTREME 桶防御缩放
```

兼容说明：
- 旧字段 `stop_loss_atr_mult` / `take_profit_rr` 仍可被解析，但建议统一迁移为 `stop_loss_ratio` / `take_profit_ratio`。

## 环境变量

为了安全，敏感信息不应直接写入 YAML 文件：

- `AI_TRADE_BYBIT_TESTNET_API_KEY`
- `AI_TRADE_BYBIT_TESTNET_API_SECRET`
- `AI_TRADE_BYBIT_DEMO_API_KEY`
- `AI_TRADE_BYBIT_DEMO_API_SECRET`
- `AI_TRADE_BYBIT_MAINNET_API_KEY`
- `AI_TRADE_BYBIT_MAINNET_API_SECRET`
- `AI_TRADE_API_KEY`（通用回退）
- `AI_TRADE_API_SECRET`（通用回退）
- `AI_TRADE_WEBHOOK_URL` (用于告警)
- `GRAFANA_ADMIN_USER`（Grafana 管理员账号，默认 `admin`）
- `GRAFANA_ADMIN_PASSWORD`（Grafana 管理员密码，必须修改为强密码）
- `GRAFANA_BIND_ADDRESS`（Grafana 暴露地址，默认 `127.0.0.1`）
- `PROMETHEUS_BIND_ADDRESS`（Prometheus 暴露地址，默认 `127.0.0.1`）
- `LOKI_BIND_ADDRESS`（Loki 暴露地址，默认 `127.0.0.1`）
- `GRAFANA_PORT / PROMETHEUS_PORT / LOKI_PORT`（可选端口覆盖）
- `AI_TRADE_IMAGE`（生产运行镜像，未设置时默认 `ai-trade:latest`）
- `AI_TRADE_RESEARCH_IMAGE`（研究镜像，可选；用于 `closed_loop_runner.sh` 的 train/full）
- `AI_TRADE_WEB_IMAGE`（控制平面镜像，可选；profile `web` 启用时生效）
- `AI_TRADE_PROJECT_DIR`（宿主机项目绝对路径，建议 `/opt/ai-trade`；用于 scheduler 二次 compose 路径对齐）
- `AI_TRADE_ENV_FILE`（scheduler 读取的环境文件名，默认 `.env.runtime`）
- `SCHEDULER_ACTION`（scheduler 每轮执行动作：`train|assess|full|data`，默认 `full`）
- `SCHEDULER_INTERVAL_SECONDS`（scheduler 轮询间隔秒数，默认 `86400`；加速验证可设为 `3600`）
- `DATA_PIPELINE_CONFIG`（数据加速链路配置文件，默认 `config/data_pipeline.yaml`）
- `AI_TRADE_CONFIG_PATH`（生产运行配置路径，默认 `config/bybit.demo.evolution.yaml`）
  - 生产 compose 中 `ai-trade` / `scheduler` / `ai-trade-web` 均基于宿主机 `${AI_TRADE_PROJECT_DIR}/config` 读取，确保“运行配置=校验配置=控制面可见配置”。
- `AI_TRADE_EXCHANGE`（生产运行交易所参数，默认 `bybit`）
- `DOCKER_LOG_MAX_SIZE`（watchdog/scheduler 容器日志轮转单文件大小，默认 `20m`）
- `DOCKER_LOG_MAX_FILE`（watchdog/scheduler 容器日志轮转文件数，默认 `5`）
- `AI_TRADE_WEB_BIND_ADDRESS`（控制平面暴露地址，默认 `127.0.0.1`）
- `AI_TRADE_WEB_PORT`（控制平面端口，默认 `8080`）
- `AI_TRADE_WEB_ENABLE_WRITE`（控制平面写入开关，默认 `false`）
- `AI_TRADE_WEB_ADMIN_TOKEN`（控制平面管理员令牌；写入开启时必须配置）
- `AI_TRADE_WEB_REQUIRE_LATEST_PASS`（发布前要求 latest 报告为 PASS，默认 `true`）
- `AI_TRADE_WEB_ALLOW_PASS_WITH_ACTIONS`（是否允许 `PASS_WITH_ACTIONS` 也可发布，默认 `false`）
- `AI_TRADE_WEB_HIGH_RISK_TWO_MAN_RULE`（高风险变更双人审批开关，默认 `true`）
- `AI_TRADE_WEB_HIGH_RISK_REQUIRED_APPROVALS`（高风险变更最少审批人数量，默认 `2`，范围 `2-5`）
- `AI_TRADE_WEB_HIGH_RISK_COOLDOWN_SECONDS`（高风险审批后发布冷却秒数，默认 `180`，范围 `0-86400`）
- `CLOSED_LOOP_GC_ENABLED`（闭环产物回收开关，默认 `true`）
- `CLOSED_LOOP_GC_KEEP_RUN_DIRS`（保留 run 目录数，默认 `120`）
- `CLOSED_LOOP_GC_KEEP_DAILY_FILES`（保留日报文件数，默认 `120`）
- `CLOSED_LOOP_GC_KEEP_WEEKLY_FILES`（保留周报文件数，默认 `104`）
- `CLOSED_LOOP_GC_MAX_AGE_HOURS`（闭环产物最大保留时长，默认 `72` 小时，`0` 表示关闭按时间回收）
- `CLOSED_LOOP_GC_LOG_FILE`（可选：需要截断的日志文件路径，默认 `/opt/ai-trade/data/reports/closed_loop/cron.log`）
- `CLOSED_LOOP_GC_LOG_MAX_BYTES`（日志截断阈值，默认 `104857600`）
- `CLOSED_LOOP_GC_LOG_KEEP_BYTES`（日志截断后保留字节，默认 `20971520`）
- `CLOSED_LOOP_VERIFY_S5_EVOLUTION_SWITCHES`（S5 校验 `use_virtual_pnl + factor-IC + learnability` 三开关，默认 `true`）
- `CLOSED_LOOP_REQUIRE_S5_FACTOR_IC_ACTION`（S5 强制要求 `self_evolution_factor_ic_action_count > 0`，默认 `false`）
- `CLOSED_LOOP_REQUIRE_S5_LEARNABILITY_ACTIVITY`（S5 强制要求 learnability pass/skip 有活动，默认 `false`）
- `CLOSED_LOOP_S5_MIN_EFFECTIVE_UPDATES`（S5 强门禁：`self_evolution_effective_update_count` 下限，默认 `1`）
- `CLOSED_LOOP_S5_MIN_REALIZED_NET_PER_FILL_USD`（S5 强门禁：`realized_net_per_fill` 下限，默认 `-0.001`）
- `CLOSED_LOOP_S5_MIN_REALIZED_NET_PER_FILL_WINDOWS`（S5 生效条件：`funnel_fills_runtime_count` 下限，默认 `10`）
- `CLOSED_LOOP_S5_MIN_EQUITY_CHANGE_USD`（S5 可选强门禁：`equity_change_usd` 下限，默认未设置=关闭）
- `CLOSED_LOOP_S5_MIN_EQUITY_CHANGE_SAMPLES`（S5 权益门槛生效条件：`runtime_account_samples` 下限，默认 `0`）
- `CLOSED_LOOP_S5_MAX_EQUITY_VS_REALIZED_GAP_USD`（S5 可选强门禁：`|equity_change_usd - realized_net_pnl_change_usd|` 上限，默认未设置=关闭）
- `DOCKER_GC_ENABLED`（容器层垃圾回收开关，默认 `true`）
- `DOCKER_GC_UNTIL`（镜像/构建缓存保留窗口，默认 `72h`）
- `DOCKER_GC_DRY_RUN`（仅打印不执行，默认 `false`）
- `DOCKER_GC_PRUNE_CONTAINERS`（清理停止容器，默认 `true`）
- `DOCKER_GC_PRUNE_IMAGES`（清理过旧镜像层，默认 `true`）
- `DOCKER_GC_PRUNE_BUILD_CACHE`（清理构建缓存，默认 `true`）
- `DOCKER_GC_PRUNE_NETWORKS`（清理未使用网络，默认 `false`）
- `DOCKER_GC_PRUNE_VOLUMES`（清理未使用卷，默认 `false`）
- `DOCKER_GC_KEEP_RECENT_TAGS`（按仓库额外保留最近 N 个镜像 tag，默认 `8`；`0` 关闭该功能）
- `DOCKER_GC_KEEP_REPO_MATCHERS`（逗号分隔仓库名子串，用于限定按 tag 保留的仓库范围；默认 `ai-trade,ai-trade-research,ai-trade-web`）

读取优先级：
- 当 `exchange.bybit.demo_trading=true`：优先读取 `AI_TRADE_BYBIT_DEMO_*`，缺失时回退 `AI_TRADE_API_*`。
- 当 `exchange.bybit.testnet=true`：优先读取 `AI_TRADE_BYBIT_TESTNET_*`，缺失时回退 `AI_TRADE_API_*`。
- 当 `exchange.bybit.testnet=false`：优先读取 `AI_TRADE_BYBIT_MAINNET_*`，缺失时回退 `AI_TRADE_API_*`。

注意：
- `demo_trading=true` 与 `testnet=true` 互斥，配置加载会直接失败。
- Demo Trading 仅影响 REST 与 Private WS 端点（`api-demo` / `stream-demo`）；Public WS 仍按正常主网端点处理。

## 监控与可观测性（Prometheus + Grafana）

项目支持通过 Docker 全家桶启动监控栈（Prometheus + Grafana + Loki + Promtail）：

```bash
docker compose --profile obs up -d loki promtail prometheus grafana
```

预置仪表盘：
- `ai-trade Metrics Runtime (Prometheus)`：核心指标看板
- `ai-trade Runtime`：日志审计与排障看板

核心监控项包括：
- 账户级：`equity`、`drawdown_pct`、`notional`
- 执行/成交：`funnel_window.fills`、`throttle_total.hit_rate`
- 执行质量：`execution_window.maker_fill_ratio`、`execution_window.fee_bps_per_fill`、`execution_quality_guard.active`
- 成本门细分：`entry_gate.observed_filtered_ratio`、`entry_gate.observed_near_miss_ratio`、`entry_gate.observed_near_miss_allowed_ratio`、`execution_window.filtered_cost_near_miss_ratio`、`execution_window.passed_cost_near_miss_ratio`
- 仓位集中度：`concentration.top1_share`、`concentration.symbol_count`
- 风控/Gate：`GATE_CHECK_PASSED/FAILED`、`gate_runtime.fail_streak`
- 自进化：`SELF_EVOLUTION_ACTION` 事件计数
- 对账：`OMS_RECONCILE_AUTORESYNC`、`OMS_RECONCILE_ANOMALY_*` 事件计数
- 研究训练：`MINER_DONE`、`INTEGRATOR_DONE` 日志事件

说明：
- Promtail 自动采集 `ai-trade` 与 `ai-trade-research` 容器日志并写入 Loki；
- Promtail 同时将 `RUNTIME_STATUS` 与关键事件转换为 Prometheus 指标（`ai_trade_*`）；
- Prometheus 规则文件已预留：`observability/prometheus/rules/alerts.yml`（当前默认不加载，仅监控不告警）。

## 闭环自动化（训练 + 验收 + 版本注册）

建议使用 `tools/closed_loop_runner.sh` 统一执行：

```bash
# 仅运行态验收（推荐先从 assess 开始）
tools/closed_loop_runner.sh assess --stage S5 --since 4h

# 全流程闭环（R0/R1/R2 + 注册 + 验收）
tools/closed_loop_runner.sh full --stage S5 --since 4h

# 数据加速链路（归档 + 增量 + 回补 + 特征 + walk-forward）
tools/closed_loop_runner.sh data --data-config config/data_pipeline.yaml

# 全工程质量门禁（编译/测试/compose/报告契约）
make qa

# 产物回收（可手动执行）
tools/recycle_artifacts.sh \
  --reports-root ./data/reports/closed_loop \
  --keep-run-dirs 120 \
  --keep-daily-files 120 \
  --keep-weekly-files 104
```

`train/full` 默认新增两道前置步骤：
- `D1 baseline freeze`：冻结当前 active 模型到本次 run 目录；
- `D2 data quality gate`：训练前校验 CSV 质量，失败即阻断后续 R1/R2。
- `data` 默认执行：archive download -> incremental update -> gap fill -> feature store -> walk-forward。

`config/data_pipeline.yaml` 关键字段（已生效）：

```yaml
walkforward:
  enabled: true
  train_window: 2400
  test_window: 480
  step_window: 480
  fee_bps: 6.0
  slippage_bps: 1.5
  signal_threshold: 0.0002
  max_leverage: 1.5
  pred_scale: 0.002
  interval_minutes: 5
  model: linear                 # linear / catboost
  catboost_iterations: 300
  catboost_depth: 6
  catboost_learning_rate: 0.05
  random_seed: 42
```

说明：
- `model=catboost` 时，`tools/backtest_walkforward.py` 使用 CatBoost 回归模型进行 walk-forward；若环境缺少 catboost 会直接报错并退出。
- `model=linear` 保持快速基线回测，适合低资源或功能验证场景。

可选参数（闭环脚本）：
- Miner：`--miner-generations`、`--miner-population`、`--miner-elite`
- DQ 门禁：`--dq-min-rows`、`--dq-max-nan-ratio`、`--dq-max-duplicate-ts-ratio`、`--dq-max-zero-volume-ratio`

生产编排场景：
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_CONFIG_PATH=config/bybit.demo.s5.yaml
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime
# 仅模拟盘激进观察可切换：
# export AI_TRADE_CONFIG_PATH=config/bybit.demo.aggressive.yaml
tools/closed_loop_runner.sh assess \
  --compose-file docker-compose.prod.yml \
  --env-file .env.runtime \
  --stage S5 \
  --since 4h
```

生产常驻闭环（推荐）：
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d ai-trade watchdog scheduler
```

关键产物：
- 汇总报告：`data/reports/closed_loop/latest/closed_loop_report.json`
- 固定入口汇总报告：`data/reports/closed_loop/latest_closed_loop_report.json`
- 固定入口运行验收：`data/reports/closed_loop/latest_runtime_assess.json`
- 固定入口元信息：`data/reports/closed_loop/latest_run_meta.json`
- 固定入口 run_id：`data/reports/closed_loop/latest_run_id`
- 固定入口日报摘要：`data/reports/closed_loop/latest_daily_summary.json`
- 固定入口周报摘要：`data/reports/closed_loop/latest_weekly_summary.json`
- 模型注册索引：`data/models/registry/index.json`
- 当前激活模型元信息：`data/models/integrator_active.json`
- 基线冻结报告：`data/reports/closed_loop/latest/baseline_report.json`
- 数据质量门禁报告：`data/reports/closed_loop/latest/data_quality_report.json`

可手动重建日报/周报摘要（闭环脚本已默认自动执行）：
```bash
python3 tools/build_periodic_summary.py \
  --reports-root ./data/reports/closed_loop \
  --out-dir ./data/reports/closed_loop/summary
```

汇总报告中的账号盈亏主视图（建议重点查看）：
- `account_outcome.first_sample_utc / last_sample_utc`（窗口时间边界）
- `account_outcome.first_equity_usd`（窗口起始权益）
- `account_outcome.last_equity_usd`（窗口结束权益）
- `account_outcome.equity_change_usd`（绝对盈亏）
- `account_outcome.equity_change_pct`（收益率）
- `account_outcome.day_start_equity_usd`（当日首样本权益）
- `account_outcome.equity_change_vs_day_start_usd`（相对当日起点盈亏）
- `account_outcome.equity_change_vs_day_start_pct`（相对当日起点收益率）
- `account_outcome.max_equity_usd_observed`（窗口内权益峰值）
- `account_outcome.peak_to_last_drawdown_pct`（峰值到当前回撤）
- `account_outcome.max_drawdown_pct_observed`（窗口内最大回撤）

验收告警口径补充：
- `runtime.fail_reasons` 中，S5 当 Gate 窗口数 `>=10` 且 `gate_check_fail_ratio > 0.90` 时直接 FAIL（强闭环阻断）。
- `runtime.fail_reasons` 中，S5 当 `self_evolution_action_count >= 30`、`self_evolution_learnability_pass_count >= 10` 且
  `self_evolution_effective_update_count < CLOSED_LOOP_S5_MIN_EFFECTIVE_UPDATES` 时直接 FAIL（防止“学习空转假通过”）。
- `runtime.fail_reasons` 中，S5 当 `funnel_fills_runtime_count >= CLOSED_LOOP_S5_MIN_REALIZED_NET_PER_FILL_WINDOWS` 且
  `realized_net_per_fill < CLOSED_LOOP_S5_MIN_REALIZED_NET_PER_FILL_USD` 时直接 FAIL（执行收益质量门禁）。
- `runtime.fail_reasons` 中，S5 当启用 `CLOSED_LOOP_S5_MIN_EQUITY_CHANGE_USD` 且账户采样数达到阈值时，
  若 `equity_change_usd` 低于下限则直接 FAIL（权益门禁）。
- `runtime.fail_reasons` 中，S5 当启用 `CLOSED_LOOP_S5_MAX_EQUITY_VS_REALIZED_GAP_USD` 且账户采样数达到阈值时，
  若 `|equity_change_usd - realized_net_pnl_change_usd|` 高于上限则直接 FAIL（账面一致性门禁）。
- `runtime.warn_reasons` 中，S5 当 Gate 窗口数 `>=8` 且 `gate_check_fail_ratio > 0.85` 时标黄（不再要求已触发运行态限制）。
- `runtime.warn_reasons` 中，S5 当 `self_evolution_action_count >= 30`、`self_evolution_learnability_pass_count >= 10` 且
  `self_evolution_effective_update_count = 0` 时标黄，
  用于识别“学习长期空转（只评估不更新）”。
- S5 平仓起跑口径为“自动重定位”：若窗口首样本非平仓，验收会重定位到首个 `abs_notional <= 50` 的采样点继续评估；
  若整段日志无平仓采样点，仍按 FAIL 处理。
- S5 新增策略活跃性硬约束：`strategy_mix_nonzero_window_count >= 1`（至少一个窗口出现 `strategy_mix.samples > 0`），否则按 FAIL 处理，避免“零信号假通过”。

新增自进化运行指标（`runtime_assess.metrics`）：
- `self_evolution_virtual_action_count`：`SELF_EVOLUTION_ACTION` 中 `pnl_source=virtual` 的次数。
- `self_evolution_counterfactual_action_count`：`SELF_EVOLUTION_ACTION` 中 `counterfactual_search=true` 的次数。
- `self_evolution_counterfactual_update_count`：反事实搜索实际完成调权（`EVOLUTION_COUNTERFACTUAL_INCREASE/DECREASE_TREND`）次数。
- `self_evolution_factor_ic_action_count`：因子IC自适应调权次数（`EVOLUTION_FACTOR_IC_INCREASE/DECREASE_TREND`）。
- `self_evolution_effective_update_count`：有效学习更新次数（`counterfactual_update + factor_ic_action`）。
- `self_evolution_counterfactual_fallback_used_count`：反事实无提升时实际使用 factor-IC fallback 的次数。
- `self_evolution_counterfactual_superiority_skip_count`：反事实“候选-当前”配对统计门控未通过而跳过的次数（`EVOLUTION_COUNTERFACTUAL_SUPERIORITY_*`）。
- `self_evolution_learnability_pass_count`：可学习性门控通过次数（`learnability.passed=true`）。
- `self_evolution_learnability_skip_count`：可学习性门控导致跳过次数（`EVOLUTION_LEARNABILITY_*`）。
- `self_evolution_direction_consistency_pending_count`：方向一致性防抖导致延迟更新次数（`EVOLUTION_DIRECTION_CONSISTENCY_PENDING`）。
- `flat_start_rebase_applied_count`：S5 评估是否发生“首个平仓样本重定位”（1=发生，0=未发生）。

新增执行质量/对账异常运行指标（`runtime_assess.metrics`）：
- `execution_window_maker_fill_ratio_avg`：窗口 maker 成交占比均值。
- `filtered_cost_near_miss_ratio_avg`：成本门拦截中 near-miss 占比均值（越高说明门槛附近被拦截较多）。
- `entry_edge_gap_avg_bps`：窗口平均 `required_edge - expected_edge`（bps；正值越大表示离可交易门槛越远）。
- `execution_window_unknown_fill_ratio_avg`：窗口 unknown 成交占比均值（流动性归因缺失信号）。
- `execution_window_explicit_liquidity_fill_ratio_avg`：窗口显式流动性标签占比均值（交易所 `isMaker` 覆盖率）。
- `execution_window_fee_sign_fallback_fill_ratio_avg`：窗口 fee 符号兜底占比均值。
- `execution_window_explicit_liquidity_fills_avg / execution_window_fee_sign_fallback_fills_avg`：窗口显式标签/fee兜底的平均成交数。
- `execution_window_liquidity_source_runtime_count`：包含流动性来源细分字段的 `RUNTIME_STATUS` 样本数。
- `execution_window_maker_fee_bps_avg / execution_window_taker_fee_bps_avg`：窗口 maker/taker 费率均值（bps）。
- `execution_quality_guard_active_count`：`RUNTIME_STATUS` 中执行质量守卫 active 次数。
- `execution_quality_guard_penalty_bps_avg`：执行质量守卫附加门槛平均值（bps）。
- `execution_quality_guard_enter_count / execution_quality_guard_exit_count`：守卫进出场事件计数。
- `reconcile_anomaly_event_count`：`OMS_RECONCILE_ANOMALY_STREAK` 事件计数。
- `reconcile_anomaly_reduce_only_true_count`：运行态 `reconcile_runtime.anomaly_reduce_only=true` 次数。
- `reconcile_anomaly_reduce_only_true_ratio`：运行态 anomaly reduce-only 占比。
- `entry_gate_runtime_count`：包含 `entry_gate` 段的 `RUNTIME_STATUS` 样本数。
- `entry_gate_near_miss_tolerance_bps_avg`：运行时 near-miss 容差均值（bps）。
- `entry_gate_observed_filtered_ratio_avg`：成本门观测拦截比例均值。
- `entry_gate_observed_near_miss_ratio / entry_gate_observed_near_miss_ratio_avg`：near-miss 占比最新值/均值。
- `entry_gate_observed_near_miss_allowed_ratio / entry_gate_observed_near_miss_allowed_ratio_avg`：near-miss 放行占比最新值/均值。
- `concentration_runtime_count`：包含 `concentration` 段的 `RUNTIME_STATUS` 样本数。
- `concentration_top1_share_avg / concentration_top1_share_max`：Top1 仓位占比均值/最大值。
- `concentration_high_count`：`top1_share >= 0.90` 的高集中窗口数。
- `concentration_symbol_count_avg`：参与持仓符号数均值。

流动性归因质量软告警（S3/S5）：
- 若存在成交样本且 `execution_window_liquidity_source_runtime_count=0`，标记告警（运行时未输出 explicit/fallback 细分字段）。
- 若 `execution_window_explicit_liquidity_fill_ratio_avg < 0.70`，标记告警（显式流动性标签覆盖偏低）。
- 若 `execution_window_unknown_fill_ratio_avg > 0.20`，标记告警（unknown 成交占比偏高）。
- 若 `execution_window_fee_sign_fallback_fill_ratio_avg > 0.30`，标记告警（fee 符号兜底依赖偏高）。
- 若 `filtered_cost_ratio_avg >= 0.70` 且 `filtered_cost_near_miss_ratio_avg >= 0.10`，标记告警（门槛附近拦截偏高，建议复核 near-miss 容差与边际估计）。
- 若 `concentration_symbol_count_avg > 1.5` 且 `concentration_top1_share_max >= 0.90`，标记告警（仓位集中度偏高，建议复核 Universe 与单币风险预算）。

一键安装定时任务（推荐）：
```bash
cd /opt/ai-trade
ops/cron/install_closed_loop_cron.sh install \
  --repo-dir /opt/ai-trade \
  --compose-file docker-compose.prod.yml \
  --env-file .env.runtime \
  --stage S5
```

仅保留 assess 定时任务：
```bash
ops/cron/install_closed_loop_cron.sh install --disable-full
```

卸载定时任务：
```bash
ops/cron/install_closed_loop_cron.sh uninstall
```

模板文件：`ops/cron/closed-loop.cron.example`。

默认会安装第三条 cleanup 定时任务：
- 回收历史 run 目录与日报/周报文件；
- 按大小截断 `data/reports/closed_loop/cron.log`；
- 输出到 `data/reports/closed_loop/gc.log`。

## 配置加载逻辑

> **注意**: 风控参数 (`risk.*`) 不支持热加载。修改风控参数必须重启进程，以防止运行时意外修改导致风控失效。

1. 加载默认硬编码配置 (Safe Defaults)。
2. 加载 YAML 配置文件。
3. 加载环境变量覆盖。
4. **校验**: 
   - 检查风控参数是否宽松于硬编码限制（如 YAML 设置熔断为 50%，系统应拒绝启动）。
   - 检查 API Key 格式。
   - 检查自进化配置合法性（更新周期、步长、回滚窗口、冷却期）。
  - 检查自进化样本门槛：`self_evolution.min_abs_window_pnl_usd >= 0`。
  - 检查自进化方向防抖门槛：`self_evolution.min_consecutive_direction_windows > 0`。
  - 检查自进化虚拟PnL参数：`self_evolution.counterfactual_min_improvement_usd >= 0`、`self_evolution.counterfactual_min_improvement_ratio_of_equity ∈ [0,1]`、`self_evolution.counterfactual_improvement_decay_per_filtered_signal_usd >= 0`、`self_evolution.counterfactual_min_fill_count_for_update >= 0`、`self_evolution.counterfactual_min_t_stat_samples_for_update >= 0`、`self_evolution.counterfactual_min_t_stat_abs_for_update >= 0`、`self_evolution.counterfactual_superiority_min_samples_for_update >= 0`、`self_evolution.counterfactual_superiority_min_t_stat_for_update >= 0`、`self_evolution.virtual_cost_bps >= 0`、`self_evolution.virtual_cost_dynamic_max_multiplier >= 1`、`|self_evolution.virtual_funding_rate_per_tick| <= 0.01`。
  - 检查因子IC/可学习性参数：`factor_ic_min_samples >= 0`、`factor_ic_min_abs >= 0`、`learnability_min_samples >= 0`、`learnability_min_t_stat_abs >= 0`。
  - 检查权重约束（`0<=w_i<=max_single_strategy_weight`、权重和=1）。
   - 检查保护单配置：`enabled=true` 时必须 `require_sl=true` 且 `attach_timeout_ms>0`。
   - 检查保护单参数：`execution.protection.stop_loss_ratio>0`；当 `enable_tp=true` 时 `execution.protection.take_profit_ratio>0`。
   - 检查执行防抖参数：`execution.min_order_interval_ms >= 0`、`execution.reverse_signal_cooldown_ticks >= 0`、`execution.min_rebalance_notional_usd >= 0`、`execution.max_inflight_orders_per_symbol_direction >= 0`。
   - 检查 VolTarget 防抖参数：`strategy.vol_target_rebalance_min_abs_usd >= 0`、`strategy.vol_target_rebalance_min_ratio ∈ [0,1]`。
   - 检查成本门扩展参数：`adaptive_fee_gate_trigger_ratio ∈ [0,1]`、`adaptive_fee_gate_max_relax_bps >= 0`、`maker_edge_relax_bps >= 0`、`dynamic_edge_*_bps >= 0`、`dynamic_edge_liquidity_*_threshold ∈ [0,1]`、`cost_filter_cooldown_trigger_count` 与 `cost_filter_cooldown_ticks` 需同时>0或同时为0。
   - 检查执行质量守卫参数：`quality_guard_*` 整数项 `>=0`、`quality_guard_max_fee_bps_per_fill >= 0`、`quality_guard_required_edge_penalty_bps >= 0`。
   - 检查执行成本参数：`execution.entry_fee_bps/exit_fee_bps/expected_slippage_bps/min_expected_edge_bps/required_edge_cap_bps/entry_gate_near_miss_tolerance_bps/entry_gate_near_miss_maker_max_gap_bps/maker_price_offset_bps >= 0`。
   - 检查策略防抖参数：`strategy.signal_notional_usd >= 0`、`strategy.signal_deadband_abs >= 0`、`strategy.min_hold_ticks >= 0`。
   - 检查 Integrator 接管参数：`mode` 属于 `off/shadow/canary/active`；`canary_notional_ratio/canary_confidence_threshold/active_confidence_threshold/active_partial_notional_ratio/active_full_notional_confidence_threshold` 均在 `[0,1]`，且 `canary_min_notional_usd >= 0`、`active_min_notional_usd >= 0`。
   - 检查 Integrator active 阈值关系：`active_full_notional_confidence_threshold >= active_confidence_threshold`。
   - 检查 Integrator 模式阈值：`mode=canary` 时 `canary_confidence_threshold>=0.5`；`mode=active` 时 `active_confidence_threshold>=0.5`。
   - 检查 Integrator 影子模型参数：`integrator.shadow.score_gain > 0`，且启用时 `integrator.shadow.model_report_path` 非空。
   - 检查运行控制参数：`system.max_ticks >= 0`、`system.status_log_interval_ticks >= 0`、`system.remote_risk_refresh_interval_ticks >= 0`。
   - 检查对账参数：`system.reconcile.mismatch_confirmations > 0`、`system.reconcile.pending_order_stale_ms > 0`。
   - 检查对账异常保护参数：`system.reconcile.anomaly_reduce_only_streak/anomaly_halt_streak/anomaly_resume_streak >= 0`。
   - 检查 Gate 运行时动作参数：`fail_to_reduce_only_windows/fail_to_halt_windows/reduce_only_cooldown_ticks/halt_cooldown_ticks/pass_to_resume_windows >= 0`。
   - 检查 `system.primary_symbol` 非空。
   - 检查 Bybit 账户门禁参数合法：`expected_account_mode / expected_margin_mode / expected_position_mode`。
   - 检查 Bybit 环境模式：禁止 `testnet=true` 与 `demo_trading=true` 同时启用。
   - 检查 Bybit 通道参数：`execution_poll_limit > 0`、`ws_reconnect_interval_ms >= 0`，并建议
     `public_ws_enabled=true + public_ws_rest_fallback=true + private_ws_enabled=true + private_ws_rest_fallback=true`。
   - 检查 UniverseSelector 参数：`min_active_symbols >= 1`、`max_active_symbols >= min_active_symbols`、`fallback_symbols` 非空。
   - 检查 UniverseSelector 权重和为 1（容差 `1e-6`）。
   - 检查候选池与交易所可交易列表有交集，否则拒绝启动或降级。
   - 检查 Regime 映射完整性（四态必须全部覆盖，且值只能在 `regime_buckets` 内）。
   - 检查 Regime 切换确认参数：`regime.switch_confirm_ticks >= 0`（建议生产环境设置 >1 抗抖）。
   - 检查学习模块写入边界：禁止任何 `risk.*` 字段被学习结果覆盖。

## 阶段3（因子-模型-风控闭环前两级）规划配置

> 本节为规划配置草案，当前版本默认**不读取**这些字段。  
> 目的：提前固定字段命名与版本治理口径，便于后续实现对齐。

```yaml
research:
  enabled: false
  data:
    source: "bybit_kline"          # 历史数据来源（规划）
    category: "linear"
    symbols: ["BTCUSDT", "ETHUSDT", "SOLUSDT"]
    interval_minutes: 5
    lookback_days: 180
    storage_path: "./data/research"
  miner:
    engine: "gplearn"              # gplearn / deap（规划）
    random_seed: 42
    max_formula_depth: 6
    population_size: 200
    generations: 50
    operators: ["ts_delay", "ts_delta", "ts_rank", "ts_corr"]
    objective: "spearman_ic"
    min_oos_ic: 0.01

integrator:
  enabled: false
  model_type: "catboost"
  train:
    window_days: 90
    predict_horizon_bars: 12
    split_method: "rolling"        # rolling / timeseriessplit
    rolling_step_days: 1
    optuna_trials: 50
  shadow:
    enabled: true
    log_model_score: true
    require_feature_schema_match: true
  registry:
    model_dir: "./data/models"
    max_versions: 20
    rollback_on_health_fail: true
```

说明：
- `research.*` 用于离线因子挖掘（Miner），核心产物是 `factor_set_version` 与表达式元数据。
- 当前代码已支持 `--run_miner` 离线入口（CSV -> 因子报告），但 `research.*` 字段仍处于“规划中，未直接驱动运行参数”状态。
- 当前 Miner 报告已包含随机基线对照字段（`random_baseline_oos_abs_ic`、`oos_not_worse_than_random`）和滚动 IC 分布字段（`rolling_ic_train/rolling_ic_oos`）。
- `integrator.*` 用于 CatBoost 训练与影子推理（Integrator）。
  - 当前已提供离线训练脚本：`tools/integrator_train.py`（输入 `ohlcv_5m.csv + miner_report.json`，输出 `integrator_report.json + .cbm`）。
  - 训练治理门槛支持：
    - `--min_auc_mean` / `--min_delta_auc_vs_baseline` / `--min_split_trained_*`
    - `--max_auc_stdev`（AUC 稳定性约束）
    - `--max_train_test_auc_gap`（过拟合约束）
    - `--max_random_label_auc`（随机标签对照约束，默认启用，可用 `--disable_random_label_control` 关闭）
  - 标签口径默认采用反泄漏定义：`feature@t` 对齐 `return(t+1 -> t+h+1)`。
  - 当前 C++ 交易主进程已读取基础接管字段：`enabled/model_type/mode/canary_*/active_*/shadow.*`。
  - `integrator.train.*` 与 `integrator.registry.*` 仍处于规划字段阶段，当前版本不会直接读取。
- 历史样本数据是阶段3前两级的前置依赖，需包含 OHLCV + 基础交易元数据（时间、symbol、成交量等）。
- 即便未来启用上述配置，`risk.*` 仍属于不可动层，不可被学习结果覆盖。
