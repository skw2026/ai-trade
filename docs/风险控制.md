# 风控/执行/OMS/Gate（含交易所模拟盘撮合回归）+ 实施计划（模块级）

## 1. 风控引擎（Hard Risk）— 最高优先级
### 1.1 风控状态机
- NORMAL：正常
- DEGRADED：降档（risk_budget下调、门槛提高）
- COOLDOWN：冷却（强制减仓；只减仓不加仓）
- FUSE：熔断（经济意义全平）+ 冷却 + 分段恢复
- REDUCE_ONLY：只减仓（trade_ok=false 或关键异常触发）

### 1.2 回撤三阈值（账户级，MDD目标20%）
- DD≥8%：进入DEGRADED
- DD≥12%：进入COOLDOWN（强制减仓 + 6h冷却建议）
- DD≥20%：进入FUSE（经济意义全平 + 24h冷却建议 + 25%预算分段恢复）
要求：
- 触发后60s内状态生效并审计
- 10min内风险改善趋势可观测（margin_used下降或liq_distance上升）
- FUSE“全平”口径定义为经济意义全平：
  - 所有可交易仓位必须清零
  - 仅允许保留无法通过交易所最小名义价值规则处理的尘埃仓位（dust）
  - 尘埃仓位必须标记 `DUST_LOCKED`，禁止加仓，直到可通过合并成交或人工流程清理

### 1.3 强平距离（加权P95）
- 多：(mark-liq)/mark；空：(liq-mark)/mark；按notional加权
- P95<8%：强制减仓；目标恢复≥10%
- 低于阈值时禁止加仓（REDUCE_ONLY优先）

### 1.4 杠杆/逐仓/事件降档
- 逐仓强制：发现cross即阻断开/加仓
- 杠杆白名单：BTC/ETH≤3x；SOL≤2x；event_window/EXTREME=1x
- event_window=true：risk_budget下调；可选冻结SOL新开仓（更稳）

### 1.5 断连与健康门禁
- trade_ok=false：REDUCE_ONLY（只减仓）
- data_ok=false：禁止开新仓；必要时降风险
- 对账异常：降档/冻结symbol（视严重性）

### 1.6 人工干预 (Kill Switch)
系统必须提供带鉴权的 HTTP 接口或信号处理（SIGUSR1）以支持人工介入：
- **Force Halt**: 立即停止所有下单，取消所有挂单（Panic Mode）。
- **Force Reduce**: 强制执行平仓流程（不计成本）。
- **Reset FUSE**: 仅在人工确认系统正常后，通过特定指令重置熔断状态（需审计）。
- **Force Unlock Symbol**: 针对处于 `DUST_LOCKED` 或 `FREEZE` 状态的 Symbol，在人工确认链下已处理完毕后，强制重置其风控状态为 NORMAL（需审计）。

---

## 2. 执行引擎（Execution）
### 2.1 目标仓位逼近（Rebalance）
- 输入：RiskAdjustedPosition（风控后的目标）
- delta=target-current；加入迟滞/最小间隔防抖
- COOLDOWN/REDUCE_ONLY：只允许降低敞口方向的交易

### 2.2 下单策略（原则）
- 限价为主（可配置偏移）；减仓允许更激进但受控
- 超时撤单重挂：max_order_age 到期撤单并重新挂
- **合规过滤器 (Exchange Filters)**: 下单前必须通过交易所规则校验，否则直接丢弃或修正：
  - `min_notional`: 若名义价值 < 5U (Binance)，直接忽略并审计 `EXEC_FILTER_IGNORE`。
    - **修正逻辑**: 若 `abs(TargetPosition) < min_notional`，则强制将 `TargetPosition` 修正为 0。避免策略持续发出“买不起”的微小仓位指令导致死循环。
    - **例外（FUSE/强制平仓）**: 若意图是平仓 (Target=0) 且持仓本身 < 5U (尘埃仓位)，不得判定为熔断失败；改为记录 `EXEC_DUST_POSITION_STUCK`，并将该仓位置为 `DUST_LOCKED`（只允许净减，不允许任何加仓）。
  - `step_size/tick_size`: 数量和价格必须按交易所精度取整（向下取整）。
  - `max_leverage`: 再次校验是否超过当前 Symbol 允许的最大杠杆。
- 拆单：按最大单笔notional、深度估计、最小下单量拆分
- 限频：token bucket；触发后退避并降档
- 降级：
  - 拒单率异常：缩单/降频/冻结symbol
  - 滑点/点差超预算：缩单/提高门槛/冻结symbol

### 2.3 可选保护单（SL优先，TP次之）
- 开关：`execution.protection.enabled`
- 启用后，对每笔新开仓（非纯减仓）执行：
  - 必须优先提交 SL 保护单（`reduce_only=true`）
  - 可选提交 TP 保护单（`reduce_only=true`）
  - 要求在 `attach_timeout_ms` 内完成挂单确认
- 触发优先级：
  - 同时满足 TP 与 SL 条件时，以 SL 先执行（防止保护失效）
  - 任一保护单成交后，必须自动撤销同仓位的对侧保护单（OCO 语义）
- 降级规则：
  - SL 挂单失败/超时：拒绝保留新增敞口，触发 `REDUCE_ONLY` 或冻结 symbol，并审计 `EXEC_PROTECTIVE_ORDER_MISSING`
  - TP 挂单失败：允许继续持仓，但必须审计 `EXEC_TP_ATTACH_FAILED`

### 2.4 幂等（必须）
- client_order_id 为幂等键
- 重试必须使用同一 client_order_id
- 首次生成后必须持久化（OrderIntent/本地WAL）；任何重试禁止重新生成
- OMS必须能识别并避免“重复下单”带来的双开仓

---

## 3. OMS/AccountState/对账
### 3.1 订单状态机（允许转移表）
- `NEW -> SENT`
- `SENT -> ACK | REJECTED | CANCELLED`
- `ACK -> PARTIAL | FILLED | CANCELLED | REJECTED`
- `PARTIAL -> PARTIAL | FILLED | CANCELLED | REJECTED`
- `FILLED` 为终态
- `CANCELLED` 为终态
- `REJECTED` 为终态

### 3.2 AccountState（风控依赖）
- equity、peak_equity、drawdown_pct
- margin_used_pct（保证金占用）
- liq_distance_pct（强平距离）
- positions（每symbol：qty、entry、liq、mark、notional）

### 3.3 对账（必须有）
- 定时拉取交易所仓位/余额与本地比对
- 发现差异：
  - 轻微：告警 + 标记degraded
  - 严重：冻结交易/只减仓，并审计 OMS_RECONCILE_MISMATCH

---

## 4. 撮合/执行回归：使用交易所模拟盘（替代自建撮合器）
> 目标：验证真实交易所撮合规则、限频、拒单、部分成交、精度、保证金等，确保执行链路与风控动作在真实规则下成立。

### 4.1 必测验证点（模拟盘E2E）
- 下单/撤单：成功率、延迟分布、超时重挂是否稳定
- 幂等：重复client_order_id不产生多笔有效订单
- 部分成交：partial fill 是否正确更新仓位与剩余订单
- 精度/最小量：不合规请求被拒后是否正确降级并审计
- 限频：触发rate limit后退避/降档是否生效
- 保证金不足：拒单处理是否正确；是否进入只减仓
- 断连重连：恢复后订单与仓位可对账修正
- event_window/EXTREME降档：杠杆降至1x、risk_budget下调是否可验证

---

## 5. Gate流程（准入）与回滚
### 5.1 Gate默认流程
1) Replay回归（固定样本）PASS  
2) 模拟盘E2E（撮合回归）PASS  
3) Shadow（纸交易/或模拟盘低风险）≥14天 PASS（KRI优先）  
4) （可选）小实盘≥14天 PASS（受限风险预算）

### 5.2 Gate报告字段（最小）
- period：起止时间
- version_set：config/strategy_bundle/regime/git
- verdict：PASS/FAIL
- kri：
  - mdd_rolling
  - liq_distance_p95
  - leverage_violation_count
  - reduce_only_violation_count
  - data_gap_seconds
  - exec_reject_rate
  - effective_signals_per_day
  - fills_per_day
- actions_summary：风险动作次数（DOWNGRADE/REDUCE/FUSE/REDUCE_ONLY等）
- fail_reasons[]：
  - FAIL_MDD_EXCEEDED
  - FAIL_LIQ_DISTANCE_LOW
  - FAIL_LEVERAGE_VIOLATION
  - FAIL_REDUCE_ONLY_VIOLATION
  - FAIL_EXEC_ERROR_RATE
  - FAIL_REJECT_RATE
  - FAIL_DATA_GAP
  - FAIL_LOW_ACTIVITY_SIGNALS
  - FAIL_LOW_ACTIVITY_FILLS
  - FAIL_PROTECTIVE_ORDER_MISSING

### 5.3 Gate 判定规则（硬约束）
- KRI 一票否决：任一硬性 KRI 失败，`verdict=FAIL`
- 仅当 KRI 全通过时，才允许用 KPI 评估“是否值得上线/扩容”
- 自进化版本与基础版本使用同一套 KRI 判定口径，不允许“学习版本降标准”
- 最小活跃度门槛：
  - `effective_signals_per_day >= 24`（可配置）
  - `fills_per_day >= 4`（可配置）
  - 任一不满足直接 FAIL（防“零交易通过”）

### 5.4 回滚策略（必须可演练）
- 触发条件：
  - 任一KRI fail、执行退化、数据异常
  - 连续2个评估周期性能/风险劣化
  - 重大违规（杠杆越界、reduce-only违规）立即触发
- 回滚动作：
  - 切回上一版本（config + strategy_bundle + regime）
  - 强制进入DEGRADED/COOLDOWN观察窗口
  - 回滚后24h暂停学习更新（仅允许风险收敛动作）
  - 审计：回滚原因、版本、影响范围、恢复策略

---

## 6. 实施计划（工程任务：MVP → 阶段2 → 阶段3）

### 6.1 关键路径（Critical Path）
- CP1：可观测骨架（配置/日志/指标/审计/事件总线）
- CP2：交易闭环（交易所适配→OMS→Risk→Execution→模拟盘E2E）
- CP3：最小策略闭环（Feature→Trend/VolTarget→Portfolio→Risk→Execution）

### 6.2 MVP（BTC/ETH）模块级子任务清单（最小可交付子集）
A. Core
- 配置加载+校验+版本号
- 审计事件落地（可回放）
- 指标框架与关键KRI指标
- 事件总线/队列+水位监控

B. Exchange
- 行情WS（重连/心跳/订阅）
- 交易REST（下单撤单查询）
- 合约规则缓存（精度/最小量）
- 错误码映射（限频/拒单/保证金不足）

C. OMS/AccountState
- 订单状态机
- 仓位与权益更新
- liq_distance/drawdown计算
- 对账与差异处理

D. Risk（Hard）
- 回撤阈值状态机（8/12/20）
- 强平距离阈值（P95<8%强减仓）
- 杠杆白名单+逐仓强制
- trade_ok/data_ok门禁（只减仓/禁止开仓）
- event_window降档（先手工配置）

E. Execution
- 目标仓位逼近（含只减仓限制）
- 限价下单+超时撤单重挂
- 幂等（client_order_id）
- 限频退避+拒单降级+冻结symbol

F. Feature/Strategy/Portfolio（最小）
- Feature：EMA/ATR/rv/breakout
- Strategy：Trend + VolTarget
- Portfolio：固定权重聚合 + 风险预算裁剪 + 输出TargetPosition（含components）

G. 测试与Gate
- Replay回归（固定样本）
- 交易所模拟盘E2E（撮合回归）
- Shadow ≥14天 + Gate报告

### 6.3 阶段2（自进化上线）
- Regime四态完善
- MeanRev上线（RANGE专用）
- Bandit调权（受约束）+ 权重持久化 + 权重审计
- 自动回滚演练（故意触发fail_reasons）

### 6.4 阶段3（扩展SOL）
- SOL合约规则/执行参数分化（更保守）
- event_window服务化（可接入外部源，仍以风险降档为主）
- Gate增加SOL专项指标与冻结策略
