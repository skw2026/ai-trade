# 开发指南 (Developer Guide)

## 1. 技术栈与环境

- **语言标准**: C++20
  - **GCC**: 10.0+ (推荐 11.2+)
  - **Clang**: 12.0+ (推荐 14.0+)
  - **MSVC**: VS2019 16.11+
- **构建系统**: CMake 3.20+
- **包管理**: vcpkg (推荐) 或 Conan
- **核心依赖**:
  - `boost`: Asio (网络), Beast (WebSocket), CircularBuffer
  - `fmt`: 格式化日志
  - `nlohmann/json`: JSON 序列化
  - `spdlog`: 高性能日志
  - `openssl`: 加密签名
  - `prometheus-cpp`: 指标暴露

## 2. 环境搭建 (MacOS/Linux)

```bash
# 1. 安装 vcpkg
git clone https://github.com/microsoft/vcpkg
./vcpkg/bootstrap-vcpkg.sh

# 2. 安装依赖
./vcpkg/vcpkg install boost fmt nlohmann-json spdlog openssl prometheus-cpp

# 3. 克隆项目
git clone <your-repo-url>/ai-trade.git
cd ai-trade
```

## 3. 构建与编译

```bash
# 配置 CMake (假设 vcpkg 在上级目录，使用 -S 源目录 -B 构建目录 的现代语法)
cmake -S . -B build -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake

# 编译
cmake --build build -j 8
```

### 3.1 Docker 统一编译环境（推荐）

> 适用于本机依赖不一致（如 Boost/OpenSSL/libcurl 版本差异）场景。

```bash
# 在项目根目录执行，构建阶段会自动执行 ctest
docker build -t ai-trade:latest .

# 回放模式运行
docker run --rm \
  -v "$(pwd)/config:/app/config:ro" \
  -v "$(pwd)/data:/app/data" \
  ai-trade:latest --config=config/bybit.replay.yaml --exchange=bybit
```

说明：
- Dockerfile 默认开启 `-DAI_TRADE_USE_BEAST_WEBSOCKET=ON`，可修复部分环境中 `libcurl` 不支持 `wss` 的握手失败问题。
- 本地若也需要同样行为，可显式配置：`cmake -S . -B build -DAI_TRADE_USE_BEAST_WEBSOCKET=ON`（需安装 Boost + OpenSSL）。

使用 docker compose：
```bash
# 首次请先准备 .env（AK/SK 注入）
cp .env.example .env
# 编辑 .env，填入对应环境的 Bybit AK/SK

docker compose up --build ai-trade
```

可观测性（Prometheus + Grafana + Loki + Promtail）：
```bash
# 启动监控栈（obs profile）
docker compose --profile obs up -d loki promtail prometheus grafana

# 查看监控容器状态
docker compose ps
```

访问地址：
- Grafana: `http://<host>:3000`
- Prometheus: `http://<host>:9090`
- Loki: `http://<host>:3100`

安全提示：
- 生产编排中监控端口默认绑定 `127.0.0.1`，如需公网访问请显式设置
  `GRAFANA_BIND_ADDRESS/PROMETHEUS_BIND_ADDRESS/LOKI_BIND_ADDRESS=0.0.0.0`；
- 公网访问必须配合安全组白名单与强密码。

说明：
- Promtail 通过 Docker Socket 自动采集 `ai-trade` / `ai-trade-research` 容器日志；
- Promtail 会把 `RUNTIME_STATUS` 与关键事件转成 Prometheus 指标（无需改业务埋点）；
- Grafana 已预置 `ai-trade Runtime`（Loki）与 `ai-trade Metrics Runtime (Prometheus)` 两套仪表盘；
- Grafana 登录账号密码来自 `.env`：`GRAFANA_ADMIN_USER` / `GRAFANA_ADMIN_PASSWORD`。

paper/demo 运行示例：
```bash
# 读取 .env 中 AK/SK
docker compose run --rm ai-trade --config=config/bybit.paper.yaml --exchange=bybit
```

## 4. 运行模式

系统通过配置文件中的 `system.mode` 管理运行模式（`replay/paper/live`），命令行以 `--config` 为主，不使用 `--mode` 参数。

### 4.1 回放模式 (Replay)
用于策略回归和逻辑验证。
```bash
./build/trade_bot --config=config/bybit.replay.yaml --exchange=bybit --max_ticks=500
```

### 4.2 模拟盘模式 (Paper Trading / Simulation)
连接 Bybit Testnet 或 Bybit Demo Trading（主网模拟盘）。
```bash
# testnet
./build/trade_bot --config=config/bybit.paper.yaml --exchange=bybit
```

Bybit V5 推荐运行示例（与当前工程实现一致）：
```bash
# testnet
export AI_TRADE_BYBIT_TESTNET_API_KEY=your_testnet_key
export AI_TRADE_BYBIT_TESTNET_API_SECRET=your_testnet_secret
./build/trade_bot --config=config/bybit.paper.yaml --exchange=bybit

# demo trading（主网模拟盘）
export AI_TRADE_BYBIT_DEMO_API_KEY=your_demo_key
export AI_TRADE_BYBIT_DEMO_API_SECRET=your_demo_secret
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit
```

稳态参数模板（推荐先用这组跑长时间观察）：
```bash
# Demo（主网模拟盘）
./build/trade_bot --config=config/bybit.demo.stable.yaml --exchange=bybit --run_forever

# Paper（testnet）
./build/trade_bot --config=config/bybit.paper.stable.yaml --exchange=bybit --run_forever
```

Demo 自进化保守模板（建议先用这组）：
```bash
# 本地运行（主网模拟盘 + 自进化）
./build/trade_bot --config=config/bybit.demo.evolution.yaml --exchange=bybit --run_forever

# Docker Compose 运行（读取 .env 中 AK/SK）
docker compose run --rm ai-trade --config=config/bybit.demo.evolution.yaml --exchange=bybit --run_forever
```

Demo 激进模板（仅建议模拟盘；便于加快样本积累）：
```bash
./build/trade_bot --config=config/bybit.demo.aggressive.yaml --exchange=bybit --run_forever
```

建议观察以下日志字段是否符合预期：
- `SELF_EVOLUTION_INIT`：确认初始权重与更新周期生效
- `SELF_EVOLUTION_ACTION`：确认更新/回滚/冷却行为
- `RUNTIME_STATUS ... evolution={...}`：持续观察当前权重、下一次评估 tick、冷却状态

运行控制参数（可与以上命令组合）：
```bash
# 持续运行（默认等价于 system.max_ticks=0）
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --run_forever

# 跑固定市场tick后退出
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --max_ticks=500

# 调整周期状态日志频率（0=关闭）
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --status_log_interval_ticks=10

# 调整远端风险字段刷新频率（按市场tick；0=关闭）
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --remote_risk_refresh_interval_ticks=10
```

### 4.2.0 研究数据准备（Bybit 历史 K 线）

在执行 R1/R2 前，请先准备 `timestamp,open,high,low,close,volume` 格式的 CSV：

```bash
# 本机 Python
python3 tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv

# Docker
docker compose run --rm --entrypoint python3 ai-trade-research \
  tools/fetch_bybit_kline.py \
  --symbol=BTCUSDT \
  --interval=5 \
  --category=linear \
  --bars=5000 \
  --output=./data/research/ohlcv_5m.csv
```

验收要点：
- 日志出现 `FETCH_START` / `FETCH_PAGE` / `FETCH_DONE`
- 输出文件存在且包含表头：`timestamp,open,high,low,close,volume`
- `FETCH_DONE` 中 `bars` 与预期近似一致（受交易日历/停盘影响可有偏差）

### 4.2.1 Stage R1（离线 Miner）最小运行

当前版本已提供离线 Miner CLI 入口（不接管交易主链路）：

```bash
# 运行离线 Miner（CSV 需包含 timestamp,open,high,low,close,volume 列）
./build/trade_bot \
  --run_miner \
  --miner_csv=./data/research/ohlcv_5m.csv \
  --miner_top_k=10 \
  --miner_generations=4 \
  --miner_population=32 \
  --miner_elite=8 \
  --miner_output=./data/research/miner_report.json
```

验收要点：
- 日志出现 `MINER_START` 与 `MINER_DONE`
- 输出报告包含 `factor_set_version`、`candidate_expressions`、`factors`
- `candidate_expressions` 覆盖 `ts_delay/ts_delta/ts_rank/ts_corr`
- 输出报告包含随机基线与分布字段：`random_baseline_oos_abs_ic`、`oos_random_baseline_threshold_p90`、`top_factor_oos_abs_ic`
- 输出报告包含代际统计字段：`generations`、`population_size`、`generation_summaries`

### 4.2.2 Stage R2（离线 Integrator/CatBoost）最小运行

R2 使用独立研究脚本（不接管交易主链路）：

```bash
# 本机 Python（需先安装研究依赖）
pip install -r tools/requirements-research.txt
python3 tools/integrator_train.py \
  --csv=./data/research/ohlcv_5m.csv \
  --miner_report=./data/research/miner_report.json \
  --output=./data/research/integrator_report.json \
  --model_out=./data/models/integrator_latest.cbm \
  --split_method=rolling \
  --n_splits=5 \
  --train_window_bars=800 \
  --test_window_bars=120 \
  --rolling_step_bars=120 \
  --predict_horizon_bars=1
```

Docker 方式（推荐，避免本机依赖不一致）：

```bash
docker compose run --rm ai-trade-research \
  --csv=./data/research/ohlcv_5m.csv \
  --miner_report=./data/research/miner_report.json \
  --output=./data/research/integrator_report.json \
  --model_out=./data/models/integrator_latest.cbm
```

验收要点：
- 日志出现 `INTEGRATOR_START` / `INTEGRATOR_SPLIT` / `INTEGRATOR_DONE`
- 报告包含 `model_version`、`feature_schema_version`、`metrics_oos`、`feature_importance`
- `metrics_oos.splits` 中每个 split 都有明确的 train/test 时间窗口
- 产物中包含基线对照：`baseline_auc` 与 `delta_auc_vs_baseline`
- 训练口径固定为 `t` 特征预测 `t+1...t+h`（反前视）

### 4.2.3 闭环编排（R0/R1/R2 + 运行验收 + 汇总报告）

项目已提供一键闭环脚本：`tools/closed_loop_runner.sh`。

本地执行示例：
```bash
# 训练闭环：R0 -> R1 -> R2 -> 模型注册 -> 汇总报告
tools/closed_loop_runner.sh train

# 运行态验收闭环：导出日志 -> S5 判定 -> 汇总报告
tools/closed_loop_runner.sh assess --stage S5 --since 4h

# 全流程闭环
tools/closed_loop_runner.sh full --stage S5 --since 4h

# 数据加速链路
tools/closed_loop_runner.sh data --data-config config/data_pipeline.yaml

# 产物回收（可手动执行）
tools/recycle_artifacts.sh \
  --reports-root ./data/reports/closed_loop \
  --keep-run-dirs 120 \
  --keep-daily-files 120 \
  --keep-weekly-files 104
```

说明：
- `train/full` 会先执行 `D1 baseline freeze`（冻结当前 active 模型快照）
- 紧接执行 `D2 data quality gate`（样本不足/脏数据会直接阻断训练）
- `data` 会执行归档下载、增量同步、缺口回补、特征构建与 walk-forward 回测
- 产物分别写入：`baseline_report.json`、`data_quality_report.json`
- 每次运行结束会自动执行产物回收，防止报告目录无限增长

ECS（生产编排）执行示例：
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime

tools/closed_loop_runner.sh full \
  --compose-file docker-compose.prod.yml \
  --env-file .env.runtime \
  --output-root ./data/reports/closed_loop \
  --stage S5 \
  --since 4h
```

生产常驻闭环执行（推荐）：
```bash
cd /opt/ai-trade
set -a && source .env.runtime && set +a
export AI_TRADE_PROJECT_DIR=/opt/ai-trade
export AI_TRADE_ENV_FILE=.env.runtime
docker compose -f docker-compose.prod.yml --env-file .env.runtime up -d ai-trade watchdog scheduler
```

定时执行模板：`ops/cron/closed-loop.cron.example`（含 cleanup 定时回收任务）。

产物说明：
- 单次运行目录：`data/reports/closed_loop/<UTC_RUN_ID>/`
- 最新运行软链接：`data/reports/closed_loop/latest`
- 汇总报告：`data/reports/closed_loop/latest/closed_loop_report.json`
- 模型注册索引：`data/models/registry/index.json`

账号盈亏主视图（在 `closed_loop_report.json`）：
- `account_outcome.first_equity_usd`
- `account_outcome.last_equity_usd`
- `account_outcome.equity_change_usd`
- `account_outcome.equity_change_pct`

### 4.3 实盘模式 (Live)
**警告**: 必须通过 Gate 验证后方可运行。
```bash
./build/trade_bot --config=config/bybit.mainnet.yaml --exchange=bybit --run_forever
```

说明：
- 当前仓库默认提供 replay/paper/demo 配置模板。
- 如需真实主网 live，请单独准备主网配置（`system.mode=live` + `testnet=false` + `demo_trading=false`）并完成 Gate 放行。

## 5. 模拟交易所 (Exchange Simulator)

当前仓库未内置 `tools/exchange_sim` 本地撮合器，建议直接使用 Bybit `paper/demo` 完成 E2E 回归（拒单、部分成交、对账、重连、降级路径）。

## 6. 代码规范

- **命名**: Google C++ Style Guide
- **格式化**: 提交前请运行 `clang-format`
- **测试**: 单元测试使用 GTest
  ```bash
  cd build
  ctest
  ```

## 7. 常见问题排查（Bybit）

- 报错：`retCode=10001, Qty invalid`
  - 当前实现会在连接后读取 `GET /v5/market/instruments-info`，并按交易规则自动处理下单数量：
    - 按 `qtyStep` 向下量化
    - 校验 `minOrderQty`
    - 校验（非 reduce_only）`minNotionalValue`
  - 系统会将 `candidate_symbols + fallback_symbols + primary_symbol` 与交易所 `symbol` 规则做交集过滤：
    - 非 `TRADING` 状态会被过滤
    - 若获取到规则但全部被过滤，进程会拒绝启动（避免“全是不可交易币对”）
  - 若仍出现该错误，优先检查：
    - 配置中 `execution.max_order_notional` 是否过小（导致量化后低于最小下单量）
    - 目标 symbol 是否在当前账户可交易
    - 日志中是否有“数量低于最小下单数量/最小名义金额”的拒单提示
