# 开发指南 (Developer Guide)

## 1. 技术栈与环境

- **语言标准**: C++20
  - **GCC**: 10.0+ (推荐 11.2+)
  - **Clang**: 12.0+ (推荐 14.0+)
  - **MSVC**: VS2019 16.11+
- **构建系统**: CMake 3.20+
- **包管理**: vcpkg (推荐) 或 Conan
- **核心依赖**:
  - `boost`: Asio (网络), Beast (WebSocket), CircularBuffer
  - `fmt`: 格式化日志
  - `nlohmann/json`: JSON 序列化
  - `spdlog`: 高性能日志
  - `openssl`: 加密签名
  - `prometheus-cpp`: 指标暴露

## 2. 环境搭建 (MacOS/Linux)

```bash
# 1. 安装 vcpkg
git clone https://github.com/microsoft/vcpkg
./vcpkg/bootstrap-vcpkg.sh

# 2. 安装依赖
./vcpkg/vcpkg install boost fmt nlohmann-json spdlog openssl prometheus-cpp

# 3. 克隆项目
git clone <your-repo-url>/ai-trade.git
cd ai-trade
```

## 3. 构建与编译

```bash
mkdir build && cd build

# 配置 CMake (假设 vcpkg 在上级目录)
cmake .. -DCMAKE_TOOLCHAIN_FILE=../vcpkg/scripts/buildsystems/vcpkg.cmake

# 编译
cmake --build . -j 8
```

### 3.1 Docker 统一编译环境（推荐）

> 适用于本机依赖不一致（如 Boost/OpenSSL/libcurl 版本差异）场景。

```bash
# 在项目根目录执行，构建阶段会自动执行 ctest
docker build -t ai-trade:latest .

# 回放模式运行
docker run --rm \
  -v "$(pwd)/config:/app/config:ro" \
  -v "$(pwd)/data:/app/data" \
  ai-trade:latest --config=config/bybit.replay.yaml --exchange=bybit
```

说明：
- Dockerfile 默认开启 `-DAI_TRADE_USE_BEAST_WEBSOCKET=ON`，可修复部分环境中 `libcurl` 不支持 `wss` 的握手失败问题。
- 本地若也需要同样行为，可显式配置：`cmake -S . -B build -DAI_TRADE_USE_BEAST_WEBSOCKET=ON`（需安装 Boost + OpenSSL）。

使用 docker compose：
```bash
# 首次请先准备 .env（AK/SK 注入）
cp .env.example .env
# 编辑 .env，填入对应环境的 Bybit AK/SK

docker compose up --build ai-trade
```

paper/demo 运行示例：
```bash
# 读取 .env 中 AK/SK
docker compose run --rm ai-trade --config=config/bybit.paper.yaml --exchange=bybit
```

## 4. 运行模式

系统支持三种运行模式，通过命令行参数或配置文件控制：

### 4.1 回放模式 (Replay)
用于策略回归和逻辑验证。
```bash
./bin/trade_bot --mode=replay --data=./data/2023_btc_1m.csv --config=./config/replay.yaml
```

### 4.2 模拟盘模式 (Paper Trading / Simulation)
连接交易所测试网 (Testnet) 或本地模拟撮合器。
```bash
./bin/trade_bot --mode=paper --config=./config/paper.yaml
```

Bybit V5 推荐运行示例（与当前工程实现一致）：
```bash
# testnet
export AI_TRADE_BYBIT_TESTNET_API_KEY=your_testnet_key
export AI_TRADE_BYBIT_TESTNET_API_SECRET=your_testnet_secret
./build/trade_bot --config=config/bybit.paper.yaml --exchange=bybit

# demo trading（主网模拟盘）
export AI_TRADE_BYBIT_DEMO_API_KEY=your_demo_key
export AI_TRADE_BYBIT_DEMO_API_SECRET=your_demo_secret
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit
```

运行控制参数（可与以上命令组合）：
```bash
# 持续运行（默认等价于 system.max_ticks=0）
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --run_forever

# 跑固定市场tick后退出
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --max_ticks=500

# 调整周期状态日志频率（0=关闭）
./build/trade_bot --config=config/bybit.demo.yaml --exchange=bybit --status_log_interval_ticks=10
```

### 4.3 实盘模式 (Live)
**警告**: 必须通过 Gate 验证后方可运行。
```bash
./bin/trade_bot --mode=live --config=./config/live.yaml
```

## 5. 模拟交易所 (Exchange Simulator)

为了验证 OMS 和执行逻辑（特别是限频、拒单、部分成交），我们提供了一个简单的 Python 模拟器。

```bash
# 启动模拟交易所
cd tools/exchange_sim
pip install -r requirements.txt
python main.py --port 8080
```

然后在对应运行配置中（例如 `config/paper.yaml`）将 `exchange.base_url` 指向 `http://localhost:8080`。

## 6. 代码规范

- **命名**: Google C++ Style Guide
- **格式化**: 提交前请运行 `clang-format`
- **测试**: 单元测试使用 GTest
  ```bash
  cd build
  ctest
  ```

## 7. 常见问题排查（Bybit）

- 报错：`retCode=10001, Qty invalid`
  - 当前实现会在连接后读取 `GET /v5/market/instruments-info`，并按交易规则自动处理下单数量：
    - 按 `qtyStep` 向下量化
    - 校验 `minOrderQty`
    - 校验（非 reduce_only）`minNotionalValue`
  - 系统会将 `candidate_symbols + fallback_symbols + primary_symbol` 与交易所 `symbol` 规则做交集过滤：
    - 非 `TRADING` 状态会被过滤
    - 若获取到规则但全部被过滤，进程会拒绝启动（避免“全是不可交易币对”）
  - 若仍出现该错误，优先检查：
    - 配置中 `execution.max_order_notional` 是否过小（导致量化后低于最小下单量）
    - 目标 symbol 是否在当前账户可交易
    - 日志中是否有“数量低于最小下单数量/最小名义金额”的拒单提示
