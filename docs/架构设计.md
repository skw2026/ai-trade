# 系统架构（模块边界、数据流、故障模式）

## 1. 架构原则
- 风控硬规则优先级最高（不可被策略/自进化覆盖）
- 事件驱动：所有输入/输出事件化，保证可回放
- 可观测优先：没有指标和审计就不算“完成”
- 插件化：策略与Regime可替换，但必须通过Gate
- **线程模型**: 采用“单写者”原则。Risk/OMS/AccountState 运行在单线程（或 Actor）中，避免锁竞争；MarketData 和 Strategy 可在独立线程池中运行，通过无锁队列（RingBuffer）通信。

## 2. 模块划分与职责（落地版）
1) Exchange Adapter
- WS：行情/标记价/成交；REST：合约信息/资金费率/下单撤单/查询
- 交易所规则缓存：min_qty、qty_step、price_tick、最大杠杆等
- 错误码统一映射：RATE_LIMIT / INSUFFICIENT_MARGIN / INVALID / EXCHANGE_DOWN / UNKNOWN

2) MarketData
- 行情接入、重连、去重、时序校验
- data_ok 产出：gap、延迟、时间戳异常检测

3) FeatureEngine
- 多周期特征（至少5m）
- 输出 FeatureSnapshot（不可变快照），提供 features_hash

4) RegimeEngine
- 输出 UPTREND / DOWNTREND / RANGE / EXTREME
- 输出 regime_bucket：TREND / RANGE / EXTREME（UPTREND、DOWNTREND 统一映射到 TREND）
- event_window 作为额外风险标签（优先用于降档）

5) StrategyEngine
- 调度策略插件，统一输出 Signal（标准契约）
- 信号合法性校验（过期/非法/无reason_codes）

6) PortfolioEngine
- 信号清洗/聚合（固定流水线）
- 风险预算裁剪（软约束）
- 阶段2：Bandit调权（受控、可回滚）

7) RiskEngine（Hard）
- 风控状态机：NORMAL/DEGRADED/COOLDOWN/FUSE/REDUCE_ONLY
- 应用硬规则：回撤阈值、强平距离、杠杆白名单、逐仓强制、断连只减仓
- 输出：RiskAdjustedPosition + RiskActions

8) ExecutionEngine
- 目标仓位逼近（Rebalance）
- 下单/撤单/超时重挂/限频/降级/冻结symbol
- 幂等：client_order_id

9) OMS/AccountState
- 订单状态机、成交处理、仓位与权益更新
- 计算 drawdown、margin_used、liq_distance
- 对账：与交易所定时比对差异

10) Monitoring/Audit/Replay
- Prometheus指标、告警、审计落地（可回放）
- Gate报告生成（PASS/FAIL + fail_reasons）

## 3. 数据流/事件流（工程序列）
MarketEvent → FeatureSnapshot → RegimeState → Signals → TargetPosition → RiskAdjustedPosition(+RiskActions) → Orders → Fills → AccountState（回流）

## 4. 故障模式与降级策略（必须实现）
- data_ok=false：禁止开新仓；必要时减风险；审计 RISK_DATA_GAP_DOWNGRADE
- trade_ok=false：只减仓；审计 RISK_TRADE_DISCONNECT_REDUCE_ONLY
- rate_limit：执行退避+降档；审计 EXEC_RATE_LIMIT_BACKOFF
- 拒单风暴：缩单/冻结symbol；审计 EXEC_ORDER_REJECT_DEGRADE
- 对账差异：降档/冻结；审计 OMS_RECONCILE_MISMATCH
- EXTREME/event_window：杠杆降到1x，风险预算下调，允许空仓
- FUSE 全平按“经济意义全平”执行：允许残留不可交易尘埃仓位，但必须 DUST_LOCKED 且禁止加仓

## 5. 状态恢复流程 (Crash Recovery)
1. **Load Snapshot**: 加载最近一次落盘的 AccountState/StrategyState (e.g., daily_0000.snap)。
2. **Replay Events**: 从 Snapshot 对应的 seq 开始，回放后续的 WAL (Write Ahead Log) 事件。
3. **Reconcile**: 恢复内存状态后，立即触发一次交易所 REST 对账，修正可能在宕机期间发生的成交。
