# 系统架构（模块边界、数据流、故障模式）

## 1. 架构原则
- 风控硬规则优先级最高（不可被策略/自进化覆盖）
- 事件驱动：所有输入/输出事件化，保证可回放
- 可观测优先：没有指标和审计就不算“完成”
- 插件化：策略与Regime可替换，但必须通过Gate
- **线程模型**: 采用“单写者”原则。Risk/OMS/AccountState 运行在单线程（或 Actor）中，避免锁竞争；MarketData 和 Strategy 可在独立线程池中运行，通过无锁队列（RingBuffer）通信。

## 2. 模块划分与职责（落地版）
1) Exchange Adapter
- WS：行情/标记价/成交；REST：合约信息/资金费率/下单撤单/查询
- 当前优先接入：**Bybit V5**
  - Endpoint 模式：
    - Testnet：`api-testnet.bybit.com` + `stream-testnet.bybit.com`
    - Mainnet：`api.bybit.com` + `stream.bybit.com`
    - Demo Trading：`api-demo.bybit.com` + `stream-demo.bybit.com`（Private WS）
  - 账户资金：`GET /v5/account/wallet-balance`（`accountType=UNIFIED`）
  - 账户模式：`GET /v5/account/info`（`unifiedMarginStatus`）
  - 持仓查询：`GET /v5/position/list`（`category=linear`）
  - 交易回报：Private WS `order/execution/position/wallet` 主题
- 当前实现状态（MVP骨架）：
  - 已实现 REST 签名与鉴权（V5）
  - 已实现 Public WS 行情订阅（`tickers.{symbol}`）
  - 已实现 Public REST 行情轮询（`/v5/market/tickers`，WS降级兜底）
  - 已实现 Private REST 下单/撤单（`/v5/order/create`、`/v5/order/cancel`）
  - 已实现 Private WS 实际接入：`auth` + `subscribe(execution/order/position/wallet)` + execution解析
  - 已实现 Private REST 执行轮询（`/v5/execution/list`，WS降级兜底）
  - 已完成 JSON/HTTP 基础设施替换：`libcurl`(HTTP/WS) + 统一 JSON 解析模块
  - 当前策略：**Public/Private WS 优先，失败自动降级到对应 REST 轮询**
- 交易所规则缓存：min_qty、qty_step、price_tick、最大杠杆等
- 错误码统一映射：RATE_LIMIT / INSUFFICIENT_MARGIN / INVALID / EXCHANGE_DOWN / UNKNOWN

2) MarketData
- 行情接入、重连、去重、时序校验
- data_ok 产出：gap、延迟、时间戳异常检测

3) UniverseSelector（智能/AI筛币）
- 输入：候选币对行情、成交量/深度、波动、点差、交易成本
- 输出：`active_symbols` + `symbol_scores` + `selector_reasons`
- 降级：当筛选不可用时回退 `fallback_symbols`，并审计 `UNIVERSE_SELECTOR_DEGRADED`

4) FeatureEngine
- 多周期特征（至少5m）
- 输出 FeatureSnapshot（不可变快照），提供 features_hash

5) RegimeEngine
- 输出 UPTREND / DOWNTREND / RANGE / EXTREME
- event_window 作为额外风险标签（优先用于降档）

6) StrategyEngine
- 调度策略插件，统一输出 Signal（标准契约）
- 信号合法性校验（过期/非法/无reason_codes）
- 按 `active_symbols` 逐币对生成信号

7) PortfolioEngine
- 信号清洗/聚合（固定流水线）
- 风险预算裁剪（软约束）
- 多币种预算分配（账户级预算 + symbol级限额）
- 阶段2：Bandit调权（受控、可回滚）

8) RiskEngine（Hard）
- 风控状态机：NORMAL/DEGRADED/COOLDOWN/FUSE/REDUCE_ONLY
- 应用硬规则：回撤阈值、强平距离、杠杆白名单、逐仓强制、断连只减仓
- 输出：RiskAdjustedPosition + RiskActions

9) ExecutionEngine
- 目标仓位逼近（Rebalance）
- 下单/撤单/超时重挂/限频/降级/冻结symbol
- 幂等：client_order_id

10) OMS/AccountState
- 订单状态机、成交处理、仓位与权益更新
- 账户状态按 `symbol -> PositionState` 维护（多币对，不再是单仓位模型）
- 计算 drawdown、margin_used、liq_distance
- 对账：与交易所定时比对差异

11) Monitoring/Audit/Replay
- Prometheus指标、告警、审计落地（可回放）
- Gate报告生成（PASS/FAIL + fail_reasons）
- **闭环保障**：信号心跳检测（Signal Heartbeat）、全链路漏斗统计（Funnel Stats）
- 增加 Universe 指标：`active_symbols_count`、`selector_turnover`、`selector_degrade_count`

## 3. 数据流/事件流（工程序列）
MarketEvent
→ UniverseSelector（active_symbols/symbol_scores）
→ FeatureSnapshot
→ RegimeState
→ Signals（per symbol）
→ TargetPosition（per symbol + 账户级聚合）
→ RiskAdjustedPosition
→ Orders
→ Fills
→ AccountState（回流）

## 4. 故障模式与降级策略（必须实现）
- data_ok=false：禁止开新仓；必要时减风险；审计 RISK_DATA_GAP_DOWNGRADE
- trade_ok=false：只减仓；审计 RISK_TRADE_DISCONNECT_REDUCE_ONLY
- rate_limit：执行退避+降档；审计 EXEC_RATE_LIMIT_BACKOFF
- 拒单风暴：缩单/冻结symbol；审计 EXEC_ORDER_REJECT_DEGRADE
- 对账差异：降档/冻结；审计 OMS_RECONCILE_MISMATCH
- EXTREME/event_window：杠杆降到1x，风险预算下调，允许空仓
- UniverseSelector 失效：回退静态白名单；若连续窗口为空集合触发 `FAIL_EMPTY_UNIVERSE`

## 5. 状态恢复流程 (Crash Recovery)
1. **Load Snapshot**: 加载最近一次落盘的 AccountState/StrategyState (e.g., daily_0000.snap)。
2. **Replay Events**: 从 Snapshot 对应的 seq 开始，回放后续的 WAL (Write Ahead Log) 事件。
3. **Reconcile**: 恢复内存状态后，立即触发一次交易所 REST 对账，修正可能在宕机期间发生的成交。若处于 FUSE 状态，需恢复 `DUST_LOCKED` 标记。
