# PRD & 验收标准（多币种永续，Bybit 优先，20% MDD 中位数）

## 1. 项目目标（不承诺稳定收益）
- 生存优先：极低强平概率；极端行情可主动降风险/空仓
- 风险可控：最大回撤（MDD）目标 20%（中位数），配套阈值动作与恢复
- 可持续迭代：策略/Regime/权重可升级，必须闸门与回滚
- 可解释可审计：每次决策都有 reason_codes，可回放复盘

## 2. 范围与非目标
### 2.1 范围（In Scope）
- 交易所：Bybit V5（MVP 优先）；后续再扩展其他交易所
- 标的：多币种永续（MVP 默认候选池：BTC/ETH/SOL，可配置扩展）
- 周期：分钟级信号（5m主，15m/1h辅助）+ 秒级风险/执行监控
- 策略：趋势（MVP）、波动率目标覆盖（MVP）、均值回归（阶段2）
- 自进化：Bandit调权 + 策略参数自适应（阶段2，受控；Regime用于分桶上下文）
- 币对筛选：智能/AI筛选币对（Universe Selector）
  - 输入：行情流动性、波动、成交质量、成本与风险特征
  - 输出：`active_symbols`（当前可交易币对集合）与 `symbol_scores`
  - 默认更新频率：1h（可配置）
  - 结果约束：`1 <= active_symbols_count <= max_active_symbols`（可配置）

### 2.2 非目标（Out of Scope）
- 高频做市/亚秒级抢单
- 端到端RL直接下单（MVP不做）
- 保证稳定收益
- MVP 不追求“一次覆盖全市场所有币种”

## 3. 指标体系（KRI优先）
### 3.1 KRI（P0必须满足，Gate判定以此为准）
A. 生存与强平风险
- 逐仓：100%（检测到Cross → 阻断开/加仓）
- 杠杆白名单：100%（越界即FAIL）
- 强平距离（加权P95）：正常状态 P95 ≥ 8%
  - 若P95 < 8%：必须触发强制减仓（并审计），目标恢复 ≥ 10%

B. 回撤控制（账户级）
- DD ≥ 8%：降档（risk_budget下调，提高门槛）
- DD ≥ 12%：强制减仓 + 冷却（只减仓不加仓）
- DD ≥ 20%：熔断（经济意义全平）+ 冷却 + 分段恢复（仅允许不可交易尘埃仓残留且必须锁定）
- 时效：触发后 60s 内进入模式并审计；10min内风险指标改善趋势可观测

C. 执行可靠性
- 幂等：client_order_id 重试不重复下单
- 断连：trade_ok=false → 只减仓（不得新增敞口）
- 限频/拒单：必须降级（退避/缩单/冻结symbol）并可审计
- 可选保护单：支持配置开关启用订单级保护单（SL优先、TP次之）
  - 保护单启用时：新开仓后必须在限定时窗内挂出 SL（TP可选）
  - 保护单异常时：必须降级（只减仓/冻结symbol）并审计 `EXEC_PROTECTIVE_ORDER_MISSING`

D. 最小活跃度（防零交易死局）
- 日最小有效信号数：`effective_signals_per_day >= 24`（可配置）
- 日最小成交笔数：`fills_per_day >= 4`（可配置；新市场可按周口径放宽）
- 任一不满足：Gate 记为 FAIL（`FAIL_LOW_ACTIVITY_SIGNALS` / `FAIL_LOW_ACTIVITY_FILLS`）

E. 数据质量
- 行情断档：data_ok=false → 禁止开新仓；必要时减风险
- 时钟偏差/延迟异常：告警 + 降档。**要求**: 系统启动前及运行时必须同步 NTP，本地时间漂移 > 500ms 视为异常。
- **系统延迟 (Latency)**: Tick-to-Order < 50ms (P99, 内部处理时间)，确保在中频策略中的执行优势。

F. 多币种与筛币可用性（新增）
- `active_symbols_count >= 1`（每个筛选窗口必须成立）
- 筛币模块异常（上游数据不足/打分失败）时：
  - 必须降级为静态白名单（`fallback_symbols`）
  - 必须审计 `UNIVERSE_SELECTOR_DEGRADED`
- 若连续 `N` 个窗口（可配置）`active_symbols_count=0`：
  - Gate 直接 FAIL（`FAIL_EMPTY_UNIVERSE`）

### 3.2 KPI（P1目标，非承诺）
- 季度/半年风险调整收益为正（方向性目标）
- 成本拖累（滑点+手续费+资金费率）在预算范围
- Regime适配：趋势期趋势贡献更大、震荡期回归贡献更大（阶段2后）

## 4. 自进化验收（P0）
### 4.1 学习边界（必须）
- 仅允许：策略权重、策略参数（Trend/MeanRev/VolTarget 参数）、筛币打分权重/阈值
- 禁止：硬风控阈值与规则被学习模块覆盖
- 运行时双保险：
  - 配置写入限制：学习模块不得写入 `risk.*`
  - 应用前校验：一旦检测触碰硬风控字段，直接拒绝并审计 `RISK_IMMUTABLE_GUARD`

### 4.2 更新频率与触发
- 默认评估频率：每 1h（可配置）
- 评估不等于更新；满足以下条件才允许更新：
  - 最小决策样本门槛（`min_decision_epochs`，含空仓周期）
  - 最小成交样本门槛（`min_fills_for_update`）
  - 显著性门槛（标准化后新方案优于旧方案）

### 4.3 目标函数（统一口径）
- 自进化优化目标：
  - `J = alpha*PnL_net - beta*Drawdown - gamma*TurnoverCost - delta*TailRisk`
- 指标定义：
  - `PnL_net`：净收益（含手续费、滑点、资金费率）
  - `Drawdown`：窗口内回撤惩罚
  - `TurnoverCost`：换手惩罚（防止过度调仓）
  - `TailRisk`：尾部风险（建议 CVaR 或极端亏损分位）
- 默认系数建议：`alpha=1.0, beta=2.0, gamma=1.0, delta=1.5`（可配置）
- 显著性口径：使用标准化相对提升
  - `improvement_ratio = (J_new - J_base) / max(|J_base|, eps)`
  - 要求 `improvement_ratio >= improvement_threshold`（默认2%）

### 4.4 学习窗口与 Regime 分桶
- 采用多窗口加权（可配置）：
  - 7天窗口：0.5（快响应）
  - 30天窗口：0.3（主参考）
  - 90天窗口：0.2（稳定锚）
- 建议按 Regime 轻量分桶统计并训练：
  - TREND（趋势）、RANGE（震荡）、EXTREME（极端）
  - 映射规则固定为：`UPTREND/DOWNTREND -> TREND`，`RANGE -> RANGE`，`EXTREME -> EXTREME`
  - 各桶独立统计策略贡献，再汇总到调权器

### 4.5 探索与安全边界
- 单策略权重上限：`<=60%`
- 单次权重变化：`<=±5%`
- 连续两次调权间隔：`>=6h`
- EXTREME 状态：仅允许降风险（冻结探索或只下调）
- 权重有效性：`0 <= w_i <= 0.60` 且 `Σ w_i = 1.0`（活跃策略集合，允许微小数值容差）
- 非法权重更新（负权重、总和>1、总和!=1）必须拒绝并保留上一稳定快照
- 单策略降级特例：当且仅当 `active_strategy_count=1` 时，允许该策略 `w=1.0`，并审计 `PORT_SINGLE_STRATEGY_MODE`

### 4.6 Gate 与回滚（自进化专属）
- Gate 判定：KRI 一票否决；KRI 全通过后才看 KPI
- 回滚触发：
  - 连续 2 个评估周期性能/风险劣化
  - 任一重大违规（杠杆越界、reduce-only 违规）立即回滚
- 回滚后：进入 24h 观察期，暂停新一轮学习更新

### 4.7 可解释与审计（最小字段）
- 更新前后：`weights_before/after`、`params_before/after`
- 决策依据：`window_stats`、`regime_bucket`、`objective_delta`
- 筛币依据：`candidate_symbols`、`symbol_scores`、`active_symbols`、`selector_reasons`
- 版本信息：`config_version/strategy_bundle_version/regime_version/git_commit`
- 后验追踪：生效后 `1h/6h/24h` 效果快照

### 4.8 智能筛币验收（P0）
- 候选池可配置（静态候选 + 交易所可交易列表交集）
- 打分结果可解释：每个 symbol 必须有 `score` 与最小 reason_codes
- 选择结果稳定性：
  - 连续两次窗口的集合变更比例 `<= universe_turnover_cap`（可配置）
  - EXTREME 状态下允许仅保留低风险币对（或收敛到最小集合）
- 风险边界：
  - 禁止将未通过交易规则校验（最小下单量/精度/限杠杆）的币对加入 `active_symbols`
  - 禁止绕过逐仓与杠杆白名单

## 5. 工程验收（交付可验收）
- 可观测：指标+面板+告警，关键KRI可直接读数
- 可审计：Regime/Signal/Target/RiskAction/Orders 全链路审计可回放
- 自动化：Unit/Integration/Replay/模拟盘E2E/Shadow 全链路
- 演练：回撤阈值/强平距离/断连/限频/拒单/回滚演练通过

## 6. 因子-模型-风控闭环（阶段3：先做前两级）

> 本节聚焦你提出的前两级：  
> 第一级 `Miner`（遗传规划/符号回归）  
> 第二级 `Integrator`（CatBoost 信号集成）  
> 第三级 `Regime+Gate+Risk` 继续保持为硬保险栓，不允许被学习覆盖。

### 6.1 架构边界（必须）
- 第一级（离线）：因子挖掘者 `The Miner`
  - 输入：历史 OHLCV、成本、基础技术指标特征
  - 输出：可执行因子公式集（`factor_expressions`）及质量评分
- 第二级（离线训练 + 在线推理）：信号决策者 `The Integrator`
  - 输入：一级产出的因子值 + RSI/MACD 等标准特征 + Regime 状态特征
  - 输出：方向概率/收益评分（`p_up/p_down` 或 `score`）
- 第三级（在线规则）：保险栓 `Regime+Gate+Risk`
  - 职责：环境准入、风控硬约束、停机/降级/回滚
  - 约束：第二级输出只能影响“信号层”，不能绕过硬风控

### 6.2 第一级：因子挖掘者（Symbolic Regression）

#### 6.2.1 目标
- 自动挖掘高潜力 Alpha 因子公式 `f(x)`，而非仅优化固定参数。
- 产出可解释、可复现、可执行的表达式清单。

#### 6.2.2 必须能力
- 符号回归表达式树（语法树）生成与进化。
- 适应度函数使用 IC（Spearman Rank Corr），非 MSE。
- 支持时序算子（最小集）：
  - `ts_delay(x, d)`
  - `ts_delta(x, d)`
  - `ts_rank(x, d)`
  - `ts_corr(x, y, d)`
- 时序算子语义（统一口径）：
  - `ts_delay(x, d) = x[t-d]`
  - `ts_delta(x, d) = x[t] - x[t-d]`
  - `ts_rank(x, d) = rank(x[t-d+1...t])`
  - `ts_corr(x, y, d) = corr(x[t-d+1...t], y[t-d+1...t])`
- 工具链建议（离线研发）：
  - 快速验证优先：`gplearn`
  - 可扩展定制优先：`DEAP`

#### 6.2.3 训练与约束
- 仅允许使用训练窗口内已知数据；禁止任何未来信息参与因子计算。
- 因子复杂度约束：限制树深、节点数、无效常量比例，防止表达式爆炸。
- 稳定性约束：因子需通过多窗口稳定性筛选（例如 7d/30d/90d）。
- Fitness 建议主口径：
  - `fitness = IC_oos_mean - lambda1*complexity_penalty - lambda2*instability_penalty`
  - 其中 `IC` 使用 Spearman Rank Corr，按滚动窗口聚合。

#### 6.2.4 产物（必须落盘）
- `factor_set_version`
- 每个因子的：
  - `expression`
  - `fitness_ic_train`
  - `fitness_ic_oos`
  - `complexity_score`
  - `valid_universe`
  - `random_seed`
  - `search_space_version`

### 6.3 第二级：信号决策者（CatBoost）

#### 6.3.1 目标
- 将“一级因子 + 经典指标 + 状态特征”非线性集成，输出交易概率或评分。

#### 6.3.2 必须能力
- 使用 CatBoost 训练分类/回归模型（按任务选择）。
- 默认采用 CatBoost Ordered Boosting 训练流程，降低时序任务前视偏差风险。
- 使用滚动训练与时序切分（`TimeSeriesSplit` 或 Rolling Window）。
- 支持自动调参（Optuna），并记录实验配置与结果。
- 必须输出特征重要性并用于因子治理（保留/降权/淘汰）。

#### 6.3.3 反泄漏要求（P0）
- 严禁 Look-ahead Bias：
  - 特征对齐到 `t`，标签来自 `t+1...t+h`
  - 标准化/编码器仅在训练折拟合
- 采用时序安全评估，不使用随机 K-Fold。
- 训练切分必须可回放（固定 `split_seed`、窗口边界、样本过滤条件）。

#### 6.3.4 产物（必须落盘）
- `model_version`
- `feature_schema_version`
- `train_window`/`test_window`
- `metrics_oos`（AUC/IC/收益相关指标）
- `feature_importance`

### 6.4 在线接入约束（阶段3前两级）
- 第二级模型输出仅作为 `StrategyEngine` 的信号输入，不直接下单。
- 当模型不可用/过期/健康检查失败时，自动降级到基线策略并审计。
- 第三级 Regime/Gate/Risk 拥有最终否决权（一票否决仍有效）。

### 6.5 阶段目标（不改变现阶段主目标）
- 当前阶段（S1~S5）目标不变：先完成稳定闭环与可审计运行。
- 阶段3新增目标：在不破坏现有硬风控前提下，引入前两级研究链路与影子验证链路。
