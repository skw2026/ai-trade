name: CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
      research_image_uri: ${{ steps.meta.outputs.research_image_uri }}
      research_image_tag: ${{ steps.meta.outputs.research_image_tag }}
      deploy_enabled: ${{ steps.deploy_gate.outputs.enabled }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute Image Metadata
        id: meta
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_URI="${REGISTRY}/${OWNER_LC}/ai-trade"
          RESEARCH_IMAGE_URI="${REGISTRY}/${OWNER_LC}/ai-trade-research"
          IMAGE_TAG="${GITHUB_SHA}"
          echo "image_uri=${IMAGE_URI}" >> "${GITHUB_OUTPUT}"
          echo "image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "research_image_uri=${RESEARCH_IMAGE_URI}" >> "${GITHUB_OUTPUT}"
          echo "research_image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Install Build Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Configure
        run: cmake -S . -B build -G Ninja

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Runtime Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_uri }}:${{ steps.meta.outputs.image_tag }}
            ${{ steps.meta.outputs.image_uri }}:latest

      - name: Build and Push Research Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.research
          push: true
          tags: |
            ${{ steps.meta.outputs.research_image_uri }}:${{ steps.meta.outputs.research_image_tag }}
            ${{ steps.meta.outputs.research_image_uri }}:latest

      - name: Compute Deploy Gate
        id: deploy_gate
        run: |
          set -euo pipefail
          if [[ -n "${{ secrets.ECS_HOST }}" && -n "${{ secrets.ECS_USER }}" && -n "${{ secrets.ECS_SSH_KEY }}" ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "[warn] Deploy skipped: missing ECS_HOST/ECS_USER/ECS_SSH_KEY secrets."
          fi

  deploy-ecs:
    needs: build-test-push
    runs-on: ubuntu-latest
    if: ${{ needs.build-test-push.outputs.deploy_enabled == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Deployment Bundle
        run: |
          set -euo pipefail
          rm -f deploy_bundle.tgz
          tar -czf deploy_bundle.tgz \
            docker-compose.prod.yml \
            deploy/ecs-deploy.sh \
            observability \
            ops \
            tools
          tar -tzf deploy_bundle.tgz > /tmp/deploy_bundle.list
          grep -q '^docker-compose.prod.yml$' /tmp/deploy_bundle.list
          grep -q '^deploy/ecs-deploy.sh$' /tmp/deploy_bundle.list
          grep -q '^observability/' /tmp/deploy_bundle.list
          grep -q '^ops/cron/closed-loop.cron.example$' /tmp/deploy_bundle.list
          grep -q '^tools/closed_loop_runner.sh$' /tmp/deploy_bundle.list
          grep -q '^tools/fetch_bybit_kline.py$' /tmp/deploy_bundle.list
          grep -q '^tools/integrator_train.py$' /tmp/deploy_bundle.list
          grep -q '^tools/assess_run_log.py$' /tmp/deploy_bundle.list
          grep -q '^tools/model_registry.py$' /tmp/deploy_bundle.list
          grep -q '^tools/build_closed_loop_report.py$' /tmp/deploy_bundle.list

      - name: Upload Deployment Bundle
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          source: "deploy_bundle.tgz"
          target: "/opt/ai-trade"

      - name: Deploy to ECS
        uses: appleboy/ssh-action@v1.2.0
        env:
          AI_TRADE_IMAGE: ${{ needs.build-test-push.outputs.image_uri }}:${{ needs.build-test-push.outputs.image_tag }}
          AI_TRADE_RESEARCH_IMAGE: ${{ needs.build-test-push.outputs.research_image_uri }}:${{ needs.build-test-push.outputs.research_image_tag }}
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DEPLOY_ENV_FILE: /opt/ai-trade/.env.runtime
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          envs: AI_TRADE_IMAGE,AI_TRADE_RESEARCH_IMAGE,GHCR_USER,GHCR_TOKEN,DEPLOY_ENV_FILE
          script: |
            set -euo pipefail
            DEPLOY_ROOT="/opt/ai-trade"
            RELEASE_TMP="${DEPLOY_ROOT}/.release_unpack"
            mkdir -p "${DEPLOY_ROOT}/data"
            rm -rf "${RELEASE_TMP}"
            mkdir -p "${RELEASE_TMP}"

            BUNDLE_PATH="$(find "${DEPLOY_ROOT}" -maxdepth 5 -type f -name deploy_bundle.tgz -printf '%T@ %p\n' | sort -nr | head -n1 | awk '{print $2}' || true)"
            if [[ -z "${BUNDLE_PATH}" ]]; then
              echo "[deploy] deploy bundle not found under ${DEPLOY_ROOT}"
              exit 1
            fi
            echo "[deploy] bundle=${BUNDLE_PATH}"
            if [[ ! -s "${BUNDLE_PATH}" ]]; then
              echo "[deploy] deploy bundle is empty: ${BUNDLE_PATH}"
              exit 1
            fi
            tar -xzf "${BUNDLE_PATH}" -C "${RELEASE_TMP}"

            for required_file in \
              "${RELEASE_TMP}/docker-compose.prod.yml" \
              "${RELEASE_TMP}/deploy/ecs-deploy.sh" \
              "${RELEASE_TMP}/tools/closed_loop_runner.sh" \
              "${RELEASE_TMP}/tools/fetch_bybit_kline.py" \
              "${RELEASE_TMP}/tools/integrator_train.py" \
              "${RELEASE_TMP}/tools/assess_run_log.py" \
              "${RELEASE_TMP}/tools/model_registry.py" \
              "${RELEASE_TMP}/tools/build_closed_loop_report.py" \
              "${RELEASE_TMP}/ops/cron/closed-loop.cron.example" \
              "${RELEASE_TMP}/observability/loki/loki-config.yaml" \
              "${RELEASE_TMP}/observability/promtail/promtail-config.yml" \
              "${RELEASE_TMP}/observability/prometheus/prometheus.yml" \
              "${RELEASE_TMP}/observability/prometheus/rules/alerts.yml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/datasources/loki.yaml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/datasources/prometheus.yaml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/dashboards/dashboards.yaml" \
              "${RELEASE_TMP}/observability/grafana/dashboards/ai-trade-runtime.json" \
              "${RELEASE_TMP}/observability/grafana/dashboards/ai-trade-prometheus-runtime.json"
            do
              if [[ ! -f "${required_file}" ]]; then
                echo "[deploy] missing required file in bundle: ${required_file}"
                exit 1
              fi
            done

            cp -f "${RELEASE_TMP}/docker-compose.prod.yml" "${DEPLOY_ROOT}/docker-compose.prod.yml"
            mkdir -p "${DEPLOY_ROOT}/deploy"
            cp -f "${RELEASE_TMP}/deploy/ecs-deploy.sh" "${DEPLOY_ROOT}/deploy/ecs-deploy.sh"
            rm -rf "${DEPLOY_ROOT}/ops"
            cp -a "${RELEASE_TMP}/ops" "${DEPLOY_ROOT}/ops"
            rm -rf "${DEPLOY_ROOT}/tools"
            cp -a "${RELEASE_TMP}/tools" "${DEPLOY_ROOT}/tools"
            rm -rf "${DEPLOY_ROOT}/observability"
            cp -a "${RELEASE_TMP}/observability" "${DEPLOY_ROOT}/observability"

            find "${DEPLOY_ROOT}" -maxdepth 5 -type f -name deploy_bundle.tgz -delete || true
            rm -rf "${RELEASE_TMP}"

            chmod +x "${DEPLOY_ROOT}/deploy/ecs-deploy.sh"
            chmod +x "${DEPLOY_ROOT}/tools/closed_loop_runner.sh"
            "${DEPLOY_ROOT}/deploy/ecs-deploy.sh" "${DEPLOY_ROOT}/docker-compose.prod.yml" "${DEPLOY_ENV_FILE}"
