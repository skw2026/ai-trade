name: CD

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  packages: write

concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: true

env:
  REGISTRY: ghcr.io

jobs:
  build-test-push:
    runs-on: ubuntu-latest
    outputs:
      image_uri: ${{ steps.meta.outputs.image_uri }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
      research_image_uri: ${{ steps.meta.outputs.research_image_uri }}
      research_image_tag: ${{ steps.meta.outputs.research_image_tag }}
      web_image_uri: ${{ steps.meta.outputs.web_image_uri }}
      web_image_tag: ${{ steps.meta.outputs.web_image_tag }}
      deploy_enabled: ${{ steps.deploy_gate.outputs.enabled }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Compute Image Metadata
        id: meta
        run: |
          set -euo pipefail
          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_URI="${REGISTRY}/${OWNER_LC}/ai-trade"
          RESEARCH_IMAGE_URI="${REGISTRY}/${OWNER_LC}/ai-trade-research"
          WEB_IMAGE_URI="${REGISTRY}/${OWNER_LC}/ai-trade-web"
          IMAGE_TAG="${GITHUB_SHA}"
          echo "image_uri=${IMAGE_URI}" >> "${GITHUB_OUTPUT}"
          echo "image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "research_image_uri=${RESEARCH_IMAGE_URI}" >> "${GITHUB_OUTPUT}"
          echo "research_image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"
          echo "web_image_uri=${WEB_IMAGE_URI}" >> "${GITHUB_OUTPUT}"
          echo "web_image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Install Build Dependencies
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            ninja-build \
            pkg-config \
            libcurl4-openssl-dev \
            libssl-dev

      - name: Configure
        run: cmake -S . -B build -G Ninja

      - name: Verify Required Tests Registered
        run: |
          set -euo pipefail
          ctest --test-dir build -N > /tmp/ctest-list.txt
          grep -q "trade_system_test" /tmp/ctest-list.txt
          grep -q "assess_run_log_test" /tmp/ctest-list.txt
          grep -q "compose_consistency_test" /tmp/ctest-list.txt
          grep -q "watchdog_utils_test" /tmp/ctest-list.txt
          grep -q "recycle_artifacts_test" /tmp/ctest-list.txt
          grep -q "docker_gc_test" /tmp/ctest-list.txt
          grep -q "validate_reports_test" /tmp/ctest-list.txt
          grep -q "web_report_store_test" /tmp/ctest-list.txt
          grep -q "web_governance_test" /tmp/ctest-list.txt
          grep -q "web_static_test" /tmp/ctest-list.txt

      - name: Build
        run: cmake --build build -j"$(nproc)"

      - name: Test
        run: ctest --test-dir build --output-on-failure

      - name: Login GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and Push Runtime Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_uri }}:${{ steps.meta.outputs.image_tag }}
            ${{ steps.meta.outputs.image_uri }}:latest

      - name: Build and Push Research Image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: Dockerfile.research
          push: true
          tags: |
            ${{ steps.meta.outputs.research_image_uri }}:${{ steps.meta.outputs.research_image_tag }}
            ${{ steps.meta.outputs.research_image_uri }}:latest

      - name: Build and Push Web Image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/ai_trade_web/backend
          file: ./apps/ai_trade_web/backend/Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.web_image_uri }}:${{ steps.meta.outputs.web_image_tag }}
            ${{ steps.meta.outputs.web_image_uri }}:latest

      - name: Compute Deploy Gate
        id: deploy_gate
        run: |
          set -euo pipefail
          if [[ -n "${{ secrets.ECS_HOST }}" && -n "${{ secrets.ECS_USER }}" && -n "${{ secrets.ECS_SSH_KEY }}" ]]; then
            echo "enabled=true" >> "${GITHUB_OUTPUT}"
          else
            echo "enabled=false" >> "${GITHUB_OUTPUT}"
            echo "[warn] Deploy skipped: missing ECS_HOST/ECS_USER/ECS_SSH_KEY secrets."
          fi

  deploy-ecs:
    needs: build-test-push
    runs-on: ubuntu-latest
    if: ${{ needs.build-test-push.outputs.deploy_enabled == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Deployment Bundle
        run: |
          set -euo pipefail
          rm -f deploy_bundle.tgz
          tar -czf deploy_bundle.tgz \
            docker-compose.prod.yml \
            deploy/ecs-deploy.sh \
            config \
            observability \
            ops \
            tools
          tar -tzf deploy_bundle.tgz > /tmp/deploy_bundle.list
          grep -q '^docker-compose.prod.yml$' /tmp/deploy_bundle.list
          grep -q '^deploy/ecs-deploy.sh$' /tmp/deploy_bundle.list
          grep -q '^config/' /tmp/deploy_bundle.list
          grep -q '^observability/' /tmp/deploy_bundle.list
          grep -q '^ops/cron/closed-loop.cron.example$' /tmp/deploy_bundle.list
          grep -q '^tools/closed_loop_runner.sh$' /tmp/deploy_bundle.list
          grep -q '^tools/fetch_bybit_kline.py$' /tmp/deploy_bundle.list
          grep -q '^tools/integrator_train.py$' /tmp/deploy_bundle.list
          grep -q '^tools/assess_run_log.py$' /tmp/deploy_bundle.list
          grep -q '^tools/model_registry.py$' /tmp/deploy_bundle.list
          grep -q '^tools/build_closed_loop_report.py$' /tmp/deploy_bundle.list
          grep -q '^tools/build_periodic_summary.py$' /tmp/deploy_bundle.list
          grep -q '^tools/recycle_artifacts.sh$' /tmp/deploy_bundle.list
          grep -q '^tools/docker_gc.sh$' /tmp/deploy_bundle.list

      - name: Upload Deployment Bundle
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          fingerprint: ${{ secrets.ECS_HOST_FINGERPRINT }}
          source: "deploy_bundle.tgz"
          target: "/opt/ai-trade"

      - name: Deploy to ECS
        uses: appleboy/ssh-action@v1.2.0
        env:
          AI_TRADE_IMAGE: ${{ needs.build-test-push.outputs.image_uri }}:${{ needs.build-test-push.outputs.image_tag }}
          AI_TRADE_RESEARCH_IMAGE: ${{ needs.build-test-push.outputs.research_image_uri }}:${{ needs.build-test-push.outputs.research_image_tag }}
          AI_TRADE_WEB_IMAGE: ${{ needs.build-test-push.outputs.web_image_uri }}:${{ needs.build-test-push.outputs.web_image_tag }}
          GHCR_USER: ${{ secrets.GHCR_USER }}
          GHCR_TOKEN: ${{ secrets.GHCR_TOKEN }}
          DEPLOY_ENV_FILE: /opt/ai-trade/.env.runtime
          CLOSED_LOOP_ENFORCE: ${{ vars.CLOSED_LOOP_ENFORCE || 'true' }}
          CLOSED_LOOP_ACTION: ${{ vars.CLOSED_LOOP_ACTION || 'assess' }}
          CLOSED_LOOP_STAGE: ${{ vars.CLOSED_LOOP_STAGE || 'DEPLOY' }}
          CLOSED_LOOP_SINCE: ${{ vars.CLOSED_LOOP_SINCE || '30m' }}
          CLOSED_LOOP_MIN_RUNTIME_STATUS: ${{ vars.CLOSED_LOOP_MIN_RUNTIME_STATUS || '' }}
          CLOSED_LOOP_OUTPUT_ROOT: ${{ vars.CLOSED_LOOP_OUTPUT_ROOT || '/opt/ai-trade/data/reports/closed_loop' }}
          CLOSED_LOOP_STRICT_PASS: ${{ vars.CLOSED_LOOP_STRICT_PASS || 'true' }}
          DEPLOY_SERVICES: ${{ vars.DEPLOY_SERVICES || 'ai-trade watchdog scheduler' }}
          GATE_DEFER_SERVICES: ${{ vars.GATE_DEFER_SERVICES || 'watchdog scheduler' }}
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          fingerprint: ${{ secrets.ECS_HOST_FINGERPRINT }}
          envs: AI_TRADE_IMAGE,AI_TRADE_RESEARCH_IMAGE,AI_TRADE_WEB_IMAGE,GHCR_USER,GHCR_TOKEN,DEPLOY_ENV_FILE,CLOSED_LOOP_ENFORCE,CLOSED_LOOP_ACTION,CLOSED_LOOP_STAGE,CLOSED_LOOP_SINCE,CLOSED_LOOP_MIN_RUNTIME_STATUS,CLOSED_LOOP_OUTPUT_ROOT,CLOSED_LOOP_STRICT_PASS,DEPLOY_SERVICES,GATE_DEFER_SERVICES
          script: |
            set -euo pipefail
            DEPLOY_ROOT="/opt/ai-trade"
            RELEASE_TMP="${DEPLOY_ROOT}/.release_unpack"
            mkdir -p "${DEPLOY_ROOT}/data"
            rm -rf "${RELEASE_TMP}"
            mkdir -p "${RELEASE_TMP}"

            BUNDLE_PATH="$(find "${DEPLOY_ROOT}" -maxdepth 5 -type f -name deploy_bundle.tgz -printf '%T@ %p\n' | sort -nr | head -n1 | awk '{print $2}' || true)"
            if [[ -z "${BUNDLE_PATH}" ]]; then
              echo "[deploy] deploy bundle not found under ${DEPLOY_ROOT}"
              exit 1
            fi
            echo "[deploy] bundle=${BUNDLE_PATH}"
            if [[ ! -s "${BUNDLE_PATH}" ]]; then
              echo "[deploy] deploy bundle is empty: ${BUNDLE_PATH}"
              exit 1
            fi
            tar -xzf "${BUNDLE_PATH}" -C "${RELEASE_TMP}"

            for required_file in \
              "${RELEASE_TMP}/docker-compose.prod.yml" \
              "${RELEASE_TMP}/deploy/ecs-deploy.sh" \
              "${RELEASE_TMP}/config/default.yaml" \
              "${RELEASE_TMP}/tools/closed_loop_runner.sh" \
              "${RELEASE_TMP}/tools/fetch_bybit_kline.py" \
              "${RELEASE_TMP}/tools/integrator_train.py" \
              "${RELEASE_TMP}/tools/assess_run_log.py" \
              "${RELEASE_TMP}/tools/model_registry.py" \
              "${RELEASE_TMP}/tools/build_closed_loop_report.py" \
              "${RELEASE_TMP}/tools/build_periodic_summary.py" \
              "${RELEASE_TMP}/tools/recycle_artifacts.sh" \
              "${RELEASE_TMP}/tools/docker_gc.sh" \
              "${RELEASE_TMP}/ops/cron/closed-loop.cron.example" \
              "${RELEASE_TMP}/observability/loki/loki-config.yaml" \
              "${RELEASE_TMP}/observability/promtail/promtail-config.yml" \
              "${RELEASE_TMP}/observability/prometheus/prometheus.yml" \
              "${RELEASE_TMP}/observability/prometheus/rules/alerts.yml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/datasources/loki.yaml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/datasources/prometheus.yaml" \
              "${RELEASE_TMP}/observability/grafana/provisioning/dashboards/dashboards.yaml" \
              "${RELEASE_TMP}/observability/grafana/dashboards/ai-trade-runtime.json" \
              "${RELEASE_TMP}/observability/grafana/dashboards/ai-trade-prometheus-runtime.json"
            do
              if [[ ! -f "${required_file}" ]]; then
                echo "[deploy] missing required file in bundle: ${required_file}"
                exit 1
              fi
            done

            cp -f "${RELEASE_TMP}/docker-compose.prod.yml" "${DEPLOY_ROOT}/docker-compose.prod.yml"
            mkdir -p "${DEPLOY_ROOT}/deploy"
            cp -f "${RELEASE_TMP}/deploy/ecs-deploy.sh" "${DEPLOY_ROOT}/deploy/ecs-deploy.sh"
            mkdir -p "${DEPLOY_ROOT}/config"
            cp -a "${RELEASE_TMP}/config/." "${DEPLOY_ROOT}/config/"
            rm -rf "${DEPLOY_ROOT}/ops"
            cp -a "${RELEASE_TMP}/ops" "${DEPLOY_ROOT}/ops"
            rm -rf "${DEPLOY_ROOT}/tools"
            cp -a "${RELEASE_TMP}/tools" "${DEPLOY_ROOT}/tools"
            rm -rf "${DEPLOY_ROOT}/observability"
            cp -a "${RELEASE_TMP}/observability" "${DEPLOY_ROOT}/observability"

            find "${DEPLOY_ROOT}" -maxdepth 5 -type f -name deploy_bundle.tgz -delete || true
            rm -rf "${RELEASE_TMP}"

            chmod +x "${DEPLOY_ROOT}/deploy/ecs-deploy.sh"
            chmod +x "${DEPLOY_ROOT}/tools/closed_loop_runner.sh"
            chmod +x "${DEPLOY_ROOT}/tools/recycle_artifacts.sh"
            chmod +x "${DEPLOY_ROOT}/tools/docker_gc.sh"
            chmod +x "${DEPLOY_ROOT}/ops/cron/install_closed_loop_cron.sh"
            echo "[deploy] closed-loop gate config: enforce=${CLOSED_LOOP_ENFORCE} action=${CLOSED_LOOP_ACTION} stage=${CLOSED_LOOP_STAGE} since=${CLOSED_LOOP_SINCE} strict=${CLOSED_LOOP_STRICT_PASS} min_runtime_status=${CLOSED_LOOP_MIN_RUNTIME_STATUS}"
            echo "[deploy] deploy services: ${DEPLOY_SERVICES}, gate defer services: ${GATE_DEFER_SERVICES}"
            "${DEPLOY_ROOT}/deploy/ecs-deploy.sh" "${DEPLOY_ROOT}/docker-compose.prod.yml" "${DEPLOY_ENV_FILE}"

      - name: Download Deploy Gate Reports
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          umask 077
          cat > .artifacts/ecs_key <<'EOF'
          ${{ secrets.ECS_SSH_KEY }}
          EOF
          sed -i 's/\r$//' .artifacts/ecs_key
          chmod 600 .artifacts/ecs_key
          if ! ssh-keygen -y -f .artifacts/ecs_key >/dev/null 2>&1; then
            echo "[deploy] invalid ECS_SSH_KEY format after normalization, skip artifact download"
            rm -f .artifacts/ecs_key
            cat > .artifacts/deploy_gate_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "invalid_ssh_key_format"
          }
          EOF
            exit 0
          fi
          PORT="${{ secrets.ECS_PORT || 22 }}"
          HOST="${{ secrets.ECS_HOST }}"
          USER="${{ secrets.ECS_USER }}"
          EXPECTED_FINGERPRINT_SECRET="${{ secrets.ECS_HOST_FINGERPRINT }}"
          EXPECTED_FINGERPRINT_VAR="${{ vars.ECS_HOST_FINGERPRINT }}"
          EXPECTED_FINGERPRINT="${EXPECTED_FINGERPRINT_SECRET:-${EXPECTED_FINGERPRINT_VAR}}"
          if [[ -z "${HOST}" || -z "${USER}" ]]; then
            echo "[deploy] ECS_HOST/ECS_USER missing, skip artifact download"
            rm -f .artifacts/ecs_key
            cat > .artifacts/deploy_gate_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "missing_host_or_user"
          }
          EOF
            exit 0
          fi
          KNOWN_HOSTS_FILE=".artifacts/known_hosts"
          if ! ssh-keyscan -p "${PORT}" -t ed25519,ecdsa,rsa "${HOST}" > "${KNOWN_HOSTS_FILE}" 2>/dev/null; then
            echo "[deploy] failed to fetch host key via ssh-keyscan, skip artifact download"
            rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
            cat > .artifacts/deploy_gate_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "ssh_keyscan_failed"
          }
          EOF
            exit 0
          fi
          if [[ ! -s "${KNOWN_HOSTS_FILE}" ]]; then
            echo "[deploy] ssh-keyscan returned empty host keys, skip artifact download"
            rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
            cat > .artifacts/deploy_gate_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "ssh_keyscan_empty"
          }
          EOF
            exit 0
          fi
          if [[ -n "${EXPECTED_FINGERPRINT}" ]]; then
            if ! ssh-keygen -lf "${KNOWN_HOSTS_FILE}" | awk '{print $2}' | grep -Fxq "${EXPECTED_FINGERPRINT}"; then
              echo "[deploy] host fingerprint mismatch, skip artifact download"
              rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
              cat > .artifacts/deploy_gate_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "host_fingerprint_mismatch"
          }
          EOF
              exit 0
            fi
          fi

          downloaded=0
          missing=()
          invalid=()
          validate_json_file() {
            local path="$1"
            if [[ ! -s "${path}" ]]; then
              return 1
            fi
            if command -v jq >/dev/null 2>&1; then
              jq -e . "${path}" >/dev/null 2>&1
            else
              python3 -m json.tool "${path}" >/dev/null 2>&1
            fi
          }
          fetch_report() {
            local remote_path="$1"
            local local_path="$2"
            local label="$3"
            local kind="${4:-json}"
            local tmp_path="${local_path}.tmp"
            rm -f "${tmp_path}" "${local_path}"
            if scp -i .artifacts/ecs_key -P "${PORT}" \
              -o UserKnownHostsFile="${KNOWN_HOSTS_FILE}" \
              -o StrictHostKeyChecking=yes \
              "${USER}@${HOST}:${remote_path}" "${tmp_path}"; then
              if [[ "${kind}" == "json" ]]; then
                if ! validate_json_file "${tmp_path}"; then
                  echo "[deploy] invalid ${label}: downloaded but JSON is malformed/empty"
                  invalid+=("${label}")
                  rm -f "${tmp_path}" "${local_path}"
                  return
                fi
              fi
              mv -f "${tmp_path}" "${local_path}"
              echo "[deploy] downloaded ${label}: ${remote_path}"
              downloaded=$((downloaded + 1))
            else
              echo "[deploy] missing or inaccessible ${label}: ${remote_path}"
              missing+=("${label}")
              rm -f "${tmp_path}" "${local_path}"
            fi
          }

          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_closed_loop_report.json" ".artifacts/latest_closed_loop_report.json" "latest_closed_loop_report" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_runtime_assess.json" ".artifacts/latest_runtime_assess.json" "latest_runtime_assess" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_run_meta.json" ".artifacts/latest_run_meta.json" "latest_run_meta" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest/runtime.log" ".artifacts/runtime.log" "runtime_log" "text"

          {
            echo "{"
            echo "  \"status\": \"DONE\","
            echo "  \"downloaded_count\": ${downloaded},"
            echo "  \"invalid_count\": ${#invalid[@]},"
            echo "  \"missing\": ["
            for i in "${!missing[@]}"; do
              sep=","
              if [[ "${i}" -eq $((${#missing[@]} - 1)) ]]; then
                sep=""
              fi
              echo "    \"${missing[$i]}\"${sep}"
            done
            echo "  ],"
            echo "  \"invalid\": ["
            for i in "${!invalid[@]}"; do
              sep=","
              if [[ "${i}" -eq $((${#invalid[@]} - 1)) ]]; then
                sep=""
              fi
              echo "    \"${invalid[$i]}\"${sep}"
            done
            echo "  ]"
            echo "}"
          } > .artifacts/deploy_gate_download_status.json

          echo "[deploy] downloaded_count=${downloaded} missing_count=${#missing[@]} invalid_count=${#invalid[@]}"
          rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"

      - name: Upload Deploy Gate Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-closed-loop-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            .artifacts/*.json
            .artifacts/runtime.log
          include-hidden-files: true
          if-no-files-found: warn
