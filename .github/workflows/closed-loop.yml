name: Closed Loop

on:
  workflow_dispatch:
    inputs:
      action:
        description: "闭环动作（assess/full/train）"
        required: true
        default: "assess"
        type: choice
        options:
          - assess
          - full
          - train
      stage:
        description: "运行验收阶段（S3/S5）"
        required: true
        default: "S5"
        type: choice
        options:
          - S3
          - S5
      since:
        description: "日志窗口（例如 4h / 12h / 24h）"
        required: true
        default: "4h"
        type: string
  schedule:
    - cron: "15 */6 * * *" # 每6小时一次

permissions:
  contents: read

concurrency:
  group: closed-loop-${{ github.ref }}
  cancel-in-progress: false

jobs:
  run-closed-loop:
    runs-on: ubuntu-latest
    steps:
      - name: Check deploy secrets
        run: |
          set -euo pipefail
          test -n "${{ secrets.ECS_HOST }}"
          test -n "${{ secrets.ECS_USER }}"
          test -n "${{ secrets.ECS_SSH_KEY }}"

      - name: Run Closed Loop on ECS
        uses: appleboy/ssh-action@v1.2.0
        env:
          CLOSED_LOOP_ACTION: ${{ github.event_name == 'schedule' && 'assess' || inputs.action }}
          CLOSED_LOOP_STAGE: ${{ github.event_name == 'schedule' && 'S5' || inputs.stage }}
          CLOSED_LOOP_SINCE: ${{ github.event_name == 'schedule' && '4h' || inputs.since }}
        with:
          host: ${{ secrets.ECS_HOST }}
          username: ${{ secrets.ECS_USER }}
          key: ${{ secrets.ECS_SSH_KEY }}
          port: ${{ secrets.ECS_PORT || 22 }}
          fingerprint: ${{ secrets.ECS_HOST_FINGERPRINT }}
          envs: CLOSED_LOOP_ACTION,CLOSED_LOOP_STAGE,CLOSED_LOOP_SINCE
          script: |
            set -euo pipefail
            cd /opt/ai-trade
            set -a && source .env.runtime && set +a
            chmod +x tools/closed_loop_runner.sh
            tools/closed_loop_runner.sh "${CLOSED_LOOP_ACTION}" \
              --compose-file docker-compose.prod.yml \
              --env-file .env.runtime \
              --output-root ./data/reports/closed_loop \
              --stage "${CLOSED_LOOP_STAGE}" \
              --since "${CLOSED_LOOP_SINCE}"
            LATEST="./data/reports/closed_loop/latest/closed_loop_report.json"
            if [[ -f "${LATEST}" ]]; then
              echo "=== closed_loop_report ==="
              cat "${LATEST}"
            else
              echo "missing report: ${LATEST}"
              exit 1
            fi

      - name: Download Closed Loop Reports
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .artifacts
          umask 077
          cat > .artifacts/ecs_key <<'EOF'
          ${{ secrets.ECS_SSH_KEY }}
          EOF
          sed -i 's/\r$//' .artifacts/ecs_key
          chmod 600 .artifacts/ecs_key
          if ! ssh-keygen -y -f .artifacts/ecs_key >/dev/null 2>&1; then
            echo "[closed-loop] invalid ECS_SSH_KEY format after normalization, skip artifact download"
            rm -f .artifacts/ecs_key
            cat > .artifacts/closed_loop_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "invalid_ssh_key_format"
          }
          EOF
            exit 0
          fi
          PORT="${{ secrets.ECS_PORT || 22 }}"
          HOST="${{ secrets.ECS_HOST }}"
          USER="${{ secrets.ECS_USER }}"
          EXPECTED_FINGERPRINT_SECRET="${{ secrets.ECS_HOST_FINGERPRINT }}"
          EXPECTED_FINGERPRINT_VAR="${{ vars.ECS_HOST_FINGERPRINT }}"
          EXPECTED_FINGERPRINT="${EXPECTED_FINGERPRINT_SECRET:-${EXPECTED_FINGERPRINT_VAR}}"
          if [[ -z "${HOST}" || -z "${USER}" ]]; then
            echo "[closed-loop] ECS_HOST/ECS_USER missing, skip artifact download"
            rm -f .artifacts/ecs_key
            cat > .artifacts/closed_loop_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "missing_host_or_user"
          }
          EOF
            exit 0
          fi
          KNOWN_HOSTS_FILE=".artifacts/known_hosts"
          if ! ssh-keyscan -p "${PORT}" -t ed25519,ecdsa,rsa "${HOST}" > "${KNOWN_HOSTS_FILE}" 2>/dev/null; then
            echo "[closed-loop] failed to fetch host key via ssh-keyscan, skip artifact download"
            rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
            cat > .artifacts/closed_loop_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "ssh_keyscan_failed"
          }
          EOF
            exit 0
          fi
          if [[ ! -s "${KNOWN_HOSTS_FILE}" ]]; then
            echo "[closed-loop] ssh-keyscan returned empty host keys, skip artifact download"
            rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
            cat > .artifacts/closed_loop_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "ssh_keyscan_empty"
          }
          EOF
            exit 0
          fi
          if [[ -n "${EXPECTED_FINGERPRINT}" ]]; then
            if ! ssh-keygen -lf "${KNOWN_HOSTS_FILE}" | awk '{print $2}' | grep -Fxq "${EXPECTED_FINGERPRINT}"; then
              echo "[closed-loop] host fingerprint mismatch, skip artifact download"
              rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"
              cat > .artifacts/closed_loop_download_status.json <<'EOF'
          {
            "status": "SKIPPED",
            "reason": "host_fingerprint_mismatch"
          }
          EOF
              exit 0
            fi
          fi

          downloaded=0
          missing=()
          invalid=()
          validate_json_file() {
            local path="$1"
            if [[ ! -s "${path}" ]]; then
              return 1
            fi
            if command -v jq >/dev/null 2>&1; then
              jq -e . "${path}" >/dev/null 2>&1
            else
              python3 -m json.tool "${path}" >/dev/null 2>&1
            fi
          }
          fetch_report() {
            local remote_path="$1"
            local local_path="$2"
            local label="$3"
            local kind="${4:-json}"
            local tmp_path="${local_path}.tmp"
            rm -f "${tmp_path}" "${local_path}"
            if scp -i .artifacts/ecs_key -P "${PORT}" \
              -o UserKnownHostsFile="${KNOWN_HOSTS_FILE}" \
              -o StrictHostKeyChecking=yes \
              "${USER}@${HOST}:${remote_path}" "${tmp_path}"; then
              if [[ "${kind}" == "json" ]]; then
                if ! validate_json_file "${tmp_path}"; then
                  echo "[closed-loop] invalid ${label}: downloaded but JSON is malformed/empty"
                  invalid+=("${label}")
                  rm -f "${tmp_path}" "${local_path}"
                  return
                fi
              fi
              mv -f "${tmp_path}" "${local_path}"
              echo "[closed-loop] downloaded ${label}: ${remote_path}"
              downloaded=$((downloaded + 1))
            else
              echo "[closed-loop] missing or inaccessible ${label}: ${remote_path}"
              missing+=("${label}")
              rm -f "${tmp_path}" "${local_path}"
            fi
          }

          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest/closed_loop_report.json" ".artifacts/closed_loop_report.json" "closed_loop_report" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest/runtime_assess.json" ".artifacts/runtime_assess.json" "runtime_assess" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest/runtime.log" ".artifacts/runtime.log" "runtime_log" "text"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_run_meta.json" ".artifacts/latest_run_meta.json" "latest_run_meta" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_daily_summary.json" ".artifacts/daily_summary.json" "daily_summary" "json"
          fetch_report "/opt/ai-trade/data/reports/closed_loop/latest_weekly_summary.json" ".artifacts/weekly_summary.json" "weekly_summary" "json"

          {
            echo "{"
            echo "  \"status\": \"DONE\","
            echo "  \"downloaded_count\": ${downloaded},"
            echo "  \"invalid_count\": ${#invalid[@]},"
            echo "  \"missing\": ["
            for i in "${!missing[@]}"; do
              sep=","
              if [[ "${i}" -eq $((${#missing[@]} - 1)) ]]; then
                sep=""
              fi
              echo "    \"${missing[$i]}\"${sep}"
            done
            echo "  ],"
            echo "  \"invalid\": ["
            for i in "${!invalid[@]}"; do
              sep=","
              if [[ "${i}" -eq $((${#invalid[@]} - 1)) ]]; then
                sep=""
              fi
              echo "    \"${invalid[$i]}\"${sep}"
            done
            echo "  ]"
            echo "}"
          } > .artifacts/closed_loop_download_status.json

          echo "[closed-loop] downloaded_count=${downloaded} missing_count=${#missing[@]} invalid_count=${#invalid[@]}"
          rm -f .artifacts/ecs_key "${KNOWN_HOSTS_FILE}"

      - name: Upload Closed Loop Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: closed-loop-report-${{ github.run_id }}-${{ github.run_attempt }}
          path: |
            .artifacts/*.json
            .artifacts/runtime.log
          include-hidden-files: true
          if-no-files-found: warn
